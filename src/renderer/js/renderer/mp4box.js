/**
 * Bundled by jsDelivr using Rollup v2.79.2 and Terser v5.39.0.
 * Original file: /npm/mp4box@2.1.2/dist/mp4box.all.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
var t=Object.defineProperty,e=(e,s)=>{for(var i in s)t(e,i,{get:s[i],enumerable:!0})},s=Math.pow(2,32),i=Math.pow(2,32)-1,r=131072,a=256,n=512,o=1024,h=2048,d=class t extends ArrayBuffer{constructor(t){super(t),this.fileStart=0,this.usedBytes=0}static fromArrayBuffer(e,s){const i=new t(e.byteLength);return new Uint8Array(i).set(new Uint8Array(e)),i.fileStart=s,i}},c=(t=>(t[t.BIG_ENDIAN=1]="BIG_ENDIAN",t[t.LITTLE_ENDIAN=2]="LITTLE_ENDIAN",t))(c||{}),l=class t{constructor(t,e,s){this._byteLength=0,this.failurePosition=0,this._dynamicSize=1,this._byteOffset=e||0,t instanceof ArrayBuffer?this.buffer=d.fromArrayBuffer(t,0):t instanceof DataView?(this.dataView=t,e&&(this._byteOffset+=e)):this.buffer=new d(t||0),this.position=0,this.endianness=s||1}static{this.ENDIANNESS=new Int8Array(new Int16Array([1]).buffer)[0]>0?2:1}getPosition(){return this.position}_realloc(t){if(!this._dynamicSize)return;const e=this._byteOffset+this.position+t;let s=this._buffer.byteLength;if(e<=s)return void(e>this._byteLength&&(this._byteLength=e));for(s<1&&(s=1);e>s;)s*=2;const i=new d(s),r=new Uint8Array(this._buffer);new Uint8Array(i,0,r.length).set(r),this.buffer=i,this._byteLength=e}_trimAlloc(){if(this._byteLength===this._buffer.byteLength)return;const t=new d(this._byteLength),e=new Uint8Array(t),s=new Uint8Array(this._buffer,0,e.length);e.set(s),this.buffer=t}get byteLength(){return this._byteLength-this._byteOffset}get buffer(){return this._trimAlloc(),this._buffer}set buffer(t){this._buffer=t,this._dataView=new DataView(t,this._byteOffset),this._byteLength=t.byteLength}get byteOffset(){return this._byteOffset}set byteOffset(t){this._byteOffset=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}get dataView(){return this._dataView}set dataView(t){this._byteOffset=t.byteOffset,this._buffer=d.fromArrayBuffer(t.buffer,0),this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._byteOffset+t.byteLength}seek(t){const e=Math.max(0,Math.min(this.byteLength,t));this.position=isNaN(e)||!isFinite(e)?0:e}isEof(){return this.position>=this._byteLength}#t(t){return Array.isArray(t)&&3===t.length&&"[]"===t[0]}mapUint8Array(t){this._realloc(1*t);const e=new Uint8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=1*t,e}readInt32Array(e,s){e=void 0===e?this.byteLength-this.position/4:e;const i=new Int32Array(e);return t.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,e*i.BYTES_PER_ELEMENT),t.arrayToNative(i,s??this.endianness),this.position+=i.byteLength,i}readInt16Array(e,s){e=void 0===e?this.byteLength-this.position/2:e;const i=new Int16Array(e);return t.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,e*i.BYTES_PER_ELEMENT),t.arrayToNative(i,s??this.endianness),this.position+=i.byteLength,i}readInt8Array(e){e=void 0===e?this.byteLength-this.position:e;const s=new Int8Array(e);return t.memcpy(s.buffer,0,this.buffer,this.byteOffset+this.position,e*s.BYTES_PER_ELEMENT),this.position+=s.byteLength,s}readUint32Array(e,s){e=void 0===e?this.byteLength-this.position/4:e;const i=new Uint32Array(e);return t.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,e*i.BYTES_PER_ELEMENT),t.arrayToNative(i,s??this.endianness),this.position+=i.byteLength,i}readUint16Array(e,s){e=void 0===e?this.byteLength-this.position/2:e;const i=new Uint16Array(e);return t.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,e*i.BYTES_PER_ELEMENT),t.arrayToNative(i,s??this.endianness),this.position+=i.byteLength,i}readUint8Array(e){e=void 0===e?this.byteLength-this.position:e;const s=new Uint8Array(e);return t.memcpy(s.buffer,0,this.buffer,this.byteOffset+this.position,e*s.BYTES_PER_ELEMENT),this.position+=s.byteLength,s}readFloat64Array(e,s){e=void 0===e?this.byteLength-this.position/8:e;const i=new Float64Array(e);return t.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,e*i.BYTES_PER_ELEMENT),t.arrayToNative(i,s??this.endianness),this.position+=i.byteLength,i}readFloat32Array(e,s){e=void 0===e?this.byteLength-this.position/4:e;const i=new Float32Array(e);return t.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,e*i.BYTES_PER_ELEMENT),t.arrayToNative(i,s??this.endianness),this.position+=i.byteLength,i}readInt32(t){const e=this._dataView.getInt32(this.position,2===(t??this.endianness));return this.position+=4,e}readInt16(t){const e=this._dataView.getInt16(this.position,2===(t??this.endianness));return this.position+=2,e}readInt8(){const t=this._dataView.getInt8(this.position);return this.position+=1,t}readUint32(t){const e=this._dataView.getUint32(this.position,2===(t??this.endianness));return this.position+=4,e}readUint16(t){const e=this._dataView.getUint16(this.position,2===(t??this.endianness));return this.position+=2,e}readUint8(){const t=this._dataView.getUint8(this.position);return this.position+=1,t}readFloat32(t){const e=this._dataView.getFloat32(this.position,2===(t??this.endianness));return this.position+=4,e}readFloat64(t){const e=this._dataView.getFloat64(this.position,2===(t??this.endianness));return this.position+=8,e}static memcpy(t,e,s,i,r){const a=new Uint8Array(t,e,r),n=new Uint8Array(s,i,r);a.set(n)}static arrayToNative(e,s){return s===t.ENDIANNESS?e:this.flipArrayEndianness(e)}static nativeToEndian(e,s){return s&&2===t.ENDIANNESS?e:this.flipArrayEndianness(e)}static flipArrayEndianness(t){const e=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);for(let s=0;s<t.byteLength;s+=t.BYTES_PER_ELEMENT)for(let i=s+t.BYTES_PER_ELEMENT-1,r=s;i>r;i--,r++){const t=e[r];e[r]=e[i],e[i]=t}return t}readString(t,e){return void 0===e||"ASCII"===e?p(this.mapUint8Array(void 0===t?this.byteLength-this.position:t)):new TextDecoder(e).decode(this.mapUint8Array(t))}readCString(t){let e=0;const s=this.byteLength-this.position,i=new Uint8Array(this._buffer,this._byteOffset+this.position),r=void 0!==t?Math.min(t,s):s;for(;e<r&&0!==i[e];e++);const a=p(this.mapUint8Array(e));return void 0!==t?this.position+=r-e:e!==s&&(this.position+=1),a}readInt64(){return this.readInt32()*s+this.readUint32()}readUint64(){return this.readUint32()*s+this.readUint32()}readUint24(){return(this.readUint8()<<16)+(this.readUint8()<<8)+this.readUint8()}save(t){const e=new Blob([this.buffer]);if("undefined"!=typeof window&&"undefined"!=typeof document){if(!window.URL||!URL.createObjectURL)throw new Error("DataStream.save: Can't create object URL.");{const s=window.URL.createObjectURL(e),i=document.createElement("a");document.body.appendChild(i),i.setAttribute("href",s),i.setAttribute("download",t),i.setAttribute("target","_self"),i.click(),window.URL.revokeObjectURL(s),document.body.removeChild(i)}}return e}get dynamicSize(){return this._dynamicSize}set dynamicSize(t){t||this._trimAlloc(),this._dynamicSize=t}shift(t){const e=new d(this._byteLength-t),s=new Uint8Array(e),i=new Uint8Array(this._buffer,t,s.length);s.set(i),this.buffer=e,this.position-=t}writeInt32Array(e,s){if(this._realloc(4*e.length),e instanceof Int32Array&&this.byteOffset+this.position%e.BYTES_PER_ELEMENT===0)t.memcpy(this._buffer,this.byteOffset+this.position,e.buffer,0,e.byteLength),this.mapInt32Array(e.length,s);else for(let t=0;t<e.length;t++)this.writeInt32(e[t],s)}writeInt16Array(e,s){if(this._realloc(2*e.length),e instanceof Int16Array&&this.byteOffset+this.position%e.BYTES_PER_ELEMENT===0)t.memcpy(this._buffer,this.byteOffset+this.position,e.buffer,0,e.byteLength),this.mapInt16Array(e.length,s);else for(let t=0;t<e.length;t++)this.writeInt16(e[t],s)}writeInt8Array(e){if(this._realloc(1*e.length),e instanceof Int8Array&&this.byteOffset+this.position%e.BYTES_PER_ELEMENT===0)t.memcpy(this._buffer,this.byteOffset+this.position,e.buffer,0,e.byteLength),this.mapInt8Array(e.length);else for(let t=0;t<e.length;t++)this.writeInt8(e[t])}writeUint32Array(e,s){if(this._realloc(4*e.length),e instanceof Uint32Array&&this.byteOffset+this.position%e.BYTES_PER_ELEMENT===0)t.memcpy(this._buffer,this.byteOffset+this.position,e.buffer,0,e.byteLength),this.mapUint32Array(e.length,s);else for(let t=0;t<e.length;t++)this.writeUint32(e[t],s)}writeUint16Array(e,s){if(this._realloc(2*e.length),e instanceof Uint16Array&&this.byteOffset+this.position%e.BYTES_PER_ELEMENT===0)t.memcpy(this._buffer,this.byteOffset+this.position,e.buffer,0,e.byteLength),this.mapUint16Array(e.length,s);else for(let t=0;t<e.length;t++)this.writeUint16(e[t],s)}writeUint8Array(e){if(this._realloc(1*e.length),e instanceof Uint8Array&&this.byteOffset+this.position%e.BYTES_PER_ELEMENT===0)t.memcpy(this._buffer,this.byteOffset+this.position,e.buffer,0,e.byteLength),this.mapUint8Array(e.length);else for(let t=0;t<e.length;t++)this.writeUint8(e[t])}writeFloat64Array(e,s){if(this._realloc(8*e.length),e instanceof Float64Array&&this.byteOffset+this.position%e.BYTES_PER_ELEMENT===0)t.memcpy(this._buffer,this.byteOffset+this.position,e.buffer,0,e.byteLength),this.mapFloat64Array(e.length,s);else for(let t=0;t<e.length;t++)this.writeFloat64(e[t],s)}writeFloat32Array(e,s){if(this._realloc(4*e.length),e instanceof Float32Array&&this.byteOffset+this.position%e.BYTES_PER_ELEMENT===0)t.memcpy(this._buffer,this.byteOffset+this.position,e.buffer,0,e.byteLength),this.mapFloat32Array(e.length,s);else for(let t=0;t<e.length;t++)this.writeFloat32(e[t],s)}writeInt64(t,e){this._realloc(8),this._dataView.setBigInt64(this.position,BigInt(t),2===(e??this.endianness)),this.position+=8}writeInt32(t,e){this._realloc(4),this._dataView.setInt32(this.position,t,2===(e??this.endianness)),this.position+=4}writeInt16(t,e){this._realloc(2),this._dataView.setInt16(this.position,t,2===(e??this.endianness)),this.position+=2}writeInt8(t){this._realloc(1),this._dataView.setInt8(this.position,t),this.position+=1}writeUint32(t,e){this._realloc(4),this._dataView.setUint32(this.position,t,2===(e??this.endianness)),this.position+=4}writeUint16(t,e){this._realloc(2),this._dataView.setUint16(this.position,t,2===(e??this.endianness)),this.position+=2}writeUint8(t){this._realloc(1),this._dataView.setUint8(this.position,t),this.position+=1}writeFloat32(t,e){this._realloc(4),this._dataView.setFloat32(this.position,t,2===(e??this.endianness)),this.position+=4}writeFloat64(t,e){this._realloc(8),this._dataView.setFloat64(this.position,t,2===(e??this.endianness)),this.position+=8}writeUCS2String(t,e,s){let i;for(void 0===s&&(s=t.length),i=0;i<t.length&&i<s;i++)this.writeUint16(t.charCodeAt(i),e);for(;i<s;i++)this.writeUint16(0)}writeString(t,e,s){let i=0;if(void 0===e||"ASCII"===e)if(void 0!==s){const e=Math.min(t.length,s);for(i=0;i<e;i++)this.writeUint8(t.charCodeAt(i));for(;i<s;i++)this.writeUint8(0)}else for(i=0;i<t.length;i++)this.writeUint8(t.charCodeAt(i));else this.writeUint8Array(new TextEncoder(e).encode(t.substring(0,s)))}writeCString(t,e){let s=0;if(void 0!==e){const i=Math.min(t.length,e);for(s=0;s<i;s++)this.writeUint8(t.charCodeAt(s));for(;s<e;s++)this.writeUint8(0)}else{for(s=0;s<t.length;s++)this.writeUint8(t.charCodeAt(s));this.writeUint8(0)}}writeStruct(t,e){for(let s=0;s<t.length;s++){const[i,r]=t[s],a=e[i];this.writeType(r,a,e)}}writeType(t,e,s){if("function"==typeof t)return t(this,e);if("object"==typeof t&&!(t instanceof Array))return t.set(this,e,s);let i,r="ASCII";const a=this.position;let n=t;if("string"==typeof t&&/:/.test(t)){const e=t.split(":");n=e[0],i=parseInt(e[1])}if("string"==typeof n&&/,/.test(n)){const t=n.split(",");n=t[0],r=t[1]}switch(n){case"uint8":this.writeUint8(e);break;case"int8":this.writeInt8(e);break;case"uint16":this.writeUint16(e,this.endianness);break;case"int16":this.writeInt16(e,this.endianness);break;case"uint32":this.writeUint32(e,this.endianness);break;case"int32":this.writeInt32(e,this.endianness);break;case"float32":this.writeFloat32(e,this.endianness);break;case"float64":this.writeFloat64(e,this.endianness);break;case"uint16be":this.writeUint16(e,1);break;case"int16be":this.writeInt16(e,1);break;case"uint32be":this.writeUint32(e,1);break;case"int32be":this.writeInt32(e,1);break;case"float32be":this.writeFloat32(e,1);break;case"float64be":this.writeFloat64(e,1);break;case"uint16le":this.writeUint16(e,2);break;case"int16le":this.writeInt16(e,2);break;case"uint32le":this.writeUint32(e,2);break;case"int32le":this.writeInt32(e,2);break;case"float32le":this.writeFloat32(e,2);break;case"float64le":this.writeFloat64(e,2);break;case"cstring":this.writeCString(e,i);break;case"string":this.writeString(e,r,i);break;case"u16string":this.writeUCS2String(e,this.endianness,i);break;case"u16stringle":this.writeUCS2String(e,2,i);break;case"u16stringbe":this.writeUCS2String(e,1,i);break;default:if(this.#t(n)){const[,t]=n;for(let s=0;s<e.length;s++)this.writeType(t,e[s]);break}this.writeStruct(n,e)}i&&(this.position=a,this._realloc(i),this.position=a+i)}writeUint64(t){const e=Math.floor(t/s);this.writeUint32(e),this.writeUint32(4294967295&t)}writeUint24(t){this.writeUint8((16711680&t)>>16),this.writeUint8((65280&t)>>8),this.writeUint8(255&t)}adjustUint32(t,e){const s=this.position;this.seek(t),this.writeUint32(e),this.seek(s)}readStruct(t){const e={},s=this.position;for(let i=0;i<t.length;i+=1){const r=t[i][1],a=this.readType(r,e);if(!a)return 0===this.failurePosition&&(this.failurePosition=this.position),void(this.position=s);e[t[i][0]]=a}return e}readUCS2String(t,e){return String.fromCharCode.apply(void 0,this.readUint16Array(t,e))}readType(t,e){if("function"==typeof t)return t(this,e);if("object"==typeof t&&!(t instanceof Array))return t.get(this,e);if(t instanceof Array&&3!==t.length)return this.readStruct(t);let s,i,r="ASCII";const a=this.position;let n=t;if("string"==typeof n&&/:/.test(n)){const t=n.split(":");n=t[0],i=parseInt(t[1])}if("string"==typeof n&&/,/.test(n)){const t=n.split(",");n=t[0],r=t[1]}switch(n){case"uint8":s=this.readUint8();break;case"int8":s=this.readInt8();break;case"uint16":s=this.readUint16(this.endianness);break;case"int16":s=this.readInt16(this.endianness);break;case"uint32":s=this.readUint32(this.endianness);break;case"int32":s=this.readInt32(this.endianness);break;case"float32":s=this.readFloat32(this.endianness);break;case"float64":s=this.readFloat64(this.endianness);break;case"uint16be":s=this.readUint16(1);break;case"int16be":s=this.readInt16(1);break;case"uint32be":s=this.readUint32(1);break;case"int32be":s=this.readInt32(1);break;case"float32be":s=this.readFloat32(1);break;case"float64be":s=this.readFloat64(1);break;case"uint16le":s=this.readUint16(2);break;case"int16le":s=this.readInt16(2);break;case"uint32le":s=this.readUint32(2);break;case"int32le":s=this.readInt32(2);break;case"float32le":s=this.readFloat32(2);break;case"float64le":s=this.readFloat64(2);break;case"cstring":s=this.readCString(i);break;case"string":s=this.readString(i,r);break;case"u16string":s=this.readUCS2String(i,this.endianness);break;case"u16stringle":s=this.readUCS2String(i,2);break;case"u16stringbe":s=this.readUCS2String(i,1);break;default:if(this.#t(n)){const[,t,i]=n,r="function"==typeof i?i(e,this,n):"string"==typeof i&&void 0!==e[i]?parseInt(e[i]):"number"==typeof i?i:"*"===i?void 0:parseInt(i);if("string"==typeof t){const i=t.replace(/(le|be)$/,"");let a;switch(/le$/.test(t)?a=2:/be$/.test(t)&&(a=1),i){case"uint8":s=this.readUint8Array(r);break;case"uint16":s=this.readUint16Array(r,a);break;case"uint32":s=this.readUint32Array(r,a);break;case"int8":s=this.readInt8Array(r);break;case"int16":s=this.readInt16Array(r,a);break;case"int32":s=this.readInt32Array(r,a);break;case"float32":s=this.readFloat32Array(r,a);break;case"float64":s=this.readFloat64Array(r,a);break;case"cstring":case"utf16string":case"string":if(r){s=new Array(r);for(let i=0;i<r;i++)s[i]=this.readType(t,e)}else for(s=[];!this.isEof();){const i=this.readType(t,e);if(!i)break;s.push(i)}}}else if(r){s=new Array(r);for(let i=0;i<r;i++){const r=this.readType(t,e);if(!r)return;s[i]=r}}else for(s=[];;){const i=this.position;try{const r=this.readType(t,e);if(!r){this.position=i;break}s.push(r)}catch{this.position=i;break}}break}}return i&&(this.position=a+i),s}mapInt32Array(e,s){this._realloc(4*e);const i=new Int32Array(this._buffer,this.byteOffset+this.position,e);return t.arrayToNative(i,s??this.endianness),this.position+=4*e,i}mapInt16Array(e,s){this._realloc(2*e);const i=new Int16Array(this._buffer,this.byteOffset+this.position,e);return t.arrayToNative(i,s??this.endianness),this.position+=2*e,i}mapInt8Array(t,e){this._realloc(1*t);const s=new Int8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=1*t,s}mapUint32Array(e,s){this._realloc(4*e);const i=new Uint32Array(this._buffer,this.byteOffset+this.position,e);return t.arrayToNative(i,s??this.endianness),this.position+=4*e,i}mapUint16Array(e,s){this._realloc(2*e);const i=new Uint16Array(this._buffer,this.byteOffset+this.position,e);return t.arrayToNative(i,s??this.endianness),this.position+=2*e,i}mapFloat64Array(e,s){this._realloc(8*e);const i=new Float64Array(this._buffer,this.byteOffset+this.position,e);return t.arrayToNative(i,s??this.endianness),this.position+=8*e,i}mapFloat32Array(e,s){this._realloc(4*e);const i=new Float32Array(this._buffer,this.byteOffset+this.position,e);return t.arrayToNative(i,s??this.endianness),this.position+=4*e,i}};function p(t){const e=[];for(let s=0;s<t.length;s++)e[s]=t[s];return String.fromCharCode.apply(void 0,e)}var u=new Date,f=4,m={setLogLevel(t){f=t===this.debug?1:t===this.info?2:t===this.warn?3:(this.error,4)},debug(t,e){void 0===console.debug&&(console.debug=console.log),1>=f&&console.debug("["+m.getDurationString((new Date).getTime()-u.getTime(),1e3)+"]","["+t+"]",e)},log(t,e){this.debug(t.msg)},info(t,e){2>=f&&console.info("["+m.getDurationString((new Date).getTime()-u.getTime(),1e3)+"]","["+t+"]",e)},warn(t,e){3>=f&&console.warn("["+m.getDurationString((new Date).getTime()-u.getTime(),1e3)+"]","["+t+"]",e)},error(t,e,s){s?.onError?s.onError(t,e):4>=f&&console.error("["+m.getDurationString((new Date).getTime()-u.getTime(),1e3)+"]","["+t+"]",e)},getDurationString(t,e){let s;function i(t,e){const s=(""+t).split(".");for(;s[0].length<e;)s[0]="0"+s[0];return s.join(".")}t<0?(s=!0,t=-t):s=!1;let r=t/(e||1);const a=Math.floor(r/3600);r-=3600*a;const n=Math.floor(r/60);r-=60*n;let o=1e3*r;return r=Math.floor(r),o-=1e3*r,o=Math.floor(o),(s?"-":"")+a+":"+i(n,2)+":"+i(r,2)+"."+i(o,3)},printRanges(t){const e=t.length;if(e>0){let s="";for(let i=0;i<e;i++)i>0&&(s+=","),s+="["+m.getDurationString(t.start(i))+","+m.getDurationString(t.end(i))+"]";return s}return"(empty)"}};var _=class extends l{constructor(t){super(new ArrayBuffer,0),this.buffers=[],this.bufferIndex=-1,t&&(this.insertBuffer(t),this.bufferIndex=0)}initialized(){if(this.bufferIndex>-1)return!0;if(this.buffers.length>0){const t=this.buffers[0];return 0===t.fileStart?(this.buffer=t,this.bufferIndex=0,m.debug("MultiBufferStream","Stream ready for parsing"),!0):(m.warn("MultiBufferStream","The first buffer should have a fileStart of 0"),this.logBufferLevel(),!1)}return m.warn("MultiBufferStream","No buffer to start parsing from"),this.logBufferLevel(),!1}reduceBuffer(t,e,s){const i=new Uint8Array(s);return i.set(new Uint8Array(t,e,s)),i.buffer.fileStart=t.fileStart+e,i.buffer.usedBytes=0,i.buffer}insertBuffer(t){let e=!0,s=0;for(;s<this.buffers.length;s++){const i=this.buffers[s];if(t.fileStart<=i.fileStart){if(t.fileStart===i.fileStart){if(t.byteLength>i.byteLength){this.buffers.splice(s,1),s--;continue}m.warn("MultiBufferStream","Buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+") already appended, ignoring")}else t.fileStart+t.byteLength<=i.fileStart||(t=this.reduceBuffer(t,0,i.fileStart-t.fileStart)),m.debug("MultiBufferStream","Appending new buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+")"),this.buffers.splice(s,0,t),0===s&&(this.buffer=t);e=!1;break}if(t.fileStart<i.fileStart+i.byteLength){const s=i.fileStart+i.byteLength-t.fileStart,r=t.byteLength-s;if(!(r>0)){e=!1;break}t=this.reduceBuffer(t,s,r)}}e&&(m.debug("MultiBufferStream","Appending new buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+")"),this.buffers.push(t),0===s&&(this.buffer=t))}logBufferLevel(t){const e=[];let s,i="",r=0,a=0;for(let t=0;t<this.buffers.length;t++){const n=this.buffers[t];0===t?(s={start:n.fileStart,end:n.fileStart+n.byteLength},e.push(s),i+="["+s.start+"-"):s.end===n.fileStart?s.end=n.fileStart+n.byteLength:(s={start:n.fileStart,end:n.fileStart+n.byteLength},i+=e[e.length-1].end-1+"], ["+s.start+"-",e.push(s)),r+=n.usedBytes,a+=n.byteLength}e.length>0&&(i+=s.end-1+"]");const n=t?m.info:m.debug;0===this.buffers.length?n("MultiBufferStream","No more buffer in memory"):n("MultiBufferStream",this.buffers.length+" stored buffer(s) ("+r+"/"+a+" bytes), continuous ranges: "+i)}cleanBuffers(){for(let t=0;t<this.buffers.length;t++){const e=this.buffers[t];e.usedBytes===e.byteLength&&(m.debug("MultiBufferStream","Removing buffer #"+t),this.buffers.splice(t,1),t--)}}mergeNextBuffer(){if(this.bufferIndex+1<this.buffers.length){const t=this.buffers[this.bufferIndex+1];if(t.fileStart===this.buffer.fileStart+this.buffer.byteLength){const e=this.buffer.byteLength,s=this.buffer.usedBytes,i=this.buffer.fileStart;return this.buffers[this.bufferIndex]=function(t,e){m.debug("ArrayBuffer","Trying to create a new buffer of size: "+(t.byteLength+e.byteLength));const s=new Uint8Array(t.byteLength+e.byteLength);return s.set(new Uint8Array(t),0),s.set(new Uint8Array(e),t.byteLength),s.buffer}(this.buffer,t),this.buffer=this.buffers[this.bufferIndex],this.buffers.splice(this.bufferIndex+1,1),this.buffer.usedBytes=s,this.buffer.fileStart=i,m.debug("ISOFile","Concatenating buffer for box parsing (length: "+e+"->"+this.buffer.byteLength+")"),!0}return!1}return!1}findPosition(t,e,s){let i=-1,r=!0===t?0:this.bufferIndex;for(;r<this.buffers.length;){const t=this.buffers[r];if(!(t&&t.fileStart<=e))break;i=r,s&&(t.fileStart+t.byteLength<=e?t.usedBytes=t.byteLength:t.usedBytes=e-t.fileStart,this.logBufferLevel()),r++}if(-1===i)return-1;const a=this.buffers[i];return a.fileStart+a.byteLength>=e?(m.debug("MultiBufferStream","Found position in existing buffer #"+i),i):-1}findEndContiguousBuf(t){const e=void 0!==t?t:this.bufferIndex;let s=this.buffers[e];if(this.buffers.length>e+1)for(let t=e+1;t<this.buffers.length;t++){const e=this.buffers[t];if(e.fileStart!==s.fileStart+s.byteLength)break;s=e}return s.fileStart+s.byteLength}getEndFilePositionAfter(t){const e=this.findPosition(!0,t,!1);return-1!==e?this.findEndContiguousBuf(e):t}addUsedBytes(t){this.buffer.usedBytes+=t,this.logBufferLevel()}setAllUsedBytes(){this.buffer.usedBytes=this.buffer.byteLength,this.logBufferLevel()}seek(t,e,s){const i=this.findPosition(e,t,s);return-1!==i?(this.buffer=this.buffers[i],this.bufferIndex=i,this.position=t-this.buffer.fileStart,m.debug("MultiBufferStream","Repositioning parser at buffer position: "+this.position),!0):(m.debug("MultiBufferStream","Position "+t+" not found in buffered data"),!1)}getPosition(){return-1===this.bufferIndex||void 0===this.buffers[this.bufferIndex]?0:this.buffers[this.bufferIndex].fileStart+this.position}getLength(){return this.byteLength}getEndPosition(){return-1===this.bufferIndex||void 0===this.buffers[this.bufferIndex]?0:this.buffers[this.bufferIndex].fileStart+this.byteLength}getAbsoluteEndPosition(){if(0===this.buffers.length)return 0;const t=this.buffers[this.buffers.length-1];return t.fileStart+t.byteLength}},g=class{constructor(t=0){this.size=t}static{this.registryId=Symbol.for("BoxIdentifier")}#e;get type(){return this.constructor.fourcc??this.#e}set type(t){this.#e=t}addBox(t){return this.boxes||(this.boxes=[]),this.boxes.push(t),this[t.type+"s"]?this[t.type+"s"].push(t):this[t.type]=t,t}set(t,e){return this[t]=e,this}addEntry(t,e){const s=e||"entries";return this[s]||(this[s]=[]),this[s].push(t),this}writeHeader(t,e){if(this.size+=8,(this.size>i||1===this.original_size)&&(this.size+=8),"uuid"===this.type&&(this.size+=16),m.debug("BoxWriter","Writing box "+this.type+" of size: "+this.size+" at position "+t.getPosition()+(e||"")),0===this.original_size?t.writeUint32(0):this.size>i||1===this.original_size?t.writeUint32(1):(this.sizePosition=t.getPosition(),t.writeUint32(this.size)),t.writeString(this.type,void 0,4),"uuid"===this.type){const e=new Uint8Array(16);for(let t=0;t<16;t++)e[t]=parseInt(this.uuid.substring(2*t,2*t+2),16);t.writeUint8Array(e)}(this.size>i||1===this.original_size)&&(this.sizePosition=t.getPosition(),t.writeUint64(this.size))}write(t){if("mdat"===this.type){const e=this;if(e.stream){this.size=e.stream.getAbsoluteEndPosition(),this.writeHeader(t);for(const s of e.stream.buffers){const e=new Uint8Array(s);t.writeUint8Array(e)}}else e.data&&(this.size=e.data.length,this.writeHeader(t),t.writeUint8Array(e.data))}else this.size=this.data?this.data.length:0,this.writeHeader(t),this.data&&t.writeUint8Array(this.data)}printHeader(t){this.size+=8,this.size>i&&(this.size+=8),"uuid"===this.type&&(this.size+=16),t.log(t.indent+"size:"+this.size),t.log(t.indent+"type:"+this.type)}print(t){this.printHeader(t)}parse(t){"mdat"!==this.type?this.data=t.readUint8Array(this.size-this.hdr_size):0===this.size?t.seek(t.getEndPosition()):t.seek(this.start+this.size)}parseDataAndRewind(t){this.data=t.readUint8Array(this.size-this.hdr_size),t.seek(this.start+this.hdr_size)}parseLanguage(t){this.language=t.readUint16();const e=[];e[0]=this.language>>10&31,e[1]=this.language>>5&31,e[2]=31&this.language,this.languageString=String.fromCharCode(e[0]+96,e[1]+96,e[2]+96)}computeSize(t){const e=t||new _;this.write(e)}isEndOfBox(t){return t.getPosition()===this.start+this.size}},x=class extends g{constructor(){super(...arguments),this.flags=0,this.version=0}writeHeader(t){this.size+=4,super.writeHeader(t," v="+this.version+" f="+this.flags),t.writeUint8(this.version),t.writeUint24(this.flags)}printHeader(t){this.size+=4,super.printHeader(t),t.log(t.indent+"version:"+this.version),t.log(t.indent+"flags:"+this.flags)}parseDataAndRewind(t){this.parseFullHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size),this.hdr_size-=4,t.seek(this.start+this.hdr_size)}parseFullHeader(t){this.version=t.readUint8(),this.flags=t.readUint24(),this.hdr_size+=4}parse(t){this.parseFullHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size)}},b=class{constructor(t){this.grouping_type=t}static{this.registryId=Symbol.for("SampleGroupEntryIdentifier")}write(t){t.writeUint8Array(this.data)}parse(t){m.warn("BoxParser",`Unknown sample group type: '${this.grouping_type}'`),this.data=t.readUint8Array(this.description_length)}},y=class extends x{parse(t){this.parseFullHeader(t),this.track_group_id=t.readUint32()}},U=class extends g{constructor(t,e,s,i,r){super(e),this.box_name=s,this.hdr_size=i,this.start=r,this.type=t}parse(t){this.from_item_ID=t.readUint16();const e=t.readUint16();this.references=[];for(let s=0;s<e;s++)this.references[s]={to_item_ID:t.readUint16()}}},w=class extends g{constructor(t,e,s,i,r){super(e),this.box_name=s,this.hdr_size=i,this.start=r,this.type=t}parse(t){this.from_item_ID=t.readUint32();const e=t.readUint16();this.references=[];for(let s=0;s<e;s++)this.references[s]={to_item_ID:t.readUint32()}}},S=class extends g{constructor(t,e,s,i){super(e),this.hdr_size=s,this.start=i,this.type=t}parse(t){this.track_ids=t.readUint32Array((this.size-this.hdr_size)/4)}write(t){this.size=4*this.track_ids.length,this.writeHeader(t),t.writeUint32Array(this.track_ids)}},v=["boxes","entries","references","subsamples","items","item_infos","extents","associations","subsegments","ranges","seekLists","seekPoints","esd","levels"],B=["compatible_brands","matrix","opcolor","sample_counts","sample_deltas","first_chunk","samples_per_chunk","sample_sizes","chunk_offsets","sample_offsets","sample_description_index","sample_duration"];function z(t,e){if(t&&!e)return!1;let s;for(s in t)if(!v.find((t=>t===s))&&!(t[s]instanceof g||e[s]instanceof g||void 0===t[s]||void 0===e[s]||"function"==typeof t[s]||"function"==typeof e[s]||"subBoxNames"in t&&t.subBoxNames.indexOf(s.slice(0,4))>-1||"subBoxNames"in e&&e.subBoxNames.indexOf(s.slice(0,4))>-1||"data"===s||"start"===s||"size"===s||"creation_time"===s||"modification_time"===s||B.find((t=>t===s))||t[s]===e[s]))return!1;return!0}function k(t,e){if(!z(t,e))return!1;for(let s=0;s<v.length;s++){const i=v[s];if(t[i]&&e[i]&&!k(t[i],e[i]))return!1}return!0}function I(t){let e=t;for(;e;){if("registryId"in e)return e.registryId;e=Object.getPrototypeOf(e)}}var E=t=>{const e=Symbol.for("SampleGroupEntryIdentifier");return I(t)===e},P=t=>{const e=Symbol.for("SampleEntryIdentifier");return I(t)===e},A=t=>{const e=Symbol.for("BoxIdentifier");return I(t)===e},C={uuid:{},sampleEntry:{},sampleGroupEntry:{},box:{}};var T={};function F(t){let e="";for(let s=0;s<16;s++){const s=t.readUint8().toString(16);e+=1===s.length?"0"+s:s}return e}function D(t,e,s){let i,r;const a=t.getPosition();let n,o=0;if(t.getEndPosition()-a<8)return m.debug("BoxParser","Not enough data in stream to parse the type and size of the box"),{code:0};if(s&&s<8)return m.debug("BoxParser","Not enough bytes left in the parent box to parse a new box"),{code:0};let h=t.readUint32();const d=t.readString(4);if(4!==d.length||!/^[\x20-\x7E]{4}$/.test(d))return m.error("BoxParser",`Invalid box type: '${d}'`),{code:-1,start:a,type:d};let c=d;if(m.debug("BoxParser","Found box of type '"+d+"' and size "+h+" at position "+a),o=8,"uuid"===d){if(t.getEndPosition()-t.getPosition()<16||s-o<16)return t.seek(a),m.debug("BoxParser","Not enough bytes left in the parent box to parse a UUID box"),{code:0};n=function(t){return F(t)}(t),o+=16,c=n}if(1===h){if(t.getEndPosition()-t.getPosition()<8||s&&s-o<8)return t.seek(a),m.warn("BoxParser",'Not enough data in stream to parse the extended size of the "'+d+'" box'),{code:0};r=h,h=t.readUint64(),o+=8}else if(0===h)if(s)h=s;else if("mdat"!==d)return m.error("BoxParser","Unlimited box size not supported for type: '"+d+"'"),i=new g(h),i.type=d,{code:1,box:i,size:i.size};if(0!==h&&h<o)return m.error("BoxParser","Box of type "+d+" has an invalid size "+h+" (too small to be a box)"),{code:0,type:d,size:h,hdr_size:o,start:a};if(0!==h&&s&&h>s)return m.error("BoxParser","Box of type '"+d+"' has a size "+h+" greater than its container size "+s),{code:0,type:d,size:h,hdr_size:o,start:a};if(0!==h&&a+h>t.getEndPosition())return t.seek(a),m.info("BoxParser","Not enough data in stream to parse the entire '"+d+"' box"),{code:0,type:d,size:h,hdr_size:o,start:a,original_size:r};if(e)return{code:1,type:d,size:h,hdr_size:o,start:a};d in C.box?i=new C.box[d](h):"uuid"!==d?(m.warn("BoxParser",`Unknown box type: '${d}'`),i=new g(h),i.type=d,i.has_unparsed_data=!0):n in C.uuid?i=new C.uuid[n](h):(m.warn("BoxParser",`Unknown UUID box type: '${n}'`),i=new g(h),i.type=d,i.uuid=n,i.has_unparsed_data=!0),i.original_size=r,i.hdr_size=o,i.start=a,i.write===g.prototype.write&&"mdat"!==i.type&&(m.info("BoxParser","'"+c+"' box writing not yet implemented, keeping unparsed data in memory for later write"),i.parseDataAndRewind(t)),i.parse(t);const l=t.getPosition()-(i.start+i.size);return l<0?(m.warn("BoxParser","Parsing of box '"+c+"' did not read the entire indicated box data size (missing "+-l+" bytes), seeking forward"),t.seek(i.start+i.size)):l>0&&0!==i.size&&(m.error("BoxParser","Parsing of box '"+c+"' read "+l+" more bytes than the indicated box data size, seeking backwards"),t.seek(i.start+i.size)),{code:1,box:i,size:i.size}}var L=class extends g{write(t){if(this.size=0,this.writeHeader(t),this.boxes)for(let e=0;e<this.boxes.length;e++)this.boxes[e]&&(this.boxes[e].write(t),this.size+=this.boxes[e].size);m.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)}print(t){this.printHeader(t);for(let e=0;e<this.boxes.length;e++)if(this.boxes[e]){const s=t.indent;t.indent+=" ",this.boxes[e].print(t),t.indent=s}}parse(t){let e;for(;t.getPosition()<this.start+this.size;){if(e=D(t,!1,this.size-(t.getPosition()-this.start)),1!==e.code)return;{const t=e.box;if(this.boxes||(this.boxes=[]),this.boxes.push(t),this.subBoxNames&&-1!==this.subBoxNames.indexOf(t.type)){const e=this.subBoxNames[this.subBoxNames.indexOf(t.type)]+"s";this[e]||(this[e]=[]),this[e].push(t)}else{const e="uuid"!==t.type?t.type:t.uuid;this[e]?m.warn("ContainerBox",`Box of type ${e} already exists in container box ${this.type}.`):this[e]=t}}}}},H=class extends L{constructor(t,e,s){super(t),this.hdr_size=e,this.start=s}static{this.registryId=Symbol.for("SampleEntryIdentifier")}isVideo(){return!1}isAudio(){return!1}isSubtitle(){return!1}isMetadata(){return!1}isHint(){return!1}getCodec(){return this.type.replace(".","")}getWidth(){return""}getHeight(){return""}getChannelCount(){return""}getSampleRate(){return""}getSampleSize(){return""}parseHeader(t){t.readUint8Array(6),this.data_reference_index=t.readUint16(),this.hdr_size+=8}parse(t){this.parseHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size)}parseDataAndRewind(t){this.parseHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size),this.hdr_size-=8,t.seek(this.start+this.hdr_size)}parseFooter(t){super.parse(t)}writeHeader(t){this.size=8,super.writeHeader(t),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint16(this.data_reference_index)}writeFooter(t){if(this.boxes)for(let e=0;e<this.boxes.length;e++)this.boxes[e].write(t),this.size+=this.boxes[e].size;m.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)}write(t){this.writeHeader(t),t.writeUint8Array(this.data),this.size+=this.data.length,m.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)}},M=class extends H{},O=class extends H{isMetadata(){return!0}},N=class extends H{isSubtitle(){return!0}},R=class extends H{},V=class extends H{parse(t){this.parseHeader(t),t.readUint16(),t.readUint16(),t.readUint32Array(3),this.width=t.readUint16(),this.height=t.readUint16(),this.horizresolution=t.readUint32(),this.vertresolution=t.readUint32(),t.readUint32(),this.frame_count=t.readUint16();const e=Math.min(31,t.readUint8());this.compressorname=t.readString(e),e<31&&t.readString(31-e),this.depth=t.readUint16(),t.readUint16(),this.parseFooter(t)}isVideo(){return!0}getWidth(){return this.width}getHeight(){return this.height}write(t){this.writeHeader(t),this.size+=70,t.writeUint16(0),t.writeUint16(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint32(this.horizresolution),t.writeUint32(this.vertresolution),t.writeUint32(0),t.writeUint16(this.frame_count),t.writeUint8(Math.min(31,this.compressorname.length)),t.writeString(this.compressorname,void 0,31),t.writeUint16(this.depth),t.writeInt16(-1),this.writeFooter(t)}},G=class extends H{parse(t){this.parseHeader(t),this.version=t.readUint16(),t.readUint16(),t.readUint32(),this.channel_count=t.readUint16(),this.samplesize=t.readUint16(),t.readUint16(),t.readUint16(),this.samplerate=t.readUint32()/65536;const e=t.isofile?.ftyp?.major_brand.includes("qt");e&&(1===this.version?this.extensions=t.readUint8Array(16):2===this.version&&(this.extensions=t.readUint8Array(36))),this.parseFooter(t)}isAudio(){return!0}getChannelCount(){return this.channel_count}getSampleRate(){return this.samplerate}getSampleSize(){return this.samplesize}write(t){this.writeHeader(t),this.size+=20,t.writeUint32(0),t.writeUint32(0),t.writeUint16(this.channel_count),t.writeUint16(this.samplesize),t.writeUint16(0),t.writeUint16(0),t.writeUint32(this.samplerate<<16),this.writeFooter(t)}},j=class extends H{parse(t){this.parseHeader(t),this.parseFooter(t)}write(t){this.writeHeader(t),this.writeFooter(t)}},$=class extends Array{toString(){let t="<table class='inner-table'>";t+="<thead><tr><th>length</th><th>nalu_data</th></tr></thead>",t+="<tbody>";for(let e=0;e<this.length;e++){const s=this[e];t+="<tr>",t+="<td>"+s.length+"</td>",t+="<td>",t+=s.data.reduce((function(t,e){return t+e.toString(16).padStart(2,"0")}),"0x"),t+="</td></tr>"}return t+="</tbody></table>",t}},q=class extends g{constructor(){super(...arguments),this.box_name="AVCConfigurationBox"}static{this.fourcc="avcC"}parse(t){this.configurationVersion=t.readUint8(),this.AVCProfileIndication=t.readUint8(),this.profile_compatibility=t.readUint8(),this.AVCLevelIndication=t.readUint8(),this.lengthSizeMinusOne=3&t.readUint8(),this.nb_SPS_nalus=31&t.readUint8();let e=this.size-this.hdr_size-6;this.SPS=new $;for(let s=0;s<this.nb_SPS_nalus;s++){const s=t.readUint16();this.SPS.push({length:s,data:t.readUint8Array(s)}),e-=2+s}this.nb_PPS_nalus=t.readUint8(),e--,this.PPS=new $;for(let s=0;s<this.nb_PPS_nalus;s++){const s=t.readUint16();this.PPS.push({length:s,data:t.readUint8Array(s)}),e-=2+s}e>0&&(this.ext=t.readUint8Array(e))}write(t){this.size=7;for(let t=0;t<this.SPS.length;t++)this.size+=2+this.SPS[t].length;for(let t=0;t<this.PPS.length;t++)this.size+=2+this.PPS[t].length;this.ext&&(this.size+=this.ext.length),this.writeHeader(t),t.writeUint8(this.configurationVersion),t.writeUint8(this.AVCProfileIndication),t.writeUint8(this.profile_compatibility),t.writeUint8(this.AVCLevelIndication),t.writeUint8(this.lengthSizeMinusOne+252),t.writeUint8(this.SPS.length+224);for(let e=0;e<this.SPS.length;e++)t.writeUint16(this.SPS[e].length),t.writeUint8Array(this.SPS[e].data);t.writeUint8(this.PPS.length);for(let e=0;e<this.PPS.length;e++)t.writeUint16(this.PPS[e].length),t.writeUint8Array(this.PPS[e].data);this.ext&&t.writeUint8Array(this.ext)}},Y=class extends g{constructor(){super(...arguments),this.box_name="MediaDataBox"}static{this.fourcc="mdat"}},W=class extends g{constructor(){super(...arguments),this.box_name="ItemDataBox"}static{this.fourcc="idat"}},K=class extends g{constructor(){super(...arguments),this.box_name="FreeSpaceBox"}static{this.fourcc="free"}},J=class extends g{constructor(){super(...arguments),this.box_name="FreeSpaceBox"}static{this.fourcc="skip"}},Q=class extends x{constructor(){super(...arguments),this.box_name="HintMediaHeaderBox"}static{this.fourcc="hmhd"}},X=class extends x{constructor(){super(...arguments),this.box_name="NullMediaHeaderBox"}static{this.fourcc="nmhd"}},Z=class extends x{constructor(){super(...arguments),this.box_name="ObjectDescriptorBox"}static{this.fourcc="iods"}},tt=class extends x{constructor(){super(...arguments),this.box_name="XMLBox"}static{this.fourcc="xml "}},et=class extends x{constructor(){super(...arguments),this.box_name="BinaryXMLBox"}static{this.fourcc="bxml"}},st=class extends x{constructor(){super(...arguments),this.box_name="ItemProtectionBox",this.sinfs=[]}static{this.fourcc="ipro"}get protections(){return this.sinfs}},it=class extends L{constructor(){super(...arguments),this.box_name="MovieBox",this.traks=[],this.psshs=[],this.subBoxNames=["trak","pssh"]}static{this.fourcc="moov"}},rt=class extends L{constructor(){super(...arguments),this.box_name="TrackBox",this.samples=[]}static{this.fourcc="trak"}},at=class extends L{constructor(){super(...arguments),this.box_name="EditBox"}static{this.fourcc="edts"}},nt=class extends L{constructor(){super(...arguments),this.box_name="MediaBox"}static{this.fourcc="mdia"}},ot=class extends L{constructor(){super(...arguments),this.box_name="MediaInformationBox"}static{this.fourcc="minf"}},ht=class extends L{constructor(){super(...arguments),this.box_name="DataInformationBox"}static{this.fourcc="dinf"}},dt=class extends L{constructor(){super(...arguments),this.box_name="SampleTableBox",this.sgpds=[],this.sbgps=[],this.subBoxNames=["sgpd","sbgp"]}static{this.fourcc="stbl"}},ct=class extends L{constructor(){super(...arguments),this.box_name="MovieExtendsBox",this.trexs=[],this.subBoxNames=["trex"]}static{this.fourcc="mvex"}},lt=class extends L{constructor(){super(...arguments),this.box_name="MovieFragmentBox",this.trafs=[],this.subBoxNames=["traf"]}static{this.fourcc="moof"}},pt=class extends L{constructor(){super(...arguments),this.box_name="TrackFragmentBox",this.truns=[],this.sgpds=[],this.sbgps=[],this.subBoxNames=["trun","sgpd","sbgp"]}static{this.fourcc="traf"}},ut=class extends L{constructor(){super(...arguments),this.box_name="VTTCueBox"}static{this.fourcc="vttc"}},ft=class extends L{constructor(){super(...arguments),this.box_name="MovieFragmentRandomAccessBox",this.tfras=[],this.subBoxNames=["tfra"]}static{this.fourcc="mfra"}},mt=class extends L{constructor(){super(...arguments),this.box_name="AdditionalMetadataContainerBox"}static{this.fourcc="meco"}},_t=class extends L{constructor(){super(...arguments),this.box_name="trackhintinformation",this.subBoxNames=["sdp ","rtp "]}static{this.fourcc="hnti"}},gt=class extends L{constructor(){super(...arguments),this.box_name="hintstatisticsbox",this.maxrs=[],this.subBoxNames=["maxr"]}static{this.fourcc="hinf"}},xt=class extends L{constructor(){super(...arguments),this.box_name="SubTrackBox"}static{this.fourcc="strk"}},bt=class extends L{constructor(){super(...arguments),this.box_name="SubTrackDefinitionBox"}static{this.fourcc="strd"}},yt=class extends L{constructor(){super(...arguments),this.box_name="ProtectionSchemeInfoBox"}static{this.fourcc="sinf"}},Ut=class extends L{constructor(){super(...arguments),this.box_name="RestrictedSchemeInfoBox"}static{this.fourcc="rinf"}},wt=class extends L{constructor(){super(...arguments),this.box_name="SchemeInformationBox"}static{this.fourcc="schi"}},St=class extends L{constructor(){super(...arguments),this.box_name="TrackGroupBox"}static{this.fourcc="trgr"}},vt=class extends L{constructor(){super(...arguments),this.box_name="UserDataBox",this.kinds=[],this.strks=[],this.subBoxNames=["kind","strk"]}static{this.fourcc="udta"}},Bt=class extends L{constructor(){super(...arguments),this.box_name="ItemPropertiesBox",this.ipmas=[],this.subBoxNames=["ipma"]}static{this.fourcc="iprp"}},zt=class extends L{constructor(){super(...arguments),this.box_name="ItemPropertyContainerBox",this.hvcCs=[],this.ispes=[],this.claps=[],this.irots=[],this.subBoxNames=["hvcC","ispe","clap","irot"]}static{this.fourcc="ipco"}},kt=class extends L{constructor(){super(...arguments),this.box_name="GroupsListBox"}static{this.fourcc="grpl"}},It=class extends L{constructor(){super(...arguments),this.box_name="J2KHeaderInfoBox"}static{this.fourcc="j2kH"}},Et=class extends L{constructor(){super(...arguments),this.box_name="ExtendedTypeBox",this.tycos=[],this.subBoxNames=["tyco"]}static{this.fourcc="etyp"}},Pt=class extends L{constructor(){super(...arguments),this.box_name="ProjectedOmniVideoBox",this.subBoxNames=["prfr"]}static{this.fourcc="povd"}},At=class extends x{constructor(){super(...arguments),this.box_name="DataReferenceBox"}static{this.fourcc="dref"}parse(t){this.parseFullHeader(t),this.entries=[];const e=t.readUint32();for(let s=0;s<e;s++){const e=D(t,!1,this.size-(t.getPosition()-this.start));if(1!==e.code)return;{const t=e.box;this.entries.push(t)}}}write(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.entries.length);for(let e=0;e<this.entries.length;e++)this.entries[e].write(t),this.size+=this.entries[e].size;m.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)}},Ct=class extends x{constructor(){super(...arguments),this.box_name="ExtendedLanguageBox"}static{this.fourcc="elng"}parse(t){this.parseFullHeader(t),this.extended_language=t.readString(this.size-this.hdr_size)}write(t){this.version=0,this.flags=0,this.size=this.extended_language.length,this.writeHeader(t),t.writeString(this.extended_language)}},Tt=class extends g{constructor(){super(...arguments),this.box_name="FileTypeBox"}static{this.fourcc="ftyp"}parse(t){let e=this.size-this.hdr_size;this.major_brand=t.readString(4),this.minor_version=t.readUint32(),e-=8,this.compatible_brands=[];let s=0;for(;e>=4;)this.compatible_brands[s]=t.readString(4),e-=4,s++}write(t){this.size=8+4*this.compatible_brands.length,this.writeHeader(t),t.writeString(this.major_brand,void 0,4),t.writeUint32(this.minor_version);for(let e=0;e<this.compatible_brands.length;e++)t.writeString(this.compatible_brands[e],void 0,4)}},Ft=class extends x{constructor(){super(...arguments),this.box_name="HandlerBox"}static{this.fourcc="hdlr"}parse(t){if(this.parseFullHeader(t),0===this.version&&(t.readUint32(),this.handler=t.readString(4),t.readUint32Array(3),!this.isEndOfBox(t))){const e=this.start+this.size-t.getPosition();this.name=t.readCString();const s=this.start+this.size-1;t.seek(s);0!==t.readUint8()&&e>1&&(m.info("BoxParser","Warning: hdlr name is not null-terminated, possibly length-prefixed string. Trimming first byte."),this.name=this.name.slice(1))}}write(t){this.size=20+this.name.length+1,this.version=0,this.flags=0,this.writeHeader(t),t.writeUint32(0),t.writeString(this.handler,void 0,4),t.writeUint32Array([0,0,0]),t.writeCString(this.name)}},Dt=class extends g{constructor(){super(...arguments),this.box_name="HEVCConfigurationBox"}static{this.fourcc="hvcC"}parse(t){this.configurationVersion=t.readUint8();let e=t.readUint8();this.general_profile_space=e>>6,this.general_tier_flag=(32&e)>>5,this.general_profile_idc=31&e,this.general_profile_compatibility=t.readUint32(),this.general_constraint_indicator=t.readUint8Array(6),this.general_level_idc=t.readUint8(),this.min_spatial_segmentation_idc=4095&t.readUint16(),this.parallelismType=3&t.readUint8(),this.chroma_format_idc=3&t.readUint8(),this.bit_depth_luma_minus8=7&t.readUint8(),this.bit_depth_chroma_minus8=7&t.readUint8(),this.avgFrameRate=t.readUint16(),e=t.readUint8(),this.constantFrameRate=e>>6,this.numTemporalLayers=(13&e)>>3,this.temporalIdNested=(4&e)>>2,this.lengthSizeMinusOne=3&e,this.nalu_arrays=[];const s=t.readUint8();for(let i=0;i<s;i++){const s=[];this.nalu_arrays.push(s),e=t.readUint8(),s.completeness=(128&e)>>7,s.nalu_type=63&e;const i=t.readUint16();for(let e=0;e<i;e++){const e=t.readUint16();s.push({data:t.readUint8Array(e)})}}}write(t){this.size=23;for(let t=0;t<this.nalu_arrays.length;t++){this.size+=3;for(let e=0;e<this.nalu_arrays[t].length;e++)this.size+=2+this.nalu_arrays[t][e].data.length}this.writeHeader(t),t.writeUint8(this.configurationVersion),t.writeUint8((this.general_profile_space<<6)+(this.general_tier_flag<<5)+this.general_profile_idc),t.writeUint32(this.general_profile_compatibility),t.writeUint8Array(this.general_constraint_indicator),t.writeUint8(this.general_level_idc),t.writeUint16(this.min_spatial_segmentation_idc+(15<<24)),t.writeUint8(this.parallelismType+252),t.writeUint8(this.chroma_format_idc+252),t.writeUint8(this.bit_depth_luma_minus8+248),t.writeUint8(this.bit_depth_chroma_minus8+248),t.writeUint16(this.avgFrameRate),t.writeUint8((this.constantFrameRate<<6)+(this.numTemporalLayers<<3)+(this.temporalIdNested<<2)+this.lengthSizeMinusOne),t.writeUint8(this.nalu_arrays.length);for(let e=0;e<this.nalu_arrays.length;e++){t.writeUint8((this.nalu_arrays[e].completeness<<7)+this.nalu_arrays[e].nalu_type),t.writeUint16(this.nalu_arrays[e].length);for(let s=0;s<this.nalu_arrays[e].length;s++)t.writeUint16(this.nalu_arrays[e][s].data.length),t.writeUint8Array(this.nalu_arrays[e][s].data)}}},Lt=class extends x{constructor(){super(...arguments),this.box_name="MediaHeaderBox"}static{this.fourcc="mdhd"}parse(t){this.parseFullHeader(t),1===this.version?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.timescale=t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.timescale=t.readUint32(),this.duration=t.readUint32()),this.parseLanguage(t),t.readUint16()}write(t){const e=this.modification_time>i||this.creation_time>i||this.duration>i||1===this.version;this.version=e?1:0,this.size=20,this.size+=e?12:0,this.flags=0,this.writeHeader(t),e?(t.writeUint64(this.creation_time),t.writeUint64(this.modification_time),t.writeUint32(this.timescale),t.writeUint64(this.duration)):(t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.timescale),t.writeUint32(this.duration)),t.writeUint16(this.language),t.writeUint16(0)}},Ht=class extends x{constructor(){super(...arguments),this.box_name="MovieExtendsHeaderBox"}static{this.fourcc="mehd"}parse(t){this.parseFullHeader(t),1&this.flags&&(m.warn("BoxParser","mehd box incorrectly uses flags set to 1, converting version to 1"),this.version=1),1===this.version?this.fragment_duration=t.readUint64():this.fragment_duration=t.readUint32()}write(t){const e=this.fragment_duration>i||1===this.version;this.version=e?1:0,this.size=4,this.size+=e?4:0,this.flags=0,this.writeHeader(t),e?t.writeUint64(this.fragment_duration):t.writeUint32(this.fragment_duration)}},Mt=class extends x{constructor(){super(...arguments),this.box_name="ItemInfoEntry"}static{this.fourcc="infe"}parse(t){if(this.parseFullHeader(t),0!==this.version&&1!==this.version||(this.item_ID=t.readUint16(),this.item_protection_index=t.readUint16(),this.item_name=t.readCString(),this.content_type=t.readCString(),this.isEndOfBox(t)||(this.content_encoding=t.readCString())),1===this.version)return this.extension_type=t.readString(4),m.warn("BoxParser","Cannot parse extension type"),void t.seek(this.start+this.size);this.version>=2&&(2===this.version?this.item_ID=t.readUint16():3===this.version&&(this.item_ID=t.readUint32()),this.item_protection_index=t.readUint16(),this.item_type=t.readString(4),this.item_name=t.readCString(),"mime"===this.item_type?(this.content_type=t.readCString(),this.content_encoding=t.readCString()):"uri "===this.item_type&&(this.item_uri_type=t.readCString()))}},Ot=class extends x{constructor(){super(...arguments),this.box_name="ItemInfoBox"}static{this.fourcc="iinf"}parse(t){this.parseFullHeader(t),0===this.version?this.entry_count=t.readUint16():this.entry_count=t.readUint32(),this.item_infos=[];for(let e=0;e<this.entry_count;e++){const s=D(t,!1,this.size-(t.getPosition()-this.start));if(1!==s.code)return;{const i=s.box;"infe"===i.type?this.item_infos[e]=i:m.error("BoxParser","Expected 'infe' box, got "+s.box.type,t.isofile)}}}},Nt=class extends x{constructor(){super(...arguments),this.box_name="ItemLocationBox"}static{this.fourcc="iloc"}parse(t){let e;this.parseFullHeader(t),e=t.readUint8(),this.offset_size=e>>4&15,this.length_size=15&e,e=t.readUint8(),this.base_offset_size=e>>4&15,1===this.version||2===this.version?this.index_size=15&e:this.index_size=0,this.items=[];let s=0;if(this.version<2)s=t.readUint16();else{if(2!==this.version)throw new Error("version of iloc box not supported");s=t.readUint32()}for(let e=0;e<s;e++){let e=0,s=0,i=0;if(this.version<2)e=t.readUint16();else{if(2!==this.version)throw new Error("version of iloc box not supported");e=t.readUint32()}s=1===this.version||2===this.version?15&t.readUint16():0;const r=t.readUint16();switch(this.base_offset_size){case 0:i=0;break;case 4:i=t.readUint32();break;case 8:i=t.readUint64();break;default:throw new Error("Error reading base offset size")}const a=[],n=t.readUint16();for(let e=0;e<n;e++){let e=0,s=0,i=0;if(1===this.version||2===this.version)switch(this.index_size){case 0:e=0;break;case 4:e=t.readUint32();break;case 8:e=t.readUint64();break;default:throw new Error("Error reading extent index")}switch(this.offset_size){case 0:s=0;break;case 4:s=t.readUint32();break;case 8:s=t.readUint64();break;default:throw new Error("Error reading extent index")}switch(this.length_size){case 0:i=0;break;case 4:i=t.readUint32();break;case 8:i=t.readUint64();break;default:throw new Error("Error reading extent index")}a.push({extent_index:e,extent_length:i,extent_offset:s})}this.items.push({base_offset:i,construction_method:s,item_ID:e,data_reference_index:r,extents:a})}}},Rt={auxl:"Auxiliary image item",base:"Pre-derived image item base",cdsc:"Item describes referenced item",dimg:"Derived image item",dpnd:"Item coding dependency",eroi:"Region",evir:"EVC slice",exbl:"Scalable image item","fdl ":"File delivery",font:"Font item",iloc:"Item data location",mask:"Region mask",mint:"Data integrity",pred:"Predictively coded item",prem:"Pre-multiplied item",tbas:"HEVC tile track base item",thmb:"Thumbnail image item"},Vt=class t extends x{constructor(){super(...arguments),this.box_name="ItemReferenceBox",this.references=[]}static{this.fourcc="iref"}static{this.allowed_types=["auxl","base","cdsc","dimg","dpnd","eroi","evir","exbl","fdl ","font","iloc","mask","mint","pred","prem","tbas","thmb"]}parse(e){for(this.parseFullHeader(e),this.references=[];e.getPosition()<this.start+this.size;){const s=D(e,!0,this.size-(e.getPosition()-this.start));if(1!==s.code)return;{let i="Unknown item reference";t.allowed_types.includes(s.type)?i=Rt[s.type]:m.warn("BoxParser",`Unknown item reference type: '${s.type}'`);const r=0===this.version?new U(s.type,s.size,i,s.hdr_size,s.start):new w(s.type,s.size,i,s.hdr_size,s.start);r.write===g.prototype.write&&"mdat"!==r.type&&(m.warn("BoxParser",r.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),r.parseDataAndRewind(e)),r.parse(e),this.references.push(r)}}}},Gt=class extends x{constructor(){super(...arguments),this.box_name="PrimaryItemBox"}static{this.fourcc="pitm"}parse(t){this.parseFullHeader(t),0===this.version?this.item_id=t.readUint16():this.item_id=t.readUint32()}},jt=class extends x{constructor(){super(...arguments),this.box_name="MetaBox",this.isQT=!1}static{this.fourcc="meta"}parse(t){const e=t.getPosition();if(this.size>8){t.readUint32();switch(t.readString(4)){case"hdlr":case"mhdr":case"keys":case"ilst":case"ctry":case"lang":this.isQT=!0}t.seek(e)}this.isQT||this.parseFullHeader(t),L.prototype.parse.call(this,t)}},$t=class extends x{constructor(){super(...arguments),this.box_name="MovieFragmentHeaderBox"}static{this.fourcc="mfhd"}parse(t){this.parseFullHeader(t),this.sequence_number=t.readUint32()}write(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.sequence_number)}},qt=class extends x{constructor(){super(...arguments),this.box_name="MovieHeaderBox"}static{this.fourcc="mvhd"}parse(t){this.parseFullHeader(t),1===this.version?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.timescale=t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.timescale=t.readUint32(),this.duration=t.readUint32()),this.rate=t.readUint32(),this.volume=t.readUint16()>>8,t.readUint16(),t.readUint32Array(2),this.matrix=t.readInt32Array(9),t.readUint32Array(6),this.next_track_id=t.readUint32()}write(t){const e=this.modification_time>i||this.creation_time>i||this.duration>i||1===this.version;this.version=e?1:0,this.size=96,this.size+=e?12:0,this.flags=0,this.writeHeader(t),e?(t.writeUint64(this.creation_time),t.writeUint64(this.modification_time),t.writeUint32(this.timescale),t.writeUint64(this.duration)):(t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.timescale),t.writeUint32(this.duration)),t.writeUint32(this.rate),t.writeUint16(this.volume<<8),t.writeUint16(0),t.writeUint32(0),t.writeUint32(0),t.writeInt32Array(this.matrix),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(this.next_track_id)}print(t){super.printHeader(t),t.log(t.indent+"creation_time: "+this.creation_time),t.log(t.indent+"modification_time: "+this.modification_time),t.log(t.indent+"timescale: "+this.timescale),t.log(t.indent+"duration: "+this.duration),t.log(t.indent+"rate: "+this.rate),t.log(t.indent+"volume: "+(this.volume>>8)),t.log(t.indent+"matrix: "+this.matrix.join(", ")),t.log(t.indent+"next_track_id: "+this.next_track_id)}},Yt=class extends O{static{this.fourcc="mett"}parse(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}},Wt=class extends O{static{this.fourcc="metx"}parse(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.namespace=t.readCString(),this.schema_location=t.readCString(),this.parseFooter(t)}},Kt=class extends g{constructor(){super(...arguments),this.box_name="AV1CodecConfigurationBox"}static{this.fourcc="av1C"}parse(t){let e=t.readUint8();if(1&~(e>>7))return void m.error("BoxParser","av1C marker problem",t.isofile);if(this.version=127&e,1!==this.version)return void m.error("BoxParser","av1C version "+this.version+" not supported",t.isofile);if(e=t.readUint8(),this.seq_profile=e>>5&7,this.seq_level_idx_0=31&e,e=t.readUint8(),this.seq_tier_0=e>>7&1,this.high_bitdepth=e>>6&1,this.twelve_bit=e>>5&1,this.monochrome=e>>4&1,this.chroma_subsampling_x=e>>3&1,this.chroma_subsampling_y=e>>2&1,this.chroma_sample_position=3&e,e=t.readUint8(),this.reserved_1=e>>5&7,0!==this.reserved_1)return void m.error("BoxParser","av1C reserved_1 parsing problem",t.isofile);if(this.initial_presentation_delay_present=e>>4&1,1===this.initial_presentation_delay_present)this.initial_presentation_delay_minus_one=15&e;else if(this.reserved_2=15&e,0!==this.reserved_2)return void m.error("BoxParser","av1C reserved_2 parsing problem",t.isofile);const s=this.size-this.hdr_size-4;this.configOBUs=t.readUint8Array(s)}},Jt=class extends x{constructor(){super(...arguments),this.box_name="ElementaryStreamDescriptorBox"}static{this.fourcc="esds"}parse(t){this.parseFullHeader(t);const e=t.readUint8Array(this.size-this.hdr_size);if("MPEG4DescriptorParser"in T){const t=new T.MPEG4DescriptorParser;this.esd=t.parseOneDescriptor(new l(e.buffer,0))}}},Qt=class extends x{constructor(){super(...arguments),this.box_name="VPCodecConfigurationRecord"}static{this.fourcc="vpcC"}parse(t){if(this.parseFullHeader(t),1===this.version){this.profile=t.readUint8(),this.level=t.readUint8();const e=t.readUint8();this.bitDepth=e>>4,this.chromaSubsampling=e>>1&7,this.videoFullRangeFlag=1&e,this.colourPrimaries=t.readUint8(),this.transferCharacteristics=t.readUint8(),this.matrixCoefficients=t.readUint8(),this.codecIntializationDataSize=t.readUint16(),this.codecIntializationData=t.readUint8Array(this.codecIntializationDataSize)}else{this.profile=t.readUint8(),this.level=t.readUint8();let e=t.readUint8();this.bitDepth=e>>4&15,this.colorSpace=15&e,e=t.readUint8(),this.chromaSubsampling=e>>4&15,this.transferFunction=e>>1&7,this.videoFullRangeFlag=1&e,this.codecIntializationDataSize=t.readUint16(),this.codecIntializationData=t.readUint8Array(this.codecIntializationDataSize)}}},Xt=class extends x{constructor(){super(...arguments),this.box_name="VvcConfigurationBox"}static{this.fourcc="vvcC"}parse(t){this.parseFullHeader(t);const e={held_bits:void 0,num_held_bits:0,stream_read_1_bytes:function(t){this.held_bits=t.readUint8(),this.num_held_bits=8},stream_read_2_bytes:function(t){this.held_bits=t.readUint16(),this.num_held_bits=16},extract_bits:function(t){const e=this.held_bits>>this.num_held_bits-t&(1<<t)-1;return this.num_held_bits-=t,e}};if(e.stream_read_1_bytes(t),e.extract_bits(5),this.lengthSizeMinusOne=e.extract_bits(2),this.ptl_present_flag=e.extract_bits(1),this.ptl_present_flag){if(e.stream_read_2_bytes(t),this.ols_idx=e.extract_bits(9),this.num_sublayers=e.extract_bits(3),this.constant_frame_rate=e.extract_bits(2),this.chroma_format_idc=e.extract_bits(2),e.stream_read_1_bytes(t),this.bit_depth_minus8=e.extract_bits(3),e.extract_bits(5),e.stream_read_2_bytes(t),e.extract_bits(2),this.num_bytes_constraint_info=e.extract_bits(6),this.general_profile_idc=e.extract_bits(7),this.general_tier_flag=e.extract_bits(1),this.general_level_idc=t.readUint8(),e.stream_read_1_bytes(t),this.ptl_frame_only_constraint_flag=e.extract_bits(1),this.ptl_multilayer_enabled_flag=e.extract_bits(1),this.general_constraint_info=new Uint8Array(this.num_bytes_constraint_info),this.num_bytes_constraint_info){for(let s=0;s<this.num_bytes_constraint_info-1;s++){const i=e.extract_bits(6);e.stream_read_1_bytes(t);const r=e.extract_bits(2);this.general_constraint_info[s]=i<<2|r}this.general_constraint_info[this.num_bytes_constraint_info-1]=e.extract_bits(6)}else e.extract_bits(6);if(this.num_sublayers>1){e.stream_read_1_bytes(t),this.ptl_sublayer_present_mask=0;for(let t=this.num_sublayers-2;t>=0;--t){const s=e.extract_bits(1);this.ptl_sublayer_present_mask|=s<<t}for(let t=this.num_sublayers;t<=8&&this.num_sublayers>1;++t)e.extract_bits(1);this.sublayer_level_idc=[];for(let e=this.num_sublayers-2;e>=0;--e)this.ptl_sublayer_present_mask&1<<e&&(this.sublayer_level_idc[e]=t.readUint8())}if(this.ptl_num_sub_profiles=t.readUint8(),this.general_sub_profile_idc=[],this.ptl_num_sub_profiles)for(let e=0;e<this.ptl_num_sub_profiles;e++)this.general_sub_profile_idc.push(t.readUint32());this.max_picture_width=t.readUint16(),this.max_picture_height=t.readUint16(),this.avg_frame_rate=t.readUint16()}this.nalu_arrays=[];const s=t.readUint8();for(let i=0;i<s;i++){const s=[];this.nalu_arrays.push(s),e.stream_read_1_bytes(t),s.completeness=e.extract_bits(1),e.extract_bits(2),s.nalu_type=e.extract_bits(5);let i=1;13!==s.nalu_type&&12!==s.nalu_type&&(i=t.readUint16());for(let e=0;e<i;e++){const e=t.readUint16();s.push({data:t.readUint8Array(e),length:e})}}}},Zt=class extends g{constructor(){super(...arguments),this.box_name="ColourInformationBox"}static{this.fourcc="colr"}parse(t){if(this.colour_type=t.readString(4),"nclx"===this.colour_type){this.colour_primaries=t.readUint16(),this.transfer_characteristics=t.readUint16(),this.matrix_coefficients=t.readUint16();const e=t.readUint8();this.full_range_flag=e>>7}else("rICC"===this.colour_type||"prof"===this.colour_type)&&(this.ICC_profile=t.readUint8Array(this.size-4))}};function te(t,e){let s=Number(t).toString(16);for(e=void 0===e?2:e;s.length<e;)s="0"+s;return s}var ee=class extends V{getCodec(){const t=super.getCodec();return this.avcC?`${t}.${te(this.avcC.AVCProfileIndication)}${te(this.avcC.profile_compatibility)}${te(this.avcC.AVCLevelIndication)}`:t}},se=class extends ee{constructor(){super(...arguments),this.box_name="AVCSampleEntry"}static{this.fourcc="avc1"}},ie=class extends ee{constructor(){super(...arguments),this.box_name="AVC2SampleEntry"}static{this.fourcc="avc2"}},re=class extends ee{constructor(){super(...arguments),this.box_name="AVCSampleEntry"}static{this.fourcc="avc3"}},ae=class extends ee{constructor(){super(...arguments),this.box_name="AVC2SampleEntry"}static{this.fourcc="avc4"}},ne=class extends V{constructor(){super(...arguments),this.box_name="AV1SampleEntry"}static{this.fourcc="av01"}getCodec(){const t=super.getCodec(),e=this.av1C.seq_level_idx_0,s=e<10?"0"+e:e;let i;return 2===this.av1C.seq_profile&&1===this.av1C.high_bitdepth?i=1===this.av1C.twelve_bit?"12":"10":this.av1C.seq_profile<=2&&(i=1===this.av1C.high_bitdepth?"10":"08"),t+"."+this.av1C.seq_profile+"."+s+(this.av1C.seq_tier_0?"H":"M")+"."+i}},oe=class extends V{static{this.fourcc="dav1"}},he=class extends V{getCodec(){let t=super.getCodec();if(this.hvcC){switch(t+=".",this.hvcC.general_profile_space){case 0:t+="";break;case 1:t+="A";break;case 2:t+="B";break;case 3:t+="C"}t+=this.hvcC.general_profile_idc,t+=".";let e=this.hvcC.general_profile_compatibility,s=0;for(let t=0;t<32&&(s|=1&e,31!==t);t++)s<<=1,e>>=1;t+=te(s,0),t+=".",0===this.hvcC.general_tier_flag?t+="L":t+="H",t+=this.hvcC.general_level_idc;let i=!1,r="";for(let t=5;t>=0;t--)(this.hvcC.general_constraint_indicator[t]||i)&&(r="."+te(this.hvcC.general_constraint_indicator[t],0)+r,i=!0);t+=r}return t}},de=class extends he{constructor(){super(...arguments),this.box_name="HEVCSampleEntry"}static{this.fourcc="hvc1"}},ce=class extends he{static{this.fourcc="hvc2"}},le=class extends he{constructor(){super(...arguments),this.box_name="HEVCSampleEntry",this.colrs=[],this.subBoxNames=["colr"]}static{this.fourcc="hev1"}},pe=class extends he{static{this.fourcc="hev2"}},ue=class extends V{constructor(){super(...arguments),this.box_name="HEVCTileSampleSampleEntry"}static{this.fourcc="hvt1"}},fe=class extends V{constructor(){super(...arguments),this.box_name="LHEVCSampleEntry"}static{this.fourcc="lhe1"}},me=class extends V{constructor(){super(...arguments),this.box_name="LHEVCSampleEntry"}static{this.fourcc="lhv1"}},_e=class extends V{static{this.fourcc="dvh1"}},ge=class extends V{static{this.fourcc="dvhe"}},xe=class extends V{getCodec(){let t=super.getCodec();if(this.vvcC){t+="."+this.vvcC.general_profile_idc,this.vvcC.general_tier_flag?t+=".H":t+=".L",t+=this.vvcC.general_level_idc;let e="";if(this.vvcC.general_constraint_info){const t=[];let s,i=0;i|=this.vvcC.ptl_frame_only_constraint_flag<<7,i|=this.vvcC.ptl_multilayer_enabled_flag<<6;for(let e=0;e<this.vvcC.general_constraint_info.length;++e)i|=this.vvcC.general_constraint_info[e]>>2&63,t.push(i),i&&(s=e),i=this.vvcC.general_constraint_info[e]>>2&3;if(void 0===s)e=".CA";else{e=".C";const i="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";let r=0,a=0;for(let n=0;n<=s;++n)for(r=r<<8|t[n],a+=8;a>=5;){e+=i[r>>a-5&31],a-=5,r&=(1<<a)-1}a&&(r<<=5-a,e+=i[31&r])}}t+=e}return t}},be=class extends xe{constructor(){super(...arguments),this.box_name="VvcSampleEntry"}static{this.fourcc="vvc1"}},ye=class extends xe{constructor(){super(...arguments),this.box_name="VvcSampleEntry"}static{this.fourcc="vvi1"}},Ue=class extends V{constructor(){super(...arguments),this.box_name="VvcSampleEntry"}static{this.fourcc="vvs1"}},we=class extends V{constructor(){super(...arguments),this.box_name="VvcNonVCLSampleEntry"}static{this.fourcc="vvcN"}},Se=class extends V{getCodec(){const t=super.getCodec();let e=this.vpcC.level;0===e&&(e="00");let s=this.vpcC.bitDepth;return 8===s&&(s="08"),`${t}.0${this.vpcC.profile}.${e}.${s}`}},ve=class extends Se{static{this.fourcc="vp08"}},Be=class extends Se{static{this.fourcc="vp09"}},ze=class extends V{static{this.fourcc="avs3"}},ke=class extends V{constructor(){super(...arguments),this.box_name="J2KSampleEntry"}static{this.fourcc="j2ki"}},Ie=class extends V{static{this.fourcc="mjp2"}},Ee=class extends V{static{this.fourcc="mjpg"}},Pe=class extends V{constructor(){super(...arguments),this.box_name="UncompressedVideoSampleEntry"}static{this.fourcc="uncv"}},Ae=class extends V{constructor(){super(...arguments),this.box_name="MP4VisualSampleEntry"}static{this.fourcc="mp4v"}},Ce=class extends G{constructor(){super(...arguments),this.box_name="MP4AudioSampleEntry"}static{this.fourcc="mp4a"}getCodec(){const t=super.getCodec();if(this.esds&&this.esds.esd){const e=this.esds.esd.getOTI(),s=this.esds.esd.getAudioConfig();return t+"."+te(e)+(s?"."+s:"")}return t}},Te=class extends G{static{this.fourcc="m4ae"}},Fe=class extends G{static{this.fourcc="ac-3"}},De=class extends G{static{this.fourcc="ac-4"}},Le=class extends G{static{this.fourcc="ec-3"}},He=class extends G{static{this.fourcc="Opus"}},Me=class extends G{static{this.fourcc="mha1"}},Oe=class extends G{static{this.fourcc="mha2"}},Ne=class extends G{static{this.fourcc="mhm1"}},Re=class extends G{static{this.fourcc="mhm2"}},Ve=class extends G{static{this.fourcc="fLaC"}},Ge=class extends V{static{this.fourcc="encv"}},je=class extends G{static{this.fourcc="enca"}},$e=class extends N{constructor(){super(...arguments),this.subBoxNames=["sinf"],this.sinfs=[]}static{this.fourcc="encu"}},qe=class extends j{constructor(){super(...arguments),this.subBoxNames=["sinf"],this.sinfs=[]}static{this.fourcc="encs"}},Ye=class extends j{static{this.fourcc="mp4s"}},We=class extends R{constructor(){super(...arguments),this.subBoxNames=["sinf"],this.sinfs=[]}static{this.fourcc="enct"}},Ke=class extends O{constructor(){super(...arguments),this.subBoxNames=["sinf"],this.sinfs=[]}static{this.fourcc="encm"}},Je=class extends V{constructor(){super(...arguments),this.box_name="RestrictedVideoSampleEntry"}static{this.fourcc="resv"}},Qe=class extends N{static{this.fourcc="sbtt"}parse(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}},Xe=class extends N{static{this.fourcc="stpp"}parse(t){this.parseHeader(t),this.namespace=t.readCString(),this.schema_location=t.readCString(),this.auxiliary_mime_types=t.readCString(),this.parseFooter(t)}write(t){this.writeHeader(t),this.size+=this.namespace.length+1+this.schema_location.length+1+this.auxiliary_mime_types.length+1,t.writeCString(this.namespace),t.writeCString(this.schema_location),t.writeCString(this.auxiliary_mime_types),this.writeFooter(t)}},Ze=class extends N{static{this.fourcc="stxt"}parse(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}getCodec(){const t=super.getCodec();return this.mime_format?t+"."+this.mime_format:t}},ts=class extends N{static{this.fourcc="tx3g"}parse(t){this.parseHeader(t),this.displayFlags=t.readUint32(),this.horizontal_justification=t.readInt8(),this.vertical_justification=t.readInt8(),this.bg_color_rgba=t.readUint8Array(4),this.box_record=t.readInt16Array(4),this.style_record=t.readUint8Array(12),this.parseFooter(t)}},es=class extends O{static{this.fourcc="wvtt"}parse(t){this.parseHeader(t),this.parseFooter(t)}},ss=class extends x{constructor(){super(...arguments),this.box_name="SampleToGroupBox"}static{this.fourcc="sbgp"}parse(t){this.parseFullHeader(t),this.grouping_type=t.readString(4),1===this.version?this.grouping_type_parameter=t.readUint32():this.grouping_type_parameter=0,this.entries=[];const e=t.readUint32();for(let s=0;s<e;s++)this.entries.push({sample_count:t.readInt32(),group_description_index:t.readInt32()})}write(t){this.grouping_type_parameter?this.version=1:this.version=0,this.flags=0,this.size=8+8*this.entries.length+(1===this.version?4:0),this.writeHeader(t),t.writeString(this.grouping_type,void 0,4),1===this.version&&t.writeUint32(this.grouping_type_parameter),t.writeUint32(this.entries.length);for(let e=0;e<this.entries.length;e++){const s=this.entries[e];t.writeInt32(s.sample_count),t.writeInt32(s.group_description_index)}}},is=class extends x{constructor(){super(...arguments),this.box_name="SampleDependencyTypeBox"}static{this.fourcc="sdtp"}parse(t){this.parseFullHeader(t);const e=this.size-this.hdr_size;this.is_leading=[],this.sample_depends_on=[],this.sample_is_depended_on=[],this.sample_has_redundancy=[];for(let s=0;s<e;s++){const e=t.readUint8();this.is_leading[s]=e>>6,this.sample_depends_on[s]=e>>4&3,this.sample_is_depended_on[s]=e>>2&3,this.sample_has_redundancy[s]=3&e}}},rs=class extends x{constructor(){super(...arguments),this.box_name="SampleGroupDescriptionBox"}static{this.fourcc="sgpd"}parse(t){this.parseFullHeader(t),this.grouping_type=t.readString(4),m.debug("BoxParser","Found Sample Groups of type "+this.grouping_type),1===this.version?this.default_length=t.readUint32():this.default_length=0,this.version>=2&&(this.default_group_description_index=t.readUint32()),this.entries=[];const e=t.readUint32();for(let s=0;s<e;s++){let e;e=this.grouping_type in C.sampleGroupEntry?new C.sampleGroupEntry[this.grouping_type](this.grouping_type):new b(this.grouping_type),this.entries.push(e),1===this.version&&0===this.default_length?e.description_length=t.readUint32():e.description_length=this.default_length,e.write===b.prototype.write&&(m.info("BoxParser","SampleGroup for type "+this.grouping_type+" writing not yet implemented, keeping unparsed data in memory for later write"),e.data=t.readUint8Array(e.description_length),t.seek(t.getPosition()-e.description_length)),e.parse(t)}}write(t){this.flags=0,this.size=12;for(let t=0;t<this.entries.length;t++){const e=this.entries[t];1===this.version&&(0===this.default_length&&(this.size+=4),this.size+=e.data.length)}this.writeHeader(t),t.writeString(this.grouping_type,void 0,4),1===this.version&&t.writeUint32(this.default_length),this.version>=2&&t.writeUint32(this.default_sample_description_index),t.writeUint32(this.entries.length);for(let e=0;e<this.entries.length;e++){const s=this.entries[e];1===this.version&&0===this.default_length&&t.writeUint32(s.description_length),s.write(t)}}},as=class extends x{constructor(){super(...arguments),this.box_name="CompressedSegmentIndexBox"}static{this.fourcc="sidx"}parse(t){this.parseFullHeader(t),this.reference_ID=t.readUint32(),this.timescale=t.readUint32(),0===this.version?(this.earliest_presentation_time=t.readUint32(),this.first_offset=t.readUint32()):(this.earliest_presentation_time=t.readUint64(),this.first_offset=t.readUint64()),t.readUint16(),this.references=[];const e=t.readUint16();for(let s=0;s<e;s++){const e=t.readUint32(),s=t.readUint32(),i=t.readUint32();this.references.push({reference_type:e>>31&1,referenced_size:2147483647&e,subsegment_duration:s,starts_with_SAP:i>>31&1,SAP_type:i>>28&7,SAP_delta_time:268435455&i})}}write(t){const e=this.earliest_presentation_time>i||this.first_offset>i||1===this.version;this.version=e?1:0,this.size=12+12*this.references.length,this.size+=e?16:8,this.flags=0,this.writeHeader(t),t.writeUint32(this.reference_ID),t.writeUint32(this.timescale),e?(t.writeUint64(this.earliest_presentation_time),t.writeUint64(this.first_offset)):(t.writeUint32(this.earliest_presentation_time),t.writeUint32(this.first_offset)),t.writeUint16(0),t.writeUint16(this.references.length);for(let e=0;e<this.references.length;e++){const s=this.references[e];t.writeUint32(s.reference_type<<31|s.referenced_size),t.writeUint32(s.subsegment_duration),t.writeUint32(s.starts_with_SAP<<31|s.SAP_type<<28|s.SAP_delta_time)}}},ns=class extends x{constructor(){super(...arguments),this.box_name="SoundMediaHeaderBox"}static{this.fourcc="smhd"}parse(t){this.parseFullHeader(t),this.balance=t.readUint16(),t.readUint16()}write(t){this.version=0,this.size=4,this.writeHeader(t),t.writeUint16(this.balance),t.writeUint16(0)}},os=class extends x{constructor(){super(...arguments),this.box_name="ChunkOffsetBox"}static{this.fourcc="stco"}parse(t){this.parseFullHeader(t);const e=t.readUint32();if(this.chunk_offsets=[],0===this.version)for(let s=0;s<e;s++)this.chunk_offsets.push(t.readUint32())}write(t){this.version=0,this.flags=0,this.size=4+4*this.chunk_offsets.length,this.writeHeader(t),t.writeUint32(this.chunk_offsets.length),t.writeUint32Array(this.chunk_offsets)}unpack(t){for(let e=0;e<this.chunk_offsets.length;e++)t[e].offset=this.chunk_offsets[e]}},hs=class extends x{constructor(){super(...arguments),this.box_name="SubtitleMediaHeaderBox"}static{this.fourcc="sthd"}},ds=class extends x{constructor(){super(...arguments),this.box_name="SampleToChunkBox"}static{this.fourcc="stsc"}parse(t){this.parseFullHeader(t);const e=t.readUint32();if(this.first_chunk=[],this.samples_per_chunk=[],this.sample_description_index=[],0===this.version)for(let s=0;s<e;s++)this.first_chunk.push(t.readUint32()),this.samples_per_chunk.push(t.readUint32()),this.sample_description_index.push(t.readUint32())}write(t){this.version=0,this.flags=0,this.size=4+12*this.first_chunk.length,this.writeHeader(t),t.writeUint32(this.first_chunk.length);for(let e=0;e<this.first_chunk.length;e++)t.writeUint32(this.first_chunk[e]),t.writeUint32(this.samples_per_chunk[e]),t.writeUint32(this.sample_description_index[e])}unpack(t){let e=0,s=0;for(let i=0;i<this.first_chunk.length;i++)for(let r=0;r<(i+1<this.first_chunk.length?this.first_chunk[i+1]:1/0);r++){s++;for(let r=0;r<this.samples_per_chunk[i];r++){if(!t[e])return;t[e].description_index=this.sample_description_index[i],t[e].chunk_index=s,e++}}}},cs=class extends x{constructor(){super(...arguments),this.box_name="SampleDescriptionBox"}static{this.fourcc="stsd"}parse(t){this.parseFullHeader(t),this.entries=[];const e=t.readUint32();for(let s=1;s<=e;s++){const e=D(t,!0,this.size-(t.getPosition()-this.start));if(1!==e.code)return;{let s;e.type in C.sampleEntry?(s=new C.sampleEntry[e.type](e.size),s.hdr_size=e.hdr_size,s.start=e.start):(m.warn("BoxParser",`Unknown sample entry type: '${e.type}'`),s=new H(e.size,e.hdr_size,e.start),s.type=e.type),s.write===H.prototype.write&&(m.info("BoxParser","SampleEntry "+s.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),s.parseDataAndRewind(t)),s.parse(t),this.entries.push(s)}}}write(t){this.version=0,this.flags=0,this.size=0,this.writeHeader(t),t.writeUint32(this.entries.length),this.size+=4;for(let e=0;e<this.entries.length;e++)this.entries[e].write(t),this.size+=this.entries[e].size;m.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)}},ls=class extends x{constructor(){super(...arguments),this.box_name="SampleSizeBox"}static{this.fourcc="stsz"}parse(t){if(this.parseFullHeader(t),this.sample_sizes=[],0===this.version){this.sample_size=t.readUint32(),this.sample_count=t.readUint32();for(let e=0;e<this.sample_count;e++)0===this.sample_size?this.sample_sizes.push(t.readUint32()):this.sample_sizes[e]=this.sample_size}}write(t){let e=!0;if(this.version=0,this.flags=0,this.sample_sizes.length>0){let t=0;for(;t+1<this.sample_sizes.length;){if(this.sample_sizes[t+1]!==this.sample_sizes[0]){e=!1;break}t++}}else e=!1;this.size=8,e||(this.size+=4*this.sample_sizes.length),this.writeHeader(t),e?t.writeUint32(this.sample_sizes[0]):t.writeUint32(0),t.writeUint32(this.sample_sizes.length),e||t.writeUint32Array(this.sample_sizes)}unpack(t){for(let e=0;e<this.sample_sizes.length;e++)t[e].size=this.sample_sizes[e]}},ps=class extends x{constructor(){super(...arguments),this.box_name="TimeToSampleBox",this.sample_counts=[],this.sample_deltas=[]}static{this.fourcc="stts"}parse(t){this.parseFullHeader(t);const e=t.readUint32();if(this.sample_counts.length=0,this.sample_deltas.length=0,0===this.version)for(let s=0;s<e;s++){this.sample_counts.push(t.readUint32());let e=t.readInt32();e<0&&(m.warn("BoxParser","File uses negative stts sample delta, using value 1 instead, sync may be lost!"),e=1),this.sample_deltas.push(e)}}write(t){this.version=0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(t),t.writeUint32(this.sample_counts.length);for(let e=0;e<this.sample_counts.length;e++)t.writeUint32(this.sample_counts[e]),t.writeUint32(this.sample_deltas[e])}unpack(t){let e=0;for(let s=0;s<this.sample_counts.length;s++)for(let i=0;i<this.sample_counts[s];i++)t[e].dts=0===e?0:t[e-1].dts+this.sample_deltas[s],e++}},us=class extends x{constructor(){super(...arguments),this.box_name="TrackFragmentBaseMediaDecodeTimeBox"}static{this.fourcc="tfdt"}parse(t){this.parseFullHeader(t),1===this.version?this.baseMediaDecodeTime=t.readUint64():this.baseMediaDecodeTime=t.readUint32()}write(t){const e=this.baseMediaDecodeTime>i||1===this.version;this.version=e?1:0,this.size=4,this.size+=e?4:0,this.flags=0,this.writeHeader(t),e?t.writeUint64(this.baseMediaDecodeTime):t.writeUint32(this.baseMediaDecodeTime)}},fs=class extends x{constructor(){super(...arguments),this.box_name="TrackFragmentHeaderBox"}static{this.fourcc="tfhd"}parse(t){this.parseFullHeader(t);let e=0;this.track_id=t.readUint32(),this.size-this.hdr_size>e&&1&this.flags?(this.base_data_offset=t.readUint64(),e+=8):this.base_data_offset=0,this.size-this.hdr_size>e&&2&this.flags?(this.default_sample_description_index=t.readUint32(),e+=4):this.default_sample_description_index=0,this.size-this.hdr_size>e&&8&this.flags?(this.default_sample_duration=t.readUint32(),e+=4):this.default_sample_duration=0,this.size-this.hdr_size>e&&16&this.flags?(this.default_sample_size=t.readUint32(),e+=4):this.default_sample_size=0,this.size-this.hdr_size>e&&32&this.flags?(this.default_sample_flags=t.readUint32(),e+=4):this.default_sample_flags=0}write(t){this.version=0,this.size=4,1&this.flags&&(this.size+=8),2&this.flags&&(this.size+=4),8&this.flags&&(this.size+=4),16&this.flags&&(this.size+=4),32&this.flags&&(this.size+=4),this.writeHeader(t),t.writeUint32(this.track_id),1&this.flags&&t.writeUint64(this.base_data_offset),2&this.flags&&t.writeUint32(this.default_sample_description_index),8&this.flags&&t.writeUint32(this.default_sample_duration),16&this.flags&&t.writeUint32(this.default_sample_size),32&this.flags&&t.writeUint32(this.default_sample_flags)}},ms=class extends x{constructor(){super(...arguments),this.box_name="TrackHeaderBox",this.layer=0,this.alternate_group=0}static{this.fourcc="tkhd"}parse(t){this.parseFullHeader(t),1===this.version?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.track_id=t.readUint32(),t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.track_id=t.readUint32(),t.readUint32(),this.duration=t.readUint32()),t.readUint32Array(2),this.layer=t.readInt16(),this.alternate_group=t.readInt16(),this.volume=t.readInt16()>>8,t.readUint16(),this.matrix=t.readInt32Array(9),this.width=t.readUint32(),this.height=t.readUint32()}write(t){const e=this.modification_time>i||this.creation_time>i||this.duration>i||1===this.version;this.version=e?1:0,this.size=80,this.size+=e?12:0,this.flags=this.flags??3,this.writeHeader(t),e?(t.writeUint64(this.creation_time),t.writeUint64(this.modification_time),t.writeUint32(this.track_id),t.writeUint32(0),t.writeUint64(this.duration)):(t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.track_id),t.writeUint32(0),t.writeUint32(this.duration)),t.writeUint32Array([0,0]),t.writeInt16(this.layer),t.writeInt16(this.alternate_group),t.writeInt16(this.volume<<8),t.writeInt16(0),t.writeInt32Array(this.matrix),t.writeUint32(this.width),t.writeUint32(this.height)}print(t){super.printHeader(t),t.log(t.indent+"creation_time: "+this.creation_time),t.log(t.indent+"modification_time: "+this.modification_time),t.log(t.indent+"track_id: "+this.track_id),t.log(t.indent+"duration: "+this.duration),t.log(t.indent+"volume: "+(this.volume>>8)),t.log(t.indent+"matrix: "+this.matrix.join(", ")),t.log(t.indent+"layer: "+this.layer),t.log(t.indent+"alternate_group: "+this.alternate_group),t.log(t.indent+"width: "+this.width),t.log(t.indent+"height: "+this.height)}},_s=class extends x{constructor(){super(...arguments),this.box_name="TrackExtendsBox"}static{this.fourcc="trex"}parse(t){this.parseFullHeader(t),this.track_id=t.readUint32(),this.default_sample_description_index=t.readUint32(),this.default_sample_duration=t.readUint32(),this.default_sample_size=t.readUint32(),this.default_sample_flags=t.readUint32()}write(t){this.version=0,this.flags=0,this.size=20,this.writeHeader(t),t.writeUint32(this.track_id),t.writeUint32(this.default_sample_description_index),t.writeUint32(this.default_sample_duration),t.writeUint32(this.default_sample_size),t.writeUint32(this.default_sample_flags)}},gs=class extends x{constructor(){super(...arguments),this.box_name="TrackRunBox",this.sample_duration=[],this.sample_size=[],this.sample_flags=[],this.sample_composition_time_offset=[]}static{this.fourcc="trun"}parse(t){this.parseFullHeader(t);let e=0;if(this.sample_count=t.readUint32(),e+=4,this.size-this.hdr_size>e&&1&this.flags?(this.data_offset=t.readInt32(),e+=4):this.data_offset=0,this.size-this.hdr_size>e&&4&this.flags?(this.first_sample_flags=t.readUint32(),e+=4):this.first_sample_flags=0,this.sample_duration=[],this.sample_size=[],this.sample_flags=[],this.sample_composition_time_offset=[],this.size-this.hdr_size>e)for(let e=0;e<this.sample_count;e++)this.flags&a&&(this.sample_duration[e]=t.readUint32()),this.flags&n&&(this.sample_size[e]=t.readUint32()),this.flags&o&&(this.sample_flags[e]=t.readUint32()),this.flags&h&&(0===this.version?this.sample_composition_time_offset[e]=t.readUint32():this.sample_composition_time_offset[e]=t.readInt32())}write(t){this.size=4,1&this.flags&&(this.size+=4),4&this.flags&&(this.size+=4),this.flags&a&&(this.size+=4*this.sample_duration.length),this.flags&n&&(this.size+=4*this.sample_size.length),this.flags&o&&(this.size+=4*this.sample_flags.length),this.flags&h&&(this.size+=4*this.sample_composition_time_offset.length),this.writeHeader(t),t.writeUint32(this.sample_count),1&this.flags&&(this.data_offset_position=t.getPosition(),t.writeInt32(this.data_offset)),4&this.flags&&t.writeUint32(this.first_sample_flags);for(let e=0;e<this.sample_count;e++)this.flags&a&&t.writeUint32(this.sample_duration[e]),this.flags&n&&t.writeUint32(this.sample_size[e]),this.flags&o&&t.writeUint32(this.sample_flags[e]),this.flags&h&&(0===this.version?t.writeUint32(this.sample_composition_time_offset[e]):t.writeInt32(this.sample_composition_time_offset[e]))}},xs=class extends x{constructor(){super(...arguments),this.box_name="DataEntryUrlBox"}static{this.fourcc="url "}parse(t){this.parseFullHeader(t),1!==this.flags&&(this.location=t.readCString())}write(t){this.version=0,this.location?(this.flags=0,this.size=this.location.length+1):(this.flags=1,this.size=0),this.writeHeader(t),this.location&&t.writeCString(this.location)}},bs=class extends x{constructor(){super(...arguments),this.box_name="VideoMediaHeaderBox"}static{this.fourcc="vmhd"}parse(t){this.parseFullHeader(t),this.graphicsmode=t.readUint16(),this.opcolor=t.readUint16Array(3)}write(t){this.version=0,this.size=8,this.writeHeader(t),t.writeUint16(this.graphicsmode),t.writeUint16Array(this.opcolor)}},ys=class{constructor(t,e,s){this.grouping_type=t,this.grouping_type_parameter=e,this.sbgp=s,this.last_sample_in_run=-1,this.entry_index=-1}},Us=class t{constructor(t,e=!0){this.boxes=[],this.mdats=[],this.moofs=[],this.isProgressive=!1,this.moovStartFound=!1,this.moovStartSent=!1,this.readySent=!1,this.sampleListBuilt=!1,this.fragmentedTracks=[],this.extractedTracks=[],this.isFragmentationInitialized=!1,this.sampleProcessingStarted=!1,this.nextMoofNumber=0,this.itemListBuilt=!1,this.sidxSent=!1,this.items=[],this.entity_groups=[],this.itemsDataSize=0,this.lastMoofIndex=0,this.samplesDataSize=0,this.lastBoxStartPosition=0,this.nextParsePosition=0,this.discardMdatData=!0,this.discardMdatData=e,t?(this.stream=t,this.parse()):this.stream=new _,this.stream.isofile=this}setSegmentOptions(t,e,s){const{sizePerSegment:i=Number.MAX_SAFE_INTEGER,rapAlignement:r=!0}=s;let a=s.nbSamples??s.nbSamplesPerFragment??1e3;const n=s.nbSamplesPerFragment??a;if(a<=0||n<=0||i<=0)return void m.error("ISOFile",`Invalid segment options: nbSamples=${a}, nbSamplesPerFragment=${n}, sizePerSegment=${i}`);if(a<n&&(m.warn("ISOFile",`nbSamples (${a}) is less than nbSamplesPerFragment (${n}), setting nbSamples to nbSamplesPerFragment`),a=n),this.fragmentedTracks.some((t=>t.nb_samples!==a)))return void m.error("ISOFile",`Cannot set segment options for track ${t}: nbSamples (${a}) does not match existing tracks`);const o=this.getTrackById(t);if(o){const s={id:t,user:e,trak:o,segmentStream:void 0,nb_samples:a,nb_samples_per_fragment:n,size_per_segment:i,rapAlignement:r,state:{lastFragmentSampleNumber:0,lastSegmentSampleNumber:0,accumulatedSize:0}};this.fragmentedTracks.push(s),o.nextSample=0}this.discardMdatData&&m.warn("ISOFile","Segmentation options set but discardMdatData is true, samples will not be segmented")}unsetSegmentOptions(t){let e=-1;for(let s=0;s<this.fragmentedTracks.length;s++){this.fragmentedTracks[s].id===t&&(e=s)}e>-1&&this.fragmentedTracks.splice(e,1)}setExtractionOptions(t,e,{nbSamples:s=1e3}={}){const i=this.getTrackById(t);i&&(this.extractedTracks.push({id:t,user:e,trak:i,nb_samples:s,samples:[]}),i.nextSample=0),this.discardMdatData&&m.warn("ISOFile","Extraction options set but discardMdatData is true, samples will not be extracted")}unsetExtractionOptions(t){let e=-1;for(let s=0;s<this.extractedTracks.length;s++){this.extractedTracks[s].id===t&&(e=s)}e>-1&&this.extractedTracks.splice(e,1)}parse(){if(!this.restoreParsePosition||this.restoreParsePosition())for(;;){if(this.hasIncompleteMdat&&this.hasIncompleteMdat()){if(this.processIncompleteMdat())continue;return}{this.saveParsePosition&&this.saveParsePosition();const t=D(this.stream,false);if(0===t.code){if(this.processIncompleteBox){if(this.processIncompleteBox(t))continue;return}return}if(1===t.code){const e=t.box;if(this.boxes.push(e),"uuid"===e.type)void 0!==this[e.uuid]&&m.warn("ISOFile","Duplicate Box of uuid: "+e.uuid+", overriding previous occurrence"),this[e.uuid]=e;else switch(e.type){case"mdat":this.mdats.push(e),this.transferMdatData(e);break;case"moof":this.moofs.push(e);break;case"free":case"skip":break;case"moov":this.moovStartFound=!0,0===this.mdats.length&&(this.isProgressive=!0);default:void 0!==this[e.type]?Array.isArray(this[e.type+"s"])?(m.info("ISOFile",`Found multiple boxes of type ${e.type} in ISOFile, adding to array`),this[e.type+"s"].push(e)):(m.warn("ISOFile",`Found multiple boxes of type ${e.type} but no array exists. Creating array dynamically.`),this[e.type+"s"]=[this[e.type],e]):(this[e.type]=e,Array.isArray(this[e.type+"s"])&&this[e.type+"s"].push(e))}this.updateUsedBytes&&this.updateUsedBytes(e,t)}else if(-1===t.code){m.error("ISOFile",`Invalid data found while parsing box of type '${t.type}' at position ${t.start}. Aborting parsing.`,this);break}}}}checkBuffer(t){if(!t)throw new Error("Buffer must be defined and non empty");return 0===t.byteLength?(m.warn("ISOFile","Ignoring empty buffer (fileStart: "+t.fileStart+")"),this.stream.logBufferLevel(),!1):(m.info("ISOFile","Processing buffer (fileStart: "+t.fileStart+")"),t.usedBytes=0,this.stream.insertBuffer(t),this.stream.logBufferLevel(),!!this.stream.initialized()||(m.warn("ISOFile","Not ready to start parsing"),!1))}appendBuffer(t,e){let s;if(this.checkBuffer(t))return this.parse(),this.moovStartFound&&!this.moovStartSent&&(this.moovStartSent=!0,this.onMoovStart&&this.onMoovStart()),this.moov?(this.sampleListBuilt||(this.buildSampleLists(),this.sampleListBuilt=!0),this.updateSampleLists(),this.onReady&&!this.readySent&&(this.readySent=!0,this.onReady(this.getInfo())),this.processSamples(e),this.nextSeekPosition?(s=this.nextSeekPosition,this.nextSeekPosition=void 0):s=this.nextParsePosition,this.stream.getEndFilePositionAfter&&(s=this.stream.getEndFilePositionAfter(s))):s=this.nextParsePosition?this.nextParsePosition:0,this.sidx&&this.onSidx&&!this.sidxSent&&(this.onSidx(this.sidx),this.sidxSent=!0),this.meta&&(this.flattenItemInfo&&!this.itemListBuilt&&(this.flattenItemInfo(),this.itemListBuilt=!0),this.processItems&&this.processItems(this.onItem)),this.stream.cleanBuffers&&(m.info("ISOFile","Done processing buffer (fileStart: "+t.fileStart+") - next buffer to fetch should have a fileStart position of "+s),this.stream.logBufferLevel(),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0),m.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize())),s}getFragmentDuration(){const t=this.getBox("mvex");if(!t)return;if(t.mehd)return{num:t.mehd.fragment_duration,den:this.moov.mvhd.timescale};const e=this.getBoxes("trak",!1);let s={num:0,den:1};for(const t of e){const e=t.samples_duration,i=t.mdia.mdhd.timescale;if(e&&i){e/i>s.num/s.den&&(s={num:e,den:i})}}return s}getInfo(){if(!this.moov)return{hasMoov:!1,mime:""};const t=new Date("1904-01-01T00:00:00Z").getTime(),e=void 0!==this.getBox("mvex"),s={hasMoov:!0,duration:this.moov.mvhd.duration,timescale:this.moov.mvhd.timescale,isFragmented:e,fragment_duration:this.getFragmentDuration(),isProgressive:this.isProgressive,hasIOD:void 0!==this.moov.iods,brands:[this.ftyp.major_brand].concat(this.ftyp.compatible_brands),created:new Date(t+1e3*this.moov.mvhd.creation_time),modified:new Date(t+1e3*this.moov.mvhd.modification_time),tracks:[],audioTracks:[],videoTracks:[],subtitleTracks:[],metadataTracks:[],hintTracks:[],otherTracks:[],mime:""};for(let e=0;e<this.moov.traks.length;e++){const i=this.moov.traks[e],r=i.mdia.minf.stbl.stsd.entries[0],a=i.samples_size,n=i.mdia.mdhd.timescale,o=i.samples_duration,h={samples_duration:o,bitrate:8*a*n/o,size:a,timescale:n,alternate_group:i.tkhd.alternate_group,codec:r.getCodec(),created:new Date(t+1e3*i.tkhd.creation_time),cts_shift:i.mdia.minf.stbl.cslg,duration:i.mdia.mdhd.duration,id:i.tkhd.track_id,kind:i.udta&&i.udta.kinds.length?i.udta.kinds[0]:{schemeURI:"",value:""},language:i.mdia.elng?i.mdia.elng.extended_language:i.mdia.mdhd.languageString,layer:i.tkhd.layer,matrix:i.tkhd.matrix,modified:new Date(t+1e3*i.tkhd.modification_time),movie_duration:i.tkhd.duration,movie_timescale:s.timescale,name:i.mdia.hdlr.name,nb_samples:i.samples.length,references:[],track_height:i.tkhd.height/65536,track_width:i.tkhd.width/65536,volume:i.tkhd.volume};if(s.tracks.push(h),i.tref)for(let t=0;t<i.tref.references.length;t++)h.references.push({type:i.tref.references[t].type,track_ids:i.tref.references[t].track_ids});i.edts&&(h.edits=i.edts.elst.entries),r instanceof G?(h.type="audio",s.audioTracks.push(h),h.audio={sample_rate:r.getSampleRate(),channel_count:r.getChannelCount(),sample_size:r.getSampleSize()}):r instanceof V?(h.type="video",s.videoTracks.push(h),h.video={width:r.getWidth(),height:r.getHeight()}):r instanceof N?(h.type="subtitles",s.subtitleTracks.push(h)):r instanceof M?(h.type="metadata",s.hintTracks.push(h)):r instanceof O?(h.type="metadata",s.metadataTracks.push(h)):(h.type="metadata",s.otherTracks.push(h))}s.videoTracks&&s.videoTracks.length>0?s.mime+='video/mp4; codecs="':s.audioTracks&&s.audioTracks.length>0?s.mime+='audio/mp4; codecs="':s.mime+='application/mp4; codecs="';for(let t=0;t<s.tracks.length;t++)0!==t&&(s.mime+=","),s.mime+=s.tracks[t].codec;return s.mime+='"; profiles="',s.mime+=this.ftyp.compatible_brands.join(),s.mime+='"',s}setNextSeekPositionFromSample(t){t&&(this.nextSeekPosition?this.nextSeekPosition=Math.min(t.offset+t.alreadyRead,this.nextSeekPosition):this.nextSeekPosition=t.offset+t.alreadyRead)}processSamples(t){if(this.sampleProcessingStarted){if(this.isFragmentationInitialized&&void 0!==this.onSegment){const e=new Set;for(;e.size<this.fragmentedTracks.length&&this.fragmentedTracks.some((t=>t.trak.nextSample<t.trak.samples.length))&&this.sampleProcessingStarted;)for(const s of this.fragmentedTracks){const i=s.trak;if(!e.has(s.id)){const r=i.nextSample<i.samples.length?this.getSample(i,i.nextSample):void 0;if(!r){this.setNextSeekPositionFromSample(i.samples[i.nextSample]),e.add(s.id);continue}s.state.accumulatedSize+=r.size;const a=i.nextSample+1,n=a-s.state.lastFragmentSampleNumber>s.nb_samples_per_fragment,o=a-s.state.lastSegmentSampleNumber>s.nb_samples;let h=n||a%s.nb_samples_per_fragment==0,d=o||a%s.nb_samples==0,c=s.state.accumulatedSize>=s.size_per_segment;const l=!s.rapAlignement||r.is_sync,p=t||i.nextSample+1>=i.samples.length;if(p&&!l&&m.warn("ISOFile","Flushing track #"+s.id+" at sample #"+i.nextSample+" which is not a RAP, this may lead to playback issues"),h=h&&l,d=d&&l,c=c&&l,h||c||p){n?m.warn("ISOFile","Fragment on track #"+s.id+" is overdue, creating it with samples ["+s.state.lastFragmentSampleNumber+", "+i.nextSample+"]"):m.debug("ISOFile","Creating media fragment on track #"+s.id+" for samples ["+s.state.lastFragmentSampleNumber+", "+i.nextSample+"]");const t=this.createFragment(s.id,s.state.lastFragmentSampleNumber,i.nextSample,s.segmentStream);if(!t){e.add(s.id);continue}s.segmentStream=t,s.state.lastFragmentSampleNumber=i.nextSample+1}(d||c||p)&&(o?m.warn("ISOFile","Segment on track #"+s.id+" is overdue, sending it with samples ["+Math.max(0,i.nextSample-s.nb_samples)+", "+(i.nextSample-1)+"]"):m.info("ISOFile","Sending fragmented data on track #"+s.id+" for samples ["+Math.max(0,i.nextSample-s.nb_samples)+", "+(i.nextSample-1)+"]"),m.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize()),this.onSegment&&this.onSegment(s.id,s.user,s.segmentStream.buffer,i.nextSample+1,t||i.nextSample+1>=i.samples.length),s.segmentStream=void 0,s.state.accumulatedSize=0,s.state.lastSegmentSampleNumber=i.nextSample+1),i.nextSample++}}}if(void 0!==this.onSamples)for(let t=0;t<this.extractedTracks.length;t++){const e=this.extractedTracks[t],s=e.trak;for(;s.nextSample<s.samples.length&&this.sampleProcessingStarted;){m.debug("ISOFile","Exporting on track #"+e.id+" sample #"+s.nextSample);const i=this.getSample(s,s.nextSample);if(!i){this.setNextSeekPositionFromSample(s.samples[s.nextSample]);break}if(s.nextSample++,e.samples.push(i),(s.nextSample%e.nb_samples==0||s.nextSample>=s.samples.length)&&(m.debug("ISOFile","Sending samples on track #"+e.id+" for sample "+s.nextSample),this.onSamples&&this.onSamples(e.id,e.user,e.samples),e.samples=[],e!==this.extractedTracks[t]))break}}}}getBox(t){const e=this.getBoxes(t,!0);return e.length?e[0]:void 0}getBoxes(t,e){const s=[],i=r=>{r instanceof g&&r.type&&r.type===t&&s.push(r);const a=[];r.boxes&&a.push(...r.boxes),r.entries&&a.push(...r.entries),r.item_infos&&a.push(...r.item_infos),r.references&&a.push(...r.references);for(const t of a){if(s.length&&e)return;i(t)}};return i(this),s}getTrackSamplesInfo(t){const e=this.getTrackById(t);if(e)return e.samples}getTrackSample(t,e){const s=this.getTrackById(t);return this.getSample(s,e)}releaseUsedSamples(t,e){let s=0;const i=this.getTrackById(t);i.lastValidSample||(i.lastValidSample=0);for(let t=i.lastValidSample;t<e;t++)s+=this.releaseSample(i,t);m.info("ISOFile","Track #"+t+" released samples up to "+e+" (released size: "+s+", remaining: "+this.samplesDataSize+")"),i.lastValidSample=e}start(){this.sampleProcessingStarted=!0,this.processSamples(!1)}stop(){this.sampleProcessingStarted=!1}flush(){m.info("ISOFile","Flushing remaining samples"),this.updateSampleLists(),this.processSamples(!0),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0)}seekTrack(t,e,s){let i,r=0,a=0;if(0===s.samples.length)return m.info("ISOFile","No sample in track, cannot seek! Using time "+m.getDurationString(0,1)+" and offset: 0"),{offset:0,time:0};for(let n=0;n<s.samples.length;n++){const o=s.samples[n];if(0===n)a=0,i=o.timescale;else if(o.cts>t*o.timescale){a=n-1;break}e&&o.is_sync&&(r=n)}for(e&&(a=r),t=s.samples[a].cts,s.nextSample=a;s.samples[a].alreadyRead===s.samples[a].size&&s.samples[a+1];)a++;const n=s.samples[a].offset+s.samples[a].alreadyRead;return m.info("ISOFile","Seeking to "+(e?"RAP":"")+" sample #"+s.nextSample+" on track "+s.tkhd.track_id+", time "+m.getDurationString(t,i)+" and offset: "+n),{offset:n,time:t/i}}getTrackDuration(t){if(!t.samples)return 1/0;const e=t.samples[t.samples.length-1];return(e.cts+e.duration)/e.timescale}seek(t,e){const s=this.moov;let i={offset:1/0,time:1/0};if(this.moov){for(let r=0;r<s.traks.length;r++){const a=s.traks[r];if(t>this.getTrackDuration(a))continue;const n=this.seekTrack(t,e,a);n.offset<i.offset&&(i.offset=n.offset),n.time<i.time&&(i.time=n.time)}return m.info("ISOFile","Seeking at time "+m.getDurationString(i.time,1)+" needs a buffer with a fileStart position of "+i.offset),i.offset===1/0?i={offset:this.nextParsePosition,time:0}:i.offset=this.stream.getEndFilePositionAfter(i.offset),m.info("ISOFile","Adjusted seek position (after checking data already in buffer): "+i.offset),i}throw new Error("Cannot seek: moov not received!")}equal(t){let e=0;for(;e<this.boxes.length&&e<t.boxes.length;){if(!k(this.boxes[e],t.boxes[e]))return!1;e++}return!0}write(t){for(let e=0;e<this.boxes.length;e++)this.boxes[e].write(t)}createFragment(t,e,s,i){const r=[];for(let i=e;i<=s;i++){const e=this.getTrackById(t),s=this.getSample(e,i);if(!s)return void this.setNextSeekPositionFromSample(e.samples[i]);r.push(s)}const a=i||new l,n=this.createMoof(r);n.write(a),n.trafs[0].truns[0].data_offset=n.size+8,m.debug("MP4Box","Adjusting data_offset with new value "+n.trafs[0].truns[0].data_offset),a.adjustUint32(n.trafs[0].truns[0].data_offset_position,n.trafs[0].truns[0].data_offset);const o=new Y;o.stream=new _;let h=0;for(const t of r)if(t.data){const e=d.fromArrayBuffer(t.data.buffer,h);o.stream.insertBuffer(e),h+=t.data.byteLength}return o.write(a),a}static writeInitializationSegment(t,e,s){m.debug("ISOFile","Generating initialization segment");const i=new l;t.write(i);const r=e.addBox(new ct);if(s){r.addBox(new Ht).fragment_duration=s}for(let t=0;t<e.traks.length;t++){const s=r.addBox(new _s);s.track_id=e.traks[t].tkhd.track_id,s.default_sample_description_index=1,s.default_sample_duration=e.traks[t].samples[0]?.duration??0,s.default_sample_size=0,s.default_sample_flags=65536}return e.write(i),i.buffer}save(t){const e=new l;return e.isofile=this,this.write(e),e.save(t)}getBuffer(){const t=new l;return t.isofile=this,this.write(t),t}initializeSegmentation(){this.onSegment||m.warn("MP4Box","No segmentation callback set!"),this.isFragmentationInitialized||(this.isFragmentationInitialized=!0,this.resetTables());const e=new it;e.addBox(this.moov.mvhd);for(let t=0;t<this.fragmentedTracks.length;t++){const s=this.getTrackById(this.fragmentedTracks[t].id);s?e.addBox(s):m.warn("ISOFile",`Track with id ${this.fragmentedTracks[t].id} not found, skipping fragmentation initialization`)}return{tracks:e.traks.map(((t,e)=>({id:t.tkhd.track_id,user:this.fragmentedTracks[e].user}))),buffer:t.writeInitializationSegment(this.ftyp,e,this.moov?.mvex?.mehd.fragment_duration)}}resetTables(){this.initial_duration=this.moov.mvhd.duration,this.moov.mvhd.duration=0;for(let t=0;t<this.moov.traks.length;t++){const e=this.moov.traks[t];e.tkhd.duration=0,e.mdia.mdhd.duration=0;(e.mdia.minf.stbl.stco||e.mdia.minf.stbl.co64).chunk_offsets=[];const s=e.mdia.minf.stbl.stsc;s.first_chunk=[],s.samples_per_chunk=[],s.sample_description_index=[];(e.mdia.minf.stbl.stsz||e.mdia.minf.stbl.stz2).sample_sizes=[];const i=e.mdia.minf.stbl.stts;i.sample_counts=[],i.sample_deltas=[];const r=e.mdia.minf.stbl.ctts;r&&(r.sample_counts=[],r.sample_offsets=[]);const a=e.mdia.minf.stbl.stss,n=e.mdia.minf.stbl.boxes.indexOf(a);-1!==n&&(e.mdia.minf.stbl.boxes[n]=void 0)}}static initSampleGroups(t,e,s,i,r){e&&(e.sample_groups_info=[]),t.sample_groups_info||(t.sample_groups_info=[]);for(let a=0;a<s.length;a++){const n=s[a].grouping_type+"/"+s[a].grouping_type_parameter,o=new ys(s[a].grouping_type,s[a].grouping_type_parameter,s[a]);e&&(e.sample_groups_info[n]=o),t.sample_groups_info[n]||(t.sample_groups_info[n]=o);for(let t=0;t<i.length;t++)i[t].grouping_type===s[a].grouping_type&&(o.description=i[t],o.description.used=!0);if(r)for(let t=0;t<r.length;t++)r[t].grouping_type===s[a].grouping_type&&(o.fragment_description=r[t],o.fragment_description.used=!0,o.is_fragment=!0)}if(e){if(r)for(let t=0;t<r.length;t++)if(!r[t].used&&r[t].version>=2){const s=r[t].grouping_type+"/0",i=new ys(r[t].grouping_type,0);i.is_fragment=!0,e.sample_groups_info[s]||(e.sample_groups_info[s]=i)}}else for(let e=0;e<i.length;e++)if(!i[e].used&&i[e].version>=2){const s=i[e].grouping_type+"/0",r=new ys(i[e].grouping_type,0);t.sample_groups_info[s]||(t.sample_groups_info[s]=r)}}static setSampleGroupProperties(t,e,s,i){e.sample_groups=[];for(const t in i)if(e.sample_groups[t]={grouping_type:i[t].grouping_type,grouping_type_parameter:i[t].grouping_type_parameter},s>=i[t].last_sample_in_run&&(i[t].last_sample_in_run<0&&(i[t].last_sample_in_run=0),i[t].entry_index++,i[t].entry_index<=i[t].sbgp.entries.length-1&&(i[t].last_sample_in_run+=i[t].sbgp.entries[i[t].entry_index].sample_count)),i[t].entry_index<=i[t].sbgp.entries.length-1?e.sample_groups[t].group_description_index=i[t].sbgp.entries[i[t].entry_index].group_description_index:e.sample_groups[t].group_description_index=-1,0!==e.sample_groups[t].group_description_index){let s;if(s=i[t].fragment_description?i[t].fragment_description:i[t].description,e.sample_groups[t].group_description_index>0){let i;i=e.sample_groups[t].group_description_index>65535?(e.sample_groups[t].group_description_index>>16)-1:e.sample_groups[t].group_description_index-1,s&&i>=0&&(e.sample_groups[t].description=s.entries[i])}else s&&s.version>=2&&s.default_group_description_index>0&&(e.sample_groups[t].description=s.entries[s.default_group_description_index-1])}}static process_sdtp(t,e,s){e&&(t?(e.is_leading=t.is_leading[s],e.depends_on=t.sample_depends_on[s],e.is_depended_on=t.sample_is_depended_on[s],e.has_redundancy=t.sample_has_redundancy[s]):(e.is_leading=0,e.depends_on=0,e.is_depended_on=0,e.has_redundancy=0))}buildSampleLists(){for(let t=0;t<this.moov.traks.length;t++)this.buildTrakSampleLists(this.moov.traks[t])}buildTrakSampleLists(e){let s,i,r,a,n,o;e.samples=[],e.samples_duration=0,e.samples_size=0;const h=e.mdia.minf.stbl.stco||e.mdia.minf.stbl.co64,d=e.mdia.minf.stbl.stsc,c=e.mdia.minf.stbl.stsz||e.mdia.minf.stbl.stz2,l=e.mdia.minf.stbl.stts,p=e.mdia.minf.stbl.ctts,u=e.mdia.minf.stbl.stss,f=e.mdia.minf.stbl.stsd,m=e.mdia.minf.stbl.subs,_=e.mdia.minf.stbl.stdp,g=e.mdia.minf.stbl.sbgps,x=e.mdia.minf.stbl.sgpds;let b=-1,y=-1,U=-1,w=-1,S=0,v=0,B=0;if(t.initSampleGroups(e,void 0,g,x),void 0!==c){for(s=0;s<c.sample_sizes.length;s++){const z={number:s,track_id:e.tkhd.track_id,timescale:e.mdia.mdhd.timescale,alreadyRead:0,size:c.sample_sizes[s]};e.samples[s]=z,e.samples_size+=z.size,0===s?(r=1,i=0,z.chunk_index=r,z.chunk_run_index=i,o=d.samples_per_chunk[i],n=0,a=i+1<d.first_chunk.length?d.first_chunk[i+1]-1:1/0):s<o?(z.chunk_index=r,z.chunk_run_index=i):(r++,z.chunk_index=r,n=0,r<=a||(i++,a=i+1<d.first_chunk.length?d.first_chunk[i+1]-1:1/0),z.chunk_run_index=i,o+=d.samples_per_chunk[i]),z.description_index=d.sample_description_index[z.chunk_run_index]-1,z.description=f.entries[z.description_index],z.offset=h.chunk_offsets[z.chunk_index-1]+n,n+=z.size,s>b&&(y++,b<0&&(b=0),b+=l.sample_counts[y]),s>0?(e.samples[s-1].duration=l.sample_deltas[y],e.samples_duration+=e.samples[s-1].duration,z.dts=e.samples[s-1].dts+e.samples[s-1].duration):z.dts=0,p?(s>=U&&(w++,U<0&&(U=0),U+=p.sample_counts[w]),z.cts=e.samples[s].dts+p.sample_offsets[w]):z.cts=z.dts,u?(s===u.sample_numbers[S]-1?(z.is_sync=!0,S++):(z.is_sync=!1,z.degradation_priority=0),m&&m.entries[v].sample_delta+B===s+1&&(z.subsamples=m.entries[v].subsamples,B+=m.entries[v].sample_delta,v++)):z.is_sync=!0,t.process_sdtp(e.mdia.minf.stbl.sdtp,z,z.number),z.degradation_priority=_?_.priority[s]:0,m&&m.entries[v].sample_delta+B===s&&(z.subsamples=m.entries[v].subsamples,B+=m.entries[v].sample_delta),(g.length>0||x.length>0)&&t.setSampleGroupProperties(e,z,s,e.sample_groups_info)}s>0&&(e.samples[s-1].duration=Math.max(e.mdia.mdhd.duration-e.samples[s-1].dts,0),e.samples_duration+=e.samples[s-1].duration)}}updateSampleLists(){let e,s,i,d,c;if(void 0!==this.moov)for(;this.lastMoofIndex<this.moofs.length;){const l=this.moofs[this.lastMoofIndex];if(this.lastMoofIndex++,"moof"===l.type){const p=l;for(let l=0;l<p.trafs.length;l++){const u=p.trafs[l],f=this.getTrackById(u.tfhd.track_id),m=this.getTrexById(u.tfhd.track_id);e=2&u.tfhd.flags?u.tfhd.default_sample_description_index:m?m.default_sample_description_index:1,s=8&u.tfhd.flags?u.tfhd.default_sample_duration:m?m.default_sample_duration:0,i=16&u.tfhd.flags?u.tfhd.default_sample_size:m?m.default_sample_size:0,d=32&u.tfhd.flags?u.tfhd.default_sample_flags:m?m.default_sample_flags:0,u.sample_number=0,u.sbgps.length>0&&t.initSampleGroups(f,u,u.sbgps,f.mdia.minf.stbl.sgpds,u.sgpds);for(let l=0;l<u.truns.length;l++){const m=u.truns[l];for(let _=0;_<m.sample_count;_++){const g=e-1;let x=d;m.flags&o?x=m.sample_flags[_]:0===_&&4&m.flags&&(x=m.first_sample_flags);let b=i;m.flags&n&&(b=m.sample_size[_]),f.samples_size+=b;let y,U=s;m.flags&a&&(U=m.sample_duration[_]),f.samples_duration+=U,f.first_traf_merged||_>0?y=f.samples[f.samples.length-1].dts+f.samples[f.samples.length-1].duration:(y=u.tfdt?u.tfdt.baseMediaDecodeTime:0,f.first_traf_merged=!0);let w=y;m.flags&h&&(w=y+m.sample_composition_time_offset[_]);const S=!!(1&u.tfhd.flags),v=!!(u.tfhd.flags&r),B=!!(1&m.flags);let z,k=0;k=S?u.tfhd.base_data_offset:v||0===l?p.start:c,z=0===l&&0===_?B?k+m.data_offset:k:c,c=z+b;const I=u.sample_number;u.sample_number++;const E={cts:w,description_index:g,description:f.mdia.minf.stbl.stsd.entries[g],dts:y,duration:U,moof_number:this.lastMoofIndex,number_in_traf:I,number:f.samples.length,offset:z,size:b,timescale:f.mdia.mdhd.timescale,track_id:f.tkhd.track_id,is_sync:!(x>>16&1),is_leading:x>>26&3,depends_on:x>>24&3,is_depended_on:x>>22&3,has_redundancy:x>>20&3,degradation_priority:65535&x};u.first_sample_index=f.samples.length,f.samples.push(E),(u.sbgps.length>0||u.sgpds.length>0||f.mdia.minf.stbl.sbgps.length>0||f.mdia.minf.stbl.sgpds.length>0)&&t.setSampleGroupProperties(f,E,E.number_in_traf,u.sample_groups_info)}}if(u.subs){f.has_fragment_subsamples=!0;let t=u.first_sample_index;for(let e=0;e<u.subs.entries.length;e++){t+=u.subs.entries[e].sample_delta;f.samples[t-1].subsamples=u.subs.entries[e].subsamples}}}}}}getSample(t,e){const s=t.samples[e];if(this.moov){if(s.data){if(s.alreadyRead===s.size)return s}else s.data=new Uint8Array(s.size),s.alreadyRead=0,this.samplesDataSize+=s.size,m.debug("ISOFile","Allocating sample #"+e+" on track #"+t.tkhd.track_id+" of size "+s.size+" (total: "+this.samplesDataSize+")");for(;;){let t,i,r=this.stream,a=r.findPosition(!0,s.offset+s.alreadyRead,!1);if(a>-1)t=r.buffers[a],i=t.fileStart;else for(const e of this.mdats)if(e.stream){if(a=e.stream.findPosition(!0,s.offset+s.alreadyRead-e.start-e.hdr_size,!1),a>-1){r=e.stream,t=e.stream.buffers[a],i=e.start+e.hdr_size+t.fileStart;break}}else m.debug("ISOFile","mdat stream not yet fully read for #"+this.mdats.indexOf(e)+" mdat");if(!t)return;{const a=t.byteLength-(s.offset+s.alreadyRead-i);if(s.size-s.alreadyRead<=a)return m.debug("ISOFile","Getting sample #"+e+" data (alreadyRead: "+s.alreadyRead+" offset: "+(s.offset+s.alreadyRead-i)+" read size: "+(s.size-s.alreadyRead)+" full size: "+s.size+")"),l.memcpy(s.data.buffer,s.alreadyRead,t,s.offset+s.alreadyRead-i,s.size-s.alreadyRead),t.usedBytes+=s.size-s.alreadyRead,r.logBufferLevel(),s.alreadyRead=s.size,s;if(0===a)return;m.debug("ISOFile","Getting sample #"+e+" partial data (alreadyRead: "+s.alreadyRead+" offset: "+(s.offset+s.alreadyRead-i)+" read size: "+a+" full size: "+s.size+")"),l.memcpy(s.data.buffer,s.alreadyRead,t,s.offset+s.alreadyRead-i,a),s.alreadyRead+=a,t.usedBytes+=a,r.logBufferLevel()}}}}releaseSample(t,e){const s=t.samples[e];return s.data?(this.samplesDataSize-=s.size,s.data=void 0,s.alreadyRead=0,s.size):0}getAllocatedSampleDataSize(){return this.samplesDataSize}getCodecs(){let t="";for(let e=0;e<this.moov.traks.length;e++){e>0&&(t+=","),t+=this.moov.traks[e].mdia.minf.stbl.stsd.entries[0].getCodec()}return t}getTrexById(t){if(this.moov&&this.moov.mvex)for(let e=0;e<this.moov.mvex.trexs.length;e++){const s=this.moov.mvex.trexs[e];if(s.track_id===t)return s}}getTrackById(t){if(this.moov)for(let e=0;e<this.moov.traks.length;e++){const s=this.moov.traks[e];if(s.tkhd.track_id===t)return s}}flattenItemInfo(){const t=this.items,e=this.entity_groups,s=this.meta;if(s&&s.hdlr&&s.iinf){for(let e=0;e<s.iinf.item_infos.length;e++){const i=s.iinf.item_infos[e].item_ID;t[i]={id:i,name:s.iinf.item_infos[e].item_name,ref_to:[],content_type:s.iinf.item_infos[e].content_type,content_encoding:s.iinf.item_infos[e].content_encoding,item_uri_type:s.iinf.item_infos[e].item_uri_type,type:s.iinf.item_infos[e].item_type?s.iinf.item_infos[e].item_type:"mime",protection:s.iinf.item_infos[e].item_protection_index>0?s.ipro.protections[s.iinf.item_infos[e].item_protection_index-1]:void 0}}if(s.grpl)for(let t=0;t<s.grpl.boxes.length;t++){const i=s.grpl.boxes[t];e[i.group_id]={id:i.group_id,entity_ids:i.entity_ids,type:i.type}}if(s.iloc)for(let e=0;e<s.iloc.items.length;e++){const i=s.iloc.items[e],r=t[i.item_ID];0!==i.data_reference_index&&(m.warn("Item storage with reference to other files: not supported"),r.source=s.dinf.boxes[i.data_reference_index-1]),r.extents=[],r.size=0;for(let t=0;t<i.extents.length;t++)r.extents[t]={offset:i.extents[t].extent_offset+i.base_offset,length:i.extents[t].extent_length,alreadyRead:0},1===i.construction_method&&(r.extents[t].offset+=s.idat.start+s.idat.hdr_size),r.size+=r.extents[t].length}if(s.pitm&&(t[s.pitm.item_id].primary=!0),s.iref)for(let e=0;e<s.iref.references.length;e++){const i=s.iref.references[e];for(let e=0;e<i.references.length;e++)t[i.from_item_ID].ref_to.push({type:i.type,id:i.references[e]})}if(s.iprp)for(let i=0;i<s.iprp.ipmas.length;i++){const r=s.iprp.ipmas[i];for(let i=0;i<r.associations.length;i++){const a=r.associations[i],n=t[a.id]??e[a.id];if(n){void 0===n.properties&&(n.properties={boxes:[]});for(let t=0;t<a.props.length;t++){const e=a.props[t];if(e.property_index>0&&e.property_index-1<s.iprp.ipco.boxes.length){const t=s.iprp.ipco.boxes[e.property_index-1];n.properties[t.type]=t,n.properties.boxes.push(t)}}}}}}}getItem(t){if(!this.meta)return;const e=this.items[t];if(!e.data&&e.size)e.data=new Uint8Array(e.size),e.alreadyRead=0,this.itemsDataSize+=e.size,m.debug("ISOFile","Allocating item #"+t+" of size "+e.size+" (total: "+this.itemsDataSize+")");else if(e.alreadyRead===e.size)return e;for(let s=0;s<e.extents.length;s++){const i=e.extents[s];if(i.alreadyRead!==i.length){const r=this.stream.findPosition(!0,i.offset+i.alreadyRead,!1);if(!(r>-1))return;{const a=this.stream.buffers[r],n=a.byteLength-(i.offset+i.alreadyRead-a.fileStart);if(!(i.length-i.alreadyRead<=n))return m.debug("ISOFile","Getting item #"+t+" extent #"+s+" partial data (alreadyRead: "+i.alreadyRead+" offset: "+(i.offset+i.alreadyRead-a.fileStart)+" read size: "+n+" full extent size: "+i.length+" full item size: "+e.size+")"),l.memcpy(e.data.buffer,e.alreadyRead,a,i.offset+i.alreadyRead-a.fileStart,n),i.alreadyRead+=n,e.alreadyRead+=n,this.parsingMdat&&!this.discardMdatData||(a.usedBytes+=n),void this.stream.logBufferLevel();m.debug("ISOFile","Getting item #"+t+" extent #"+s+" data (alreadyRead: "+i.alreadyRead+" offset: "+(i.offset+i.alreadyRead-a.fileStart)+" read size: "+(i.length-i.alreadyRead)+" full extent size: "+i.length+" full item size: "+e.size+")"),l.memcpy(e.data.buffer,e.alreadyRead,a,i.offset+i.alreadyRead-a.fileStart,i.length-i.alreadyRead),this.parsingMdat&&!this.discardMdatData||(a.usedBytes+=i.length-i.alreadyRead),this.stream.logBufferLevel(),e.alreadyRead+=i.length-i.alreadyRead,i.alreadyRead=i.length}}}return e.alreadyRead===e.size?e:void 0}releaseItem(t){const e=this.items[t];if(e.data){this.itemsDataSize-=e.size,e.data=void 0,e.alreadyRead=0;for(let t=0;t<e.extents.length;t++){e.extents[t].alreadyRead=0}return e.size}return 0}processItems(t){for(const e in this.items){const s=this.items[e];this.getItem(s.id),t&&!s.sent&&(t(s),s.sent=!0,s.data=void 0)}}hasItem(t){for(const e in this.items){const s=this.items[e];if(s.name===t)return s.id}return-1}getMetaHandler(){if(this.meta)return this.meta.hdlr.handler}getPrimaryItem(){if(this.meta&&this.meta.pitm)return this.getItem(this.meta.pitm.item_id)}itemToFragmentedTrackFile({itemId:e}={}){let s;if(s=e?this.getItem(e):this.getPrimaryItem(),!s)return;const i=new t;i.discardMdatData=!1;const r={type:s.type,description_boxes:s.properties.boxes};s.properties.ispe&&(r.width=s.properties.ispe.image_width,r.height=s.properties.ispe.image_height);const a=i.addTrack(r);return a?(i.addSample(a,s.data),i):void 0}processIncompleteBox(t){if("mdat"===t.type){const e=new Y(t.size);this.parsingMdat=e,this.boxes.push(e),this.mdats.push(e),e.start=t.start,e.hdr_size=t.hdr_size,e.original_size=t.original_size,this.stream.addUsedBytes(e.hdr_size),this.lastBoxStartPosition=e.start+e.size;return this.stream.seek(e.start+e.size,!1,this.discardMdatData)?(this.transferMdatData(),this.parsingMdat=void 0,!0):(this.moovStartFound?this.nextParsePosition=this.stream.findEndContiguousBuf():this.nextParsePosition=e.start+e.size,!1)}"moov"===t.type&&(this.moovStartFound=!0,0===this.mdats.length&&(this.isProgressive=!0));return!!this.stream.mergeNextBuffer&&this.stream.mergeNextBuffer()?(this.nextParsePosition=this.stream.getEndPosition(),!0):(t.type?this.moovStartFound?this.nextParsePosition=this.stream.getEndPosition():this.nextParsePosition=this.stream.getPosition()+t.size:this.nextParsePosition=this.stream.getEndPosition(),!1)}hasIncompleteMdat(){return void 0!==this.parsingMdat}transferMdatData(t){const e=t??this.parsingMdat;if(this.discardMdatData)return void m.debug("ISOFile","Discarding 'mdat' data, not transferring it to the mdat box stream");if(!e)return void m.warn("ISOFile","Cannot transfer 'mdat' data, no mdat box is being parsed");const s=this.stream.findPosition(!0,e.start+e.hdr_size,!1),i=this.stream.findPosition(!0,e.start+e.size,!1);if(-1===s||-1===i)return console.trace(e,s,i),void m.warn("ISOFile","Cannot transfer 'mdat' data, start or end buffer not found");e.stream=new _;for(let t=s;t<=i;t++){const r=this.stream.buffers[t],a=t===s?e.start+e.hdr_size-r.fileStart:0,n=t===i?e.start+e.size-r.fileStart:r.byteLength;if(n>a){m.debug("ISOFile","Transferring 'mdat' data from buffer #"+t+" ("+a+" to "+n+")");const s=n-a,i=new d(s),o=e.stream.getAbsoluteEndPosition();l.memcpy(i,0,r,a,s),i.fileStart=o,e.stream.insertBuffer(i),r.usedBytes+=s}}}processIncompleteMdat(){const t=this.parsingMdat;return this.stream.seek(t.start+t.size,!1,this.discardMdatData)?(m.debug("ISOFile","Found 'mdat' end in buffered data"),this.transferMdatData(),this.parsingMdat=void 0,!0):(this.nextParsePosition=this.stream.findEndContiguousBuf(),!1)}restoreParsePosition(){return this.stream.seek(this.lastBoxStartPosition,!0,this.discardMdatData)}saveParsePosition(){this.lastBoxStartPosition=this.stream.getPosition()}updateUsedBytes(t,e){this.stream.addUsedBytes&&("mdat"===t.type?(this.stream.addUsedBytes(t.hdr_size),this.discardMdatData&&this.stream.addUsedBytes(t.size-t.hdr_size)):this.stream.addUsedBytes(t.size))}addBox(t){return g.prototype.addBox.call(this,t)}init(t={}){const e=this.addBox(new Tt);e.major_brand=t.brands&&t.brands[0]||"iso4",e.minor_version=0,e.compatible_brands=t.brands||["iso4"];const s=this.addBox(new it);s.addBox(new ct);const i=s.addBox(new qt);return i.timescale=t.timescale||600,i.rate=t.rate||65536,i.creation_time=0,i.modification_time=0,i.duration=t.duration||0,i.volume=t.width?0:256,i.matrix=[65536,0,0,0,65536,0,0,0,1073741824],i.next_track_id=1,this}addTrack(t={}){this.moov||this.init(t);const e=t||{};e.width=e.width||320,e.height=e.height||320,e.id=e.id||this.moov.mvhd.next_track_id,e.type=e.type||"avc1";const s=this.moov.addBox(new rt);this.moov.mvhd.next_track_id=e.id+1;const i=s.addBox(new ms);i.flags=7,i.creation_time=0,i.modification_time=0,i.track_id=e.id,i.duration=e.duration||0,i.layer=e.layer||0,i.alternate_group=0,i.volume=1,i.matrix=[65536,0,0,0,65536,0,0,0,1073741824],i.width=e.width<<16,i.height=e.height<<16;const r=s.addBox(new nt),a=r.addBox(new Lt);a.creation_time=0,a.modification_time=0,a.timescale=e.timescale||1,a.duration=e.media_duration||0,a.language=e.language||"und";const n=r.addBox(new Ft);n.handler=e.hdlr||"vide",n.name=e.name||"Track created with MP4Box.js";r.addBox(new Ct).extended_language=e.language||"fr-FR";const o=r.addBox(new ot),h=C.sampleEntry[e.type];if(!h)return;const d=new h;if(d.data_reference_index=1,d instanceof V){const t=d,s=o.addBox(new bs);if(s.graphicsmode=0,s.opcolor=[0,0,0],t.width=e.width,t.height=e.height,t.horizresolution=72<<16,t.vertresolution=72<<16,t.frame_count=1,t.compressorname=e.type+" Compressor",t.depth=24,e.avcDecoderConfigRecord){t.addBox(new q(e.avcDecoderConfigRecord.byteLength)).parse(new l(e.avcDecoderConfigRecord))}else if(e.hevcDecoderConfigRecord){t.addBox(new Dt(e.hevcDecoderConfigRecord.byteLength)).parse(new l(e.hevcDecoderConfigRecord))}}else if(d instanceof G){const t=d;o.addBox(new ns).balance=e.balance||0,t.channel_count=e.channel_count||2,t.samplesize=e.samplesize||16,t.samplerate=e.samplerate||65536}else d instanceof M?o.addBox(new Q):d instanceof N?(o.addBox(new hs),d instanceof Xe&&(d.namespace=e.namespace||"nonamespace",d.schema_location=e.schema_location||"",d.auxiliary_mime_types=e.auxiliary_mime_types||"")):o.addBox(new X);e.description&&d.addBox.call(d,e.description),e.description_boxes&&e.description_boxes.forEach((function(t){d.addBox.call(d,t)}));const c=o.addBox(new ht).addBox(new At),p=new xs;p.flags=1,c.addEntry(p);const u=o.addBox(new dt);u.addBox(new cs).addEntry(d);const f=u.addBox(new ps);f.sample_counts=[],f.sample_deltas=[];const m=u.addBox(new ds);m.first_chunk=[],m.samples_per_chunk=[],m.sample_description_index=[];u.addBox(new os).chunk_offsets=[];u.addBox(new ls).sample_sizes=[];const _=this.moov.mvex.addBox(new _s);return _.track_id=e.id,_.default_sample_description_index=e.default_sample_description_index||1,_.default_sample_duration=e.default_sample_duration||0,_.default_sample_size=e.default_sample_size||0,_.default_sample_flags=e.default_sample_flags||0,this.buildTrakSampleLists(s),e.id}addSample(t,e,{sample_description_index:s,duration:i=1,cts:r=0,dts:a=0,is_sync:n=!1,is_leading:o=0,depends_on:h=0,is_depended_on:d=0,has_redundancy:c=0,degradation_priority:l=0,subsamples:p,offset:u=0}={}){const f=this.getTrackById(t);if(void 0===f)return;const m=s?s-1:0,_={number:f.samples.length,track_id:f.tkhd.track_id,timescale:f.mdia.mdhd.timescale,description_index:m,description:f.mdia.minf.stbl.stsd.entries[m],data:e,size:e.byteLength,alreadyRead:e.byteLength,duration:i,cts:r,dts:a,is_sync:n,is_leading:o,depends_on:h,is_depended_on:d,has_redundancy:c,degradation_priority:l,offset:u,subsamples:p};f.samples.push(_),f.samples_size+=_.size,f.samples_duration+=_.duration,void 0===f.first_dts&&(f.first_dts=a),this.processSamples();const g=this.addBox(this.createMoof([_]));g.computeSize(),g.trafs[0].truns[0].data_offset=g.size+8;return this.addBox(new Y).data=new Uint8Array(e),_}createMoof(t){if(0===t.length)return;if(t.some((e=>e.track_id!==t[0].track_id)))throw new Error("Cannot create moof for samples from different tracks: "+t.map((t=>t.track_id)).join(", "));const e=t[0].track_id,s=this.getTrackById(e);if(!s)throw new Error("Cannot create moof for non-existing track: "+e);const i=new lt;i.addBox(new $t).sequence_number=++this.nextMoofNumber;const a=i.addBox(new pt),n=a.addBox(new fs);n.track_id=e,n.flags=r;a.addBox(new us).baseMediaDecodeTime=t[0].dts-(s.first_dts||0);const o=a.addBox(new gs);o.flags=3841,o.data_offset=0,o.first_sample_flags=0,o.sample_count=t.length;for(const e of t){let t=0;t=e.is_sync?1<<25:65536,o.sample_duration.push(e.duration),o.sample_size.push(e.size),o.sample_flags.push(t),o.sample_composition_time_offset.push(e.cts-e.dts)}return i}print(t){t.indent="";for(let e=0;e<this.boxes.length;e++)this.boxes[e]&&this.boxes[e].print(t)}};function ws(t=!1,e){return new Us(e,!t)}var Ss={};e(Ss,{Descriptor:()=>Is,ES_Descriptor:()=>Es,MPEG4DescriptorParser:()=>Cs});var vs=3,Bs=4,zs=5,ks=6,Is=class t{constructor(t,e){this.tag=t,this.size=e,this.descs=[]}parse(t){this.data=t.readUint8Array(this.size)}findDescriptor(t){for(let e=0;e<this.descs.length;e++)if(this.descs[e].tag===t)return this.descs[e]}parseOneDescriptor(e){let s=0;const i=e.readUint8();let r=e.readUint8();for(;128&r;)s=(s<<7)+(127&r),r=e.readUint8();s=(s<<7)+(127&r),m.debug("Descriptor","Found "+(As[i]||"Descriptor "+i)+", size "+s+" at position "+e.getPosition());const a=As[i]?new Ps[As[i]](s):new t(s);return a.parse(e),a}parseRemainingDescriptors(t){const e=t.getPosition();for(;t.getPosition()<e+this.size;){const e=this.parseOneDescriptor?.(t);this.descs.push(e)}}},Es=class extends Is{constructor(t){super(3,t)}parse(t){if(this.ES_ID=t.readUint16(),this.flags=t.readUint8(),this.size-=3,128&this.flags?(this.dependsOn_ES_ID=t.readUint16(),this.size-=2):this.dependsOn_ES_ID=0,64&this.flags){const e=t.readUint8();this.URL=t.readString(e),this.size-=e+1}else this.URL="";32&this.flags?(this.OCR_ES_ID=t.readUint16(),this.size-=2):this.OCR_ES_ID=0,this.parseRemainingDescriptors(t)}getOTI(){const t=this.findDescriptor(4);return t?t.oti:0}getAudioConfig(){const t=this.findDescriptor(4);if(!t)return;const e=t.findDescriptor(5);if(e&&e.data){let t=(248&e.data[0])>>3;return 31===t&&e.data.length>=2&&(t=32+((7&e.data[0])<<3)+((224&e.data[1])>>5)),t}}},Ps={Descriptor:Is,ES_Descriptor:Es,DecoderConfigDescriptor:class extends Is{constructor(t){super(4,t)}parse(t){this.oti=t.readUint8(),this.streamType=t.readUint8(),this.upStream=!!(this.streamType>>1&1),this.streamType=this.streamType>>>2,this.bufferSize=t.readUint24(),this.maxBitrate=t.readUint32(),this.avgBitrate=t.readUint32(),this.size-=13,this.parseRemainingDescriptors(t)}},DecoderSpecificInfo:class extends Is{constructor(t){super(5,t)}},SLConfigDescriptor:class extends Is{constructor(t){super(6,t)}}},As={[vs]:"ES_Descriptor",[Bs]:"DecoderConfigDescriptor",[zs]:"DecoderSpecificInfo",[ks]:"SLConfigDescriptor"},Cs=class{constructor(){this.parseOneDescriptor=Is.prototype.parseOneDescriptor}getDescriptorName(t){return As[t]}},Ts=class{parseSample(t){const e=[],s=new _(d.fromArrayBuffer(t.buffer,0));for(;!s.isEof();){const t=D(s,!1);1===t.code&&"vttc"===t.box?.type&&e.push(t.box)}return e}getText(t,e,s){function i(t,e){const s=t.toString();return s.length>=e?s:new Array(e-s.length+1).join("0")+s}function r(t){const e=Math.floor(t/3600),s=Math.floor((t-3600*e)/60),r=Math.floor(t-3600*e-60*s),a=Math.floor(1e3*(t-3600*e-60*s-r));return i(e,2)+":"+i(s,2)+":"+i(r,2)+"."+i(a,3)}const a=this.parseSample(s);let n="";for(let s=0;s<a.length;s++){const i=a[s];n+=r(t)+" --\x3e "+r(e)+"\r\n",n+=i.payl.text}return n}},Fs=class{parseSample(t){const e={resources:[],documentString:"",document:void 0},s=new l(t.data.buffer);if(t.subsamples&&0!==t.subsamples.length){if(e.documentString=s.readString(t.subsamples[0].size),t.subsamples.length>1)for(let i=1;i<t.subsamples.length;i++)e.resources[i]=s.readUint8Array(t.subsamples[i].size)}else e.documentString=s.readString(t.data.length);return"undefined"!=typeof DOMParser&&(e.document=(new DOMParser).parseFromString(e.documentString,"application/xml")),e}},Ds=class{parseSample(t){return new l(t.data.buffer).readString(t.data.length)}parseConfig(t){const e=new l(t.buffer);e.readUint32();return e.readCString()}},Ls=class{parseSample(t){const e=new l(t.data.buffer),s=e.readUint16();if(0!==s)return e.readString(s)}},Hs={};e(Hs,{CoLLBox:()=>Js,ItemContentIDPropertyBox:()=>Ea,OpusSampleEntry:()=>He,SmDmBox:()=>zr,a1lxBox:()=>Ms,a1opBox:()=>Os,ac_3SampleEntry:()=>Fe,ac_4SampleEntry:()=>De,aebrBox:()=>_i,afbrBox:()=>gi,albcBox:()=>xi,alstSampleGroupEntry:()=>ia,altrBox:()=>bi,auxCBox:()=>Ns,av01SampleEntry:()=>ne,av1CBox:()=>Kt,avc1SampleEntry:()=>se,avc2SampleEntry:()=>ie,avc3SampleEntry:()=>re,avc4SampleEntry:()=>ae,avcCBox:()=>q,avllSampleGroupEntry:()=>ra,avs3SampleEntry:()=>ze,avssSampleGroupEntry:()=>aa,brstBox:()=>yi,btrtBox:()=>Rs,bxmlBox:()=>et,ccstBox:()=>Vs,cdefBox:()=>Gs,clapBox:()=>js,clefBox:()=>dr,clliBox:()=>$s,cmexBox:()=>qs,cminBox:()=>Ys,cmpdBox:()=>Ws,co64Box:()=>Ks,colrBox:()=>Zt,coviBox:()=>Zs,cprtBox:()=>ti,cschBox:()=>ei,cslgBox:()=>ii,cttsBox:()=>ri,dOpsBox:()=>li,dac3Box:()=>ai,dataBox:()=>lr,dav1SampleEntry:()=>oe,dec3Box:()=>ni,dfLaBox:()=>oi,dimmBox:()=>hi,dinfBox:()=>ht,dmax:()=>di,dmedBox:()=>ci,dobrBox:()=>Ui,drefBox:()=>At,drepBox:()=>pi,dtrtSampleGroupEntry:()=>na,dvh1SampleEntry:()=>_e,dvheSampleEntry:()=>ge,ec_3SampleEntry:()=>Le,edtsBox:()=>at,elngBox:()=>Ct,elstBox:()=>ui,emsgBox:()=>fi,encaSampleEntry:()=>je,encmSampleEntry:()=>Ke,encsSampleEntry:()=>qe,enctSampleEntry:()=>We,encuSampleEntry:()=>$e,encvSampleEntry:()=>Ge,enofBox:()=>pr,eqivBox:()=>wi,esdsBox:()=>Jt,etypBox:()=>Et,fLaCSampleEntry:()=>Ve,favcBox:()=>Si,fielBox:()=>Ti,fobrBox:()=>vi,freeBox:()=>K,frmaBox:()=>Fi,ftypBox:()=>Tt,grplBox:()=>kt,hdlrBox:()=>Ft,hev1SampleEntry:()=>le,hev2SampleEntry:()=>pe,hinfBox:()=>gt,hmhdBox:()=>Q,hntiBox:()=>_t,hvc1SampleEntry:()=>de,hvc2SampleEntry:()=>ce,hvcCBox:()=>Dt,hvt1SampleEntry:()=>ue,iaugBox:()=>Bi,idatBox:()=>W,iinfBox:()=>Ot,ilocBox:()=>Nt,ilstBox:()=>ur,imirBox:()=>Di,infeBox:()=>Mt,iodsBox:()=>Z,ipcoBox:()=>zt,ipmaBox:()=>Li,iproBox:()=>st,iprpBox:()=>Bt,irefBox:()=>Vt,irotBox:()=>Hi,ispeBox:()=>Mi,itaiBox:()=>Oi,j2kHBox:()=>It,j2kiSampleEntry:()=>ke,keysBox:()=>fr,kindBox:()=>Ni,levaBox:()=>Ri,lhe1SampleEntry:()=>fe,lhv1SampleEntry:()=>me,lhvCBox:()=>Vi,lselBox:()=>Gi,m4aeSampleEntry:()=>Te,maxrBox:()=>ji,mdatBox:()=>Y,mdcvBox:()=>qi,mdhdBox:()=>Lt,mdiaBox:()=>nt,mecoBox:()=>mt,mehdBox:()=>Ht,metaBox:()=>jt,mettSampleEntry:()=>Yt,metxSampleEntry:()=>Wt,mfhdBox:()=>$t,mfraBox:()=>ft,mfroBox:()=>Yi,mha1SampleEntry:()=>Me,mha2SampleEntry:()=>Oe,mhm1SampleEntry:()=>Ne,mhm2SampleEntry:()=>Re,minfBox:()=>ot,mjp2SampleEntry:()=>Ie,mjpgSampleEntry:()=>Ee,moofBox:()=>lt,moovBox:()=>it,mp4aSampleEntry:()=>Ce,mp4sSampleEntry:()=>Ye,mp4vSampleEntry:()=>Ae,mskCBox:()=>Wi,msrcTrackGroupTypeBox:()=>$r,mvexBox:()=>ct,mvhdBox:()=>qt,mvifSampleGroupEntry:()=>oa,nmhdBox:()=>X,npckBox:()=>Ki,numpBox:()=>Ji,padbBox:()=>Xi,panoBox:()=>zi,paspBox:()=>Zi,paylBox:()=>tr,paytBox:()=>er,pdinBox:()=>sr,piffLsmBox:()=>Sa,piffPsshBox:()=>va,piffSencBox:()=>Ba,piffTencBox:()=>za,piffTfrfBox:()=>ka,piffTfxdBox:()=>Ia,pitmBox:()=>Gt,pixiBox:()=>ir,pmaxBox:()=>rr,povdBox:()=>Pt,prdiBox:()=>ar,prfrBox:()=>nr,prftBox:()=>or,prgrBox:()=>Ai,profBox:()=>mr,prolSampleGroupEntry:()=>ha,psshBox:()=>hr,pymdBox:()=>Ci,rapSampleGroupEntry:()=>da,rashSampleGroupEntry:()=>ca,resvSampleEntry:()=>Je,rinfBox:()=>Ut,rollSampleGroupEntry:()=>la,rtp_Box:()=>xr,saioBox:()=>br,saizBox:()=>yr,sbgpBox:()=>ss,sbpmBox:()=>wr,sbttSampleEntry:()=>Qe,schiBox:()=>wt,schmBox:()=>Sr,scifSampleGroupEntry:()=>pa,scnmSampleGroupEntry:()=>ua,sdp_Box:()=>vr,sdtpBox:()=>is,seigSampleGroupEntry:()=>fa,sencBox:()=>Br,sgpdBox:()=>rs,sidxBox:()=>as,sinfBox:()=>yt,skipBox:()=>J,slidBox:()=>ki,smhdBox:()=>ns,ssixBox:()=>kr,stblBox:()=>dt,stcoBox:()=>os,stdpBox:()=>Ir,sterBox:()=>Ii,sthdBox:()=>hs,stppSampleEntry:()=>Xe,strdBox:()=>bt,striBox:()=>Er,strkBox:()=>xt,stsaSampleGroupEntry:()=>ma,stscBox:()=>ds,stsdBox:()=>cs,stsgBox:()=>Pr,stshBox:()=>Ar,stssBox:()=>Cr,stszBox:()=>ls,sttsBox:()=>ps,stviBox:()=>Tr,stxtSampleEntry:()=>Ze,stypBox:()=>Fr,stz2Box:()=>Dr,subsBox:()=>Lr,syncSampleGroupEntry:()=>_a,taicBox:()=>Hr,taptBox:()=>_r,teleSampleGroupEntry:()=>ga,tencBox:()=>Mr,tfdtBox:()=>us,tfhdBox:()=>fs,tfraBox:()=>Or,tkhdBox:()=>ms,tmaxBox:()=>Nr,tminBox:()=>Rr,totlBox:()=>Vr,tpayBox:()=>Gr,tpylBox:()=>jr,trafBox:()=>pt,trakBox:()=>rt,trefBox:()=>qr,trepBox:()=>Yr,trexBox:()=>_s,trgrBox:()=>St,trpyBox:()=>Wr,trunBox:()=>gs,tsasSampleGroupEntry:()=>xa,tsclSampleGroupEntry:()=>ba,tselBox:()=>Kr,tsynBox:()=>Ei,tx3gSampleEntry:()=>ts,txtcBox:()=>Jr,tycoBox:()=>Qr,udesBox:()=>Xr,udtaBox:()=>vt,uncCBox:()=>Zr,uncvSampleEntry:()=>Pe,urlBox:()=>xs,urnBox:()=>ta,viprSampleGroupEntry:()=>ya,vmhdBox:()=>bs,vp08SampleEntry:()=>ve,vp09SampleEntry:()=>Be,vpcCBox:()=>Qt,vttCBox:()=>ea,vttcBox:()=>ut,vvc1SampleEntry:()=>be,vvcCBox:()=>Xt,vvcNSampleEntry:()=>we,vvi1SampleEntry:()=>ye,vvnCBox:()=>sa,vvs1SampleEntry:()=>Ue,waveBox:()=>gr,wbbrBox:()=>Pi,wvttSampleEntry:()=>es,xmlBox:()=>tt});var Ms=class extends g{constructor(){super(...arguments),this.box_name="AV1LayeredImageIndexingProperty"}static{this.fourcc="a1lx"}parse(t){const e=16*(1+(1&(1&t.readUint8())));this.layer_size=[];for(let s=0;s<3;s++)this.layer_size[s]=16===e?t.readUint16():t.readUint32()}},Os=class extends g{constructor(){super(...arguments),this.box_name="OperatingPointSelectorProperty"}static{this.fourcc="a1op"}parse(t){this.op_index=t.readUint8()}},Ns=class extends x{constructor(){super(...arguments),this.box_name="AuxiliaryTypeProperty"}static{this.fourcc="auxC"}parse(t){this.parseFullHeader(t),this.aux_type=t.readCString();const e=this.size-this.hdr_size-(this.aux_type.length+1);this.aux_subtype=t.readUint8Array(e)}},Rs=class extends g{constructor(){super(...arguments),this.box_name="BitRateBox"}static{this.fourcc="btrt"}parse(t){this.bufferSizeDB=t.readUint32(),this.maxBitrate=t.readUint32(),this.avgBitrate=t.readUint32()}},Vs=class extends x{constructor(){super(...arguments),this.box_name="CodingConstraintsBox"}static{this.fourcc="ccst"}parse(t){this.parseFullHeader(t);const e=t.readUint8();this.all_ref_pics_intra=!(128&~e),this.intra_pred_used=!(64&~e),this.max_ref_per_pic=(63&e)>>2,t.readUint24()}},Gs=class extends g{constructor(){super(...arguments),this.box_name="ComponentDefinitionBox"}static{this.fourcc="cdef"}parse(t){this.channel_count=t.readUint16(),this.channel_indexes=[],this.channel_types=[],this.channel_associations=[];for(let e=0;e<this.channel_count;e++)this.channel_indexes.push(t.readUint16()),this.channel_types.push(t.readUint16()),this.channel_associations.push(t.readUint16())}},js=class extends g{constructor(){super(...arguments),this.box_name="CleanApertureBox"}static{this.fourcc="clap"}parse(t){this.cleanApertureWidthN=t.readUint32(),this.cleanApertureWidthD=t.readUint32(),this.cleanApertureHeightN=t.readUint32(),this.cleanApertureHeightD=t.readUint32(),this.horizOffN=t.readUint32(),this.horizOffD=t.readUint32(),this.vertOffN=t.readUint32(),this.vertOffD=t.readUint32()}},$s=class extends g{constructor(){super(...arguments),this.box_name="ContentLightLevelBox"}static{this.fourcc="clli"}parse(t){this.max_content_light_level=t.readUint16(),this.max_pic_average_light_level=t.readUint16()}},qs=class extends g{constructor(){super(...arguments),this.box_name="CameraExtrinsicMatrixProperty"}static{this.fourcc="cmex"}parse(t){1&this.flags&&(this.pos_x=t.readInt32()),2&this.flags&&(this.pos_y=t.readInt32()),4&this.flags&&(this.pos_z=t.readInt32()),8&this.flags&&(0===this.version?16&this.flags?(this.quat_x=t.readInt32(),this.quat_y=t.readInt32(),this.quat_z=t.readInt32()):(this.quat_x=t.readInt16(),this.quat_y=t.readInt16(),this.quat_z=t.readInt16()):this.version),32&this.flags&&(this.id=t.readUint32())}},Ys=class extends g{constructor(){super(...arguments),this.box_name="CameraIntrinsicMatrixProperty"}static{this.fourcc="cmin"}parse(t){this.focal_length_x=t.readInt32(),this.principal_point_x=t.readInt32(),this.principal_point_y=t.readInt32(),1&this.flags&&(this.focal_length_y=t.readInt32(),this.skew_factor=t.readInt32())}},Ws=class extends g{constructor(){super(...arguments),this.box_name="ComponentDefinitionBox"}static{this.fourcc="cmpd"}parse(t){this.component_count=t.readUint32(),this.component_types=[],this.component_type_urls=[];for(let e=0;e<this.component_count;e++){const e=t.readUint16();this.component_types.push(e),e>=32768&&this.component_type_urls.push(t.readCString())}}},Ks=class extends x{constructor(){super(...arguments),this.box_name="ChunkLargeOffsetBox"}static{this.fourcc="co64"}parse(t){this.parseFullHeader(t);const e=t.readUint32();if(this.chunk_offsets=[],0===this.version)for(let s=0;s<e;s++)this.chunk_offsets.push(t.readUint64())}write(t){this.version=0,this.flags=0,this.size=4+8*this.chunk_offsets.length,this.writeHeader(t),t.writeUint32(this.chunk_offsets.length);for(let e=0;e<this.chunk_offsets.length;e++)t.writeUint64(this.chunk_offsets[e])}},Js=class extends x{constructor(){super(...arguments),this.box_name="ContentLightLevelBox"}static{this.fourcc="CoLL"}parse(t){this.parseFullHeader(t),this.maxCLL=t.readUint16(),this.maxFALL=t.readUint16()}},Qs=class{toString(){let t="centre_azimuth: ";return t+=this.centre_azimuth,t+=" (",t+=this.centre_azimuth*2**-16,t+="°), centre_elevation: ",t+=this.centre_elevation,t+=" (",t+=this.centre_elevation*2**-16,t+="°), centre_tilt: ",t+=this.centre_tilt,t+=" (",t+=this.centre_tilt*2**-16,t+="°)",this.range_included_flag&&(t+=", azimuth_range: ",t+=this.azimuth_range,t+=" (",t+=this.azimuth_range*2**-16,t+="°), elevation_range: ",t+=this.elevation_range,t+=" (",t+=this.elevation_range*2**-16,t+="°)"),this.interpolate_included_flag&&(t+=", interpolate: ",t+=this.interpolate),t}},Xs=class{toString(){let t="";return this.view_idc&&(t+="view_idc: ",t+=this.view_idc,t+=", "),t+="sphere_region: {",t+=this.sphere_region,t+="}",t}},Zs=class extends x{constructor(){super(...arguments),this.box_name="CoverageInformationBox"}static{this.fourcc="covi"}parse(t){this.parseFullHeader(t),this.coverage_shape_type=t.readUint8();const e=t.readUint8(),s=t.readInt8(),i=128&s;i&&(this.default_view_idc=(96&s)>>5),this.coverage_regions=new Array;for(let s=0;s<e;s++){const e=new Xs;i&&(e.view_idc=t.readUint8()>>6),e.sphere_region=this.parseSphereRegion(t,!0,!0),this.coverage_regions.push(e)}}parseSphereRegion(t,e,s){const i=new Qs;return i.centre_azimuth=t.readInt32(),i.centre_elevation=t.readInt32(),i.centre_tilt=t.readInt32(),i.range_included_flag=e,e&&(i.azimuth_range=t.readUint32(),i.elevation_range=t.readUint32()),i.interpolate_included_flag=s,s&&(i.interpolate=!(128&~t.readUint8())),i}},ti=class extends x{constructor(){super(...arguments),this.box_name="CopyrightBox"}static{this.fourcc="cprt"}parse(t){this.parseFullHeader(t),this.parseLanguage(t),this.notice=t.readCString()}},ei=class extends x{constructor(){super(...arguments),this.box_name="CompatibleSchemeTypeBox"}static{this.fourcc="csch"}parse(t){this.parseFullHeader(t),this.scheme_type=t.readString(4),this.scheme_version=t.readUint32(),1&this.flags&&(this.scheme_uri=t.readCString())}},si=2147483647,ii=class extends x{constructor(){super(...arguments),this.box_name="CompositionToDecodeBox"}static{this.fourcc="cslg"}parse(t){this.parseFullHeader(t),0===this.version?(this.compositionToDTSShift=t.readInt32(),this.leastDecodeToDisplayDelta=t.readInt32(),this.greatestDecodeToDisplayDelta=t.readInt32(),this.compositionStartTime=t.readInt32(),this.compositionEndTime=t.readInt32()):1===this.version&&(this.compositionToDTSShift=t.readInt64(),this.leastDecodeToDisplayDelta=t.readInt64(),this.greatestDecodeToDisplayDelta=t.readInt64(),this.compositionStartTime=t.readInt64(),this.compositionEndTime=t.readInt64())}write(t){this.version=0,(this.compositionToDTSShift>si||this.leastDecodeToDisplayDelta>si||this.greatestDecodeToDisplayDelta>si||this.compositionStartTime>si||this.compositionEndTime>si)&&(this.version=1),this.flags=0,0===this.version?(this.size=20,this.writeHeader(t),t.writeInt32(this.compositionToDTSShift),t.writeInt32(this.leastDecodeToDisplayDelta),t.writeInt32(this.greatestDecodeToDisplayDelta),t.writeInt32(this.compositionStartTime),t.writeInt32(this.compositionEndTime)):1===this.version&&(this.size=40,this.writeHeader(t),t.writeInt64(this.compositionToDTSShift),t.writeInt64(this.leastDecodeToDisplayDelta),t.writeInt64(this.greatestDecodeToDisplayDelta),t.writeInt64(this.compositionStartTime),t.writeInt64(this.compositionEndTime))}},ri=class extends x{constructor(){super(...arguments),this.box_name="CompositionOffsetBox"}static{this.fourcc="ctts"}parse(t){this.parseFullHeader(t);const e=t.readUint32();if(this.sample_counts=[],this.sample_offsets=[],0===this.version)for(let s=0;s<e;s++){this.sample_counts.push(t.readUint32());const e=t.readInt32();e<0&&m.warn("BoxParser","ctts box uses negative values without using version 1"),this.sample_offsets.push(e)}else if(1===this.version)for(let s=0;s<e;s++)this.sample_counts.push(t.readUint32()),this.sample_offsets.push(t.readInt32())}write(t){this.version=this.sample_offsets.some((t=>t<0))?1:0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(t),t.writeUint32(this.sample_counts.length);for(let e=0;e<this.sample_counts.length;e++)t.writeUint32(this.sample_counts[e]),1===this.version?t.writeInt32(this.sample_offsets[e]):t.writeUint32(this.sample_offsets[e])}unpack(t){let e=0;for(let s=0;s<this.sample_counts.length;s++)for(let i=0;i<this.sample_counts[s];i++)t[e].pts=t[e].dts+this.sample_offsets[s],e++}},ai=class extends g{constructor(){super(...arguments),this.box_name="AC3SpecificBox"}static{this.fourcc="dac3"}parse(t){const e=t.readUint8(),s=t.readUint8(),i=t.readUint8();this.fscod=e>>6,this.bsid=e>>1&31,this.bsmod=(1&e)<<2|s>>6&3,this.acmod=s>>3&7,this.lfeon=s>>2&1,this.bit_rate_code=3&s|i>>5&7}},ni=class extends g{constructor(){super(...arguments),this.box_name="EC3SpecificBox"}static{this.fourcc="dec3"}parse(t){const e=t.readUint16();this.data_rate=e>>3,this.num_ind_sub=7&e,this.ind_subs=[];for(let e=0;e<this.num_ind_sub+1;e++){const e=t.readUint8(),s=t.readUint8(),i=t.readUint8(),r={fscod:e>>6,bsid:e>>1&31,bsmod:(1&e)<<4|s>>4&15,acmod:s>>1&7,lfeon:1&s,num_dep_sub:i>>1&15};this.ind_subs.push(r),r.num_dep_sub>0&&(r.chan_loc=(1&i)<<8|t.readUint8())}}},oi=class extends x{constructor(){super(...arguments),this.box_name="FLACSpecificBox"}static{this.fourcc="dfLa"}parse(t){this.parseFullHeader(t);const e=[],s=["STREAMINFO","PADDING","APPLICATION","SEEKTABLE","VORBIS_COMMENT","CUESHEET","PICTURE","RESERVED"];let i;do{i=t.readUint8();const r=Math.min(127&i,s.length-1);r?t.readUint8Array(t.readUint24()):(t.readUint8Array(13),this.samplerate=t.readUint32()>>12,t.readUint8Array(20)),e.push(s[r])}while(128&i);this.numMetadataBlocks=e.length+" ("+e.join(", ")+")"}},hi=class extends g{constructor(){super(...arguments),this.box_name="hintimmediateBytesSent"}static{this.fourcc="dimm"}parse(t){this.bytessent=t.readUint64()}},di=class extends g{constructor(){super(...arguments),this.box_name="hintlongestpacket"}static{this.fourcc="dmax"}parse(t){this.time=t.readUint32()}},ci=class extends g{constructor(){super(...arguments),this.box_name="hintmediaBytesSent"}static{this.fourcc="dmed"}parse(t){this.bytessent=t.readUint64()}},li=class extends g{constructor(){super(...arguments),this.box_name="OpusSpecificBox"}static{this.fourcc="dOps"}parse(t){if(this.Version=t.readUint8(),this.OutputChannelCount=t.readUint8(),this.PreSkip=t.readUint16(),this.InputSampleRate=t.readUint32(),this.OutputGain=t.readInt16(),this.ChannelMappingFamily=t.readUint8(),0!==this.ChannelMappingFamily){this.StreamCount=t.readUint8(),this.CoupledCount=t.readUint8(),this.ChannelMapping=[];for(let e=0;e<this.OutputChannelCount;e++)this.ChannelMapping[e]=t.readUint8()}}write(t){if(this.size=11,0!==this.ChannelMappingFamily&&(this.size+=2+this.OutputChannelCount),this.writeHeader(t),t.writeUint8(this.Version),t.writeUint8(this.OutputChannelCount),t.writeUint16(this.PreSkip),t.writeUint32(this.InputSampleRate),t.writeInt16(this.OutputGain),t.writeUint8(this.ChannelMappingFamily),0!==this.ChannelMappingFamily){t.writeUint8(this.StreamCount),t.writeUint8(this.CoupledCount);for(let e=0;e<this.OutputChannelCount;e++)t.writeUint8(this.ChannelMapping[e])}}},pi=class extends g{constructor(){super(...arguments),this.box_name="hintrepeatedBytesSent"}static{this.fourcc="drep"}parse(t){this.bytessent=t.readUint64()}},ui=class extends x{constructor(){super(...arguments),this.box_name="EditListBox"}static{this.fourcc="elst"}parse(t){this.parseFullHeader(t),this.entries=[];const e=t.readUint32();for(let s=0;s<e;s++){const e={segment_duration:1===this.version?t.readUint64():t.readUint32(),media_time:1===this.version?t.readInt64():t.readInt32(),media_rate_integer:t.readInt16(),media_rate_fraction:t.readInt16()};this.entries.push(e)}}write(t){const e=this.entries.some((t=>t.segment_duration>i||t.media_time>i))||1===this.version;this.version=e?1:0,this.size=4+12*this.entries.length,this.size+=e?8*this.entries.length:0,this.writeHeader(t),t.writeUint32(this.entries.length);for(let s=0;s<this.entries.length;s++){const i=this.entries[s];e?(t.writeUint64(i.segment_duration),t.writeInt64(i.media_time)):(t.writeUint32(i.segment_duration),t.writeInt32(i.media_time)),t.writeInt16(i.media_rate_integer),t.writeInt16(i.media_rate_fraction)}}},fi=class extends x{constructor(){super(...arguments),this.box_name="EventMessageBox"}static{this.fourcc="emsg"}parse(t){this.parseFullHeader(t),1===this.version?(this.timescale=t.readUint32(),this.presentation_time=t.readUint64(),this.event_duration=t.readUint32(),this.id=t.readUint32(),this.scheme_id_uri=t.readCString(),this.value=t.readCString()):(this.scheme_id_uri=t.readCString(),this.value=t.readCString(),this.timescale=t.readUint32(),this.presentation_time_delta=t.readUint32(),this.event_duration=t.readUint32(),this.id=t.readUint32());let e=this.size-this.hdr_size-(16+(this.scheme_id_uri.length+1)+(this.value.length+1));1===this.version&&(e-=4),this.message_data=t.readUint8Array(e)}write(t){this.version=0,this.flags=0,this.size=16+this.message_data.length+(this.scheme_id_uri.length+1)+(this.value.length+1),this.writeHeader(t),t.writeCString(this.scheme_id_uri),t.writeCString(this.value),t.writeUint32(this.timescale),t.writeUint32(this.presentation_time_delta),t.writeUint32(this.event_duration),t.writeUint32(this.id),t.writeUint8Array(this.message_data)}},mi=class extends x{parse(t){this.parseFullHeader(t),this.group_id=t.readUint32(),this.num_entities_in_group=t.readUint32(),this.entity_ids=[];for(let e=0;e<this.num_entities_in_group;e++){const e=t.readUint32();this.entity_ids.push(e)}}},_i=class extends mi{constructor(){super(...arguments),this.box_name="Auto exposure bracketing"}static{this.fourcc="aebr"}},gi=class extends mi{constructor(){super(...arguments),this.box_name="Flash exposure information"}static{this.fourcc="afbr"}},xi=class extends mi{constructor(){super(...arguments),this.box_name="Album collection"}static{this.fourcc="albc"}},bi=class extends mi{constructor(){super(...arguments),this.box_name="Alternative entity"}static{this.fourcc="altr"}},yi=class extends mi{constructor(){super(...arguments),this.box_name="Burst image"}static{this.fourcc="brst"}},Ui=class extends mi{constructor(){super(...arguments),this.box_name="Depth of field bracketing"}static{this.fourcc="dobr"}},wi=class extends mi{constructor(){super(...arguments),this.box_name="Equivalent entity"}static{this.fourcc="eqiv"}},Si=class extends mi{constructor(){super(...arguments),this.box_name="Favorites collection"}static{this.fourcc="favc"}},vi=class extends mi{constructor(){super(...arguments),this.box_name="Focus bracketing"}static{this.fourcc="fobr"}},Bi=class extends mi{constructor(){super(...arguments),this.box_name="Image item with an audio track"}static{this.fourcc="iaug"}},zi=class extends mi{constructor(){super(...arguments),this.box_name="Panorama"}static{this.fourcc="pano"}},ki=class extends mi{constructor(){super(...arguments),this.box_name="Slideshow"}static{this.fourcc="slid"}},Ii=class extends mi{constructor(){super(...arguments),this.box_name="Stereo"}static{this.fourcc="ster"}},Ei=class extends mi{constructor(){super(...arguments),this.box_name="Time-synchronized capture"}static{this.fourcc="tsyn"}},Pi=class extends mi{constructor(){super(...arguments),this.box_name="White balance bracketing"}static{this.fourcc="wbbr"}},Ai=class extends mi{constructor(){super(...arguments),this.box_name="Progressive rendering"}static{this.fourcc="prgr"}},Ci=class extends mi{constructor(){super(...arguments),this.box_name="Image pyramid"}static{this.fourcc="pymd"}parse(t){this.parseFullHeader(t),this.group_id=t.readUint32(),this.num_entities_in_group=t.readUint32(),this.entity_ids=[];for(let e=0;e<this.num_entities_in_group;e++){const e=t.readUint32();this.entity_ids.push(e)}this.tile_size_x=t.readUint16(),this.tile_size_y=t.readUint16(),this.layer_binning=[],this.tiles_in_layer_column_minus1=[],this.tiles_in_layer_row_minus1=[];for(let e=0;e<this.num_entities_in_group;e++)this.layer_binning[e]=t.readUint16(),this.tiles_in_layer_row_minus1[e]=t.readUint16(),this.tiles_in_layer_column_minus1[e]=t.readUint16()}},Ti=class extends g{constructor(){super(...arguments),this.box_name="FieldHandlingBox"}static{this.fourcc="fiel"}parse(t){this.fieldCount=t.readUint8(),this.fieldOrdering=t.readUint8()}},Fi=class extends g{constructor(){super(...arguments),this.box_name="OriginalFormatBox"}static{this.fourcc="frma"}parse(t){this.data_format=t.readString(4)}},Di=class extends g{constructor(){super(...arguments),this.box_name="ImageMirror"}static{this.fourcc="imir"}parse(t){const e=t.readUint8();this.reserved=e>>7,this.axis=1&e}},Li=class extends x{constructor(){super(...arguments),this.box_name="ItemPropertyAssociationBox"}static{this.fourcc="ipma"}parse(t){this.parseFullHeader(t);const e=t.readUint32();this.associations=[];for(let s=0;s<e;s++){const e=this.version<1?t.readUint16():t.readUint32(),s=[],i=t.readUint8();for(let e=0;e<i;e++){const e=t.readUint8();s.push({essential:(128&e)>>7==1,property_index:1&this.flags?(127&e)<<8|t.readUint8():127&e})}this.associations.push({id:e,props:s})}}},Hi=class extends g{constructor(){super(...arguments),this.box_name="ImageRotation"}static{this.fourcc="irot"}parse(t){this.angle=3&t.readUint8()}},Mi=class extends x{constructor(){super(...arguments),this.box_name="ImageSpatialExtentsProperty"}static{this.fourcc="ispe"}parse(t){this.parseFullHeader(t),this.image_width=t.readUint32(),this.image_height=t.readUint32()}},Oi=class extends x{constructor(){super(...arguments),this.box_name="TAITimestampBox"}static{this.fourcc="itai"}parse(t){this.TAI_timestamp=t.readUint64();const e=t.readUint8();this.sychronization_state=e>>7&1,this.timestamp_generation_failure=e>>6&1,this.timestamp_is_modified=e>>5&1}},Ni=class extends x{constructor(){super(...arguments),this.box_name="KindBox"}static{this.fourcc="kind"}parse(t){this.parseFullHeader(t),this.schemeURI=t.readCString(),this.isEndOfBox(t)||(this.value=t.readCString())}write(t){this.version=0,this.flags=0,this.size=this.schemeURI.length+1+(this.value?this.value.length+1:0),this.writeHeader(t),t.writeCString(this.schemeURI),this.value&&t.writeCString(this.value)}},Ri=class extends x{constructor(){super(...arguments),this.box_name="LevelAssignmentBox"}static{this.fourcc="leva"}parse(t){this.parseFullHeader(t);const e=t.readUint8();this.levels=[];for(let s=0;s<e;s++){const e={};this.levels[s]=e,e.track_ID=t.readUint32();const i=t.readUint8();switch(e.padding_flag=i>>7,e.assignment_type=127&i,e.assignment_type){case 0:e.grouping_type=t.readString(4);break;case 1:e.grouping_type=t.readString(4),e.grouping_type_parameter=t.readUint32();break;case 2:case 3:break;case 4:e.sub_track_id=t.readUint32();break;default:m.warn("BoxParser",`Unknown level assignment type: ${e.assignment_type}`)}}}},Vi=class extends g{constructor(){super(...arguments),this.box_name="LHEVCConfigurationBox"}static{this.fourcc="lhvC"}parse(t){this.configurationVersion=t.readUint8(),this.min_spatial_segmentation_idc=4095&t.readUint16(),this.parallelismType=3&t.readUint8();let e=t.readUint8();this.numTemporalLayers=(13&e)>>3,this.temporalIdNested=(4&e)>>2,this.lengthSizeMinusOne=3&e,this.nalu_arrays=[];const s=t.readUint8();for(let i=0;i<s;i++){const s=[];this.nalu_arrays.push(s),e=t.readUint8(),s.completeness=(128&e)>>7,s.nalu_type=63&e;const i=t.readUint16();for(let e=0;e<i;e++){const e=t.readUint16();s.push({data:t.readUint8Array(e)})}}}},Gi=class extends g{constructor(){super(...arguments),this.box_name="LayerSelectorProperty"}static{this.fourcc="lsel"}parse(t){this.layer_id=t.readUint16()}},ji=class extends g{constructor(){super(...arguments),this.box_name="hintmaxrate"}static{this.fourcc="maxr"}parse(t){this.period=t.readUint32(),this.bytes=t.readUint32()}},$i=class{constructor(t,e){this.x=t,this.y=e}toString(){return"("+this.x+","+this.y+")"}},qi=class extends g{constructor(){super(...arguments),this.box_name="MasteringDisplayColourVolumeBox"}static{this.fourcc="mdcv"}parse(t){this.display_primaries=[],this.display_primaries[0]=new $i(t.readUint16(),t.readUint16()),this.display_primaries[1]=new $i(t.readUint16(),t.readUint16()),this.display_primaries[2]=new $i(t.readUint16(),t.readUint16()),this.white_point=new $i(t.readUint16(),t.readUint16()),this.max_display_mastering_luminance=t.readUint32(),this.min_display_mastering_luminance=t.readUint32()}},Yi=class extends x{constructor(){super(...arguments),this.box_name="MovieFragmentRandomAccessOffsetBox"}static{this.fourcc="mfro"}parse(t){this.parseFullHeader(t),this._size=t.readUint32()}},Wi=class extends x{constructor(){super(...arguments),this.box_name="MaskConfigurationProperty"}static{this.fourcc="mskC"}parse(t){this.parseFullHeader(t),this.bits_per_pixel=t.readUint8()}},Ki=class extends g{constructor(){super(...arguments),this.box_name="hintPacketsSent"}static{this.fourcc="npck"}parse(t){this.packetssent=t.readUint32()}},Ji=class extends g{constructor(){super(...arguments),this.box_name="hintPacketsSent"}static{this.fourcc="nump"}parse(t){this.packetssent=t.readUint64()}},Qi=class{constructor(t,e){this.pad1=t,this.pad2=e}},Xi=class extends x{constructor(){super(...arguments),this.box_name="PaddingBitsBox"}static{this.fourcc="padb"}parse(t){this.parseFullHeader(t);const e=t.readUint32();this.padbits=[];for(let s=0;s<Math.floor((e+1)/2);s++){const e=t.readUint8(),s=(112&e)>>4,i=7&e;this.padbits.push(new Qi(s,i))}}},Zi=class extends g{constructor(){super(...arguments),this.box_name="PixelAspectRatioBox"}static{this.fourcc="pasp"}parse(t){this.hSpacing=t.readUint32(),this.vSpacing=t.readUint32()}},tr=class extends g{constructor(){super(...arguments),this.box_name="CuePayloadBox"}static{this.fourcc="payl"}parse(t){this.text=t.readString(this.size-this.hdr_size)}},er=class extends g{constructor(){super(...arguments),this.box_name="hintpayloadID"}static{this.fourcc="payt"}parse(t){this.payloadID=t.readUint32();const e=t.readUint8();this.rtpmap_string=t.readString(e)}},sr=class extends x{constructor(){super(...arguments),this.box_name="ProgressiveDownloadInfoBox",this.rate=[],this.initial_delay=[]}static{this.fourcc="pdin"}parse(t){this.parseFullHeader(t);const e=(this.size-this.hdr_size)/8;for(let s=0;s<e;s++)this.rate[s]=t.readUint32(),this.initial_delay[s]=t.readUint32()}},ir=class extends x{constructor(){super(...arguments),this.box_name="PixelInformationProperty"}static{this.fourcc="pixi"}parse(t){this.parseFullHeader(t),this.num_channels=t.readUint8(),this.bits_per_channels=[];for(let e=0;e<this.num_channels;e++)this.bits_per_channels[e]=t.readUint8()}},rr=class extends g{constructor(){super(...arguments),this.box_name="hintlargestpacket"}static{this.fourcc="pmax"}parse(t){this.bytes=t.readUint32()}},ar=class extends x{constructor(){super(...arguments),this.box_name="ProgressiveDerivedImageItemInformationProperty"}static{this.fourcc="prdi"}parse(t){if(this.parseFullHeader(t),this.step_count=t.readUint16(),this.item_count=[],2&this.flags)for(let e=0;e<this.step_count;e++)this.item_count[e]=t.readUint16()}},nr=class extends x{constructor(){super(...arguments),this.box_name="ProjectionFormatBox"}static{this.fourcc="prfr"}parse(t){this.parseFullHeader(t),this.projection_type=31&t.readUint8()}},or=class extends x{constructor(){super(...arguments),this.box_name="ProducerReferenceTimeBox"}static{this.fourcc="prft"}parse(t){this.parseFullHeader(t),this.ref_track_id=t.readUint32(),this.ntp_timestamp=t.readUint64(),0===this.version?this.media_time=t.readUint32():this.media_time=t.readUint64()}},hr=class extends x{constructor(){super(...arguments),this.box_name="ProtectionSystemSpecificHeaderBox"}static{this.fourcc="pssh"}parse(t){if(this.parseFullHeader(t),this.system_id=F(t),this.version>0){const e=t.readUint32();this.kid=[];for(let s=0;s<e;s++)this.kid[s]=F(t)}const e=t.readUint32();e>0&&(this.protection_data=t.readUint8Array(e))}},dr=class extends x{constructor(){super(...arguments),this.box_name="TrackCleanApertureDimensionsBox"}static{this.fourcc="clef"}parse(t){this.parseFullHeader(t),this.width=t.readUint32(),this.height=t.readUint32()}};var cr,lr=class extends g{constructor(){super(...arguments),this.box_name="DataBox"}static{this.fourcc="data"}static{this.Types={RESERVED:0,UTF8:1,UTF16:2,SJIS:3,UTF8_SORT:4,UTF16_SORT:5,JPEG:13,PNG:14,BE_SIGNED_INT:21,BE_UNSIGNED_INT:22,BE_FLOAT32:23,BE_FLOAT64:24,BMP:27,QT_ATOM:28,BE_SIGNED_INT8:65,BE_SIGNED_INT16:66,BE_SIGNED_INT32:67,BE_FLOAT32_POINT:70,BE_FLOAT32_DIMENSIONS:71,BE_FLOAT32_RECT:72,BE_SIGNED_INT64:74,BE_UNSIGNED_INT8:75,BE_UNSIGNED_INT16:76,BE_UNSIGNED_INT32:77,BE_UNSIGNED_INT64:78,BE_FLOAT64_AFFINE_TRANSFORM:79}}parse(t){this.valueType=t.readUint32(),this.country=t.readUint16(),this.country>255&&(t.seek(t.getPosition()-2),this.countryString=t.readString(2)),this.language=t.readUint16(),this.language>255&&(t.seek(t.getPosition()-2),this.parseLanguage(t)),this.raw=t.readUint8Array(this.size-this.hdr_size-8),this.value=function(t,e){if(t===lr.Types.UTF8)return new TextDecoder("utf-8").decode(e);const s=new DataView(e.buffer);if(t===lr.Types.BE_UNSIGNED_INT){if(1===e.length)return s.getUint8(0);if(2===e.length)return s.getUint16(0,!1);if(4===e.length)return s.getUint32(0,!1);if(8===e.length)return s.getBigUint64(0,!1);throw new Error("Unsupported ITIF_TYPE_BE_UNSIGNED_INT length "+e.length)}if(t===lr.Types.BE_SIGNED_INT){if(1===e.length)return s.getInt8(0);if(2===e.length)return s.getInt16(0,!1);if(4===e.length)return s.getInt32(0,!1);if(8===e.length)return s.getBigInt64(0,!1);throw new Error("Unsupported ITIF_TYPE_BE_SIGNED_INT length "+e.length)}if(t===lr.Types.BE_FLOAT32)return s.getFloat32(0,!1);m.warn("DataBox","Unsupported or unimplemented itif data type: "+t)}(this.valueType,this.raw)}},pr=class extends x{constructor(){super(...arguments),this.box_name="TrackEncodedPixelsDimensionsBox"}static{this.fourcc="enof"}parse(t){this.parseFullHeader(t),this.width=t.readUint32(),this.height=t.readUint32()}},ur=class extends g{constructor(){super(...arguments),this.box_name="IlstBox"}static{this.fourcc="ilst"}parse(t){this.list={};let e=this.size-this.hdr_size;for(;e>0;){const s=t.readUint32(),i=t.readUint32(),r=D(t,!1,s-8);1===r.code&&(this.list[i]=r.box),e-=s}}},fr=class extends x{constructor(){super(...arguments),this.box_name="KeysBox"}static{this.fourcc="keys"}parse(t){this.parseFullHeader(t),this.count=t.readUint32(),this.keys={};for(let e=0;e<this.count;e++){const s=t.readUint32();this.keys[e+1]=t.readString(s-4)}}},mr=class extends x{constructor(){super(...arguments),this.box_name="TrackProductionApertureDimensionsBox"}static{this.fourcc="prof"}parse(t){this.parseFullHeader(t),this.width=t.readUint32(),this.height=t.readUint32()}},_r=class extends L{constructor(){super(...arguments),this.box_name="TrackApertureModeDimensionsBox",this.clefs=[],this.profs=[],this.enofs=[],this.subBoxNames=["clef","prof","enof"]}static{this.fourcc="tapt"}},gr=class extends L{constructor(){super(...arguments),this.box_name="siDecompressionParamBox"}static{this.fourcc="wave"}},xr=class extends g{constructor(){super(...arguments),this.box_name="rtpmoviehintinformation"}static{this.fourcc="rtp "}parse(t){this.descriptionformat=t.readString(4),this.sdptext=t.readString(this.size-this.hdr_size-4)}},br=class extends x{constructor(){super(...arguments),this.box_name="SampleAuxiliaryInformationOffsetsBox"}static{this.fourcc="saio"}parse(t){this.parseFullHeader(t),1&this.flags&&(this.aux_info_type=t.readString(4),this.aux_info_type_parameter=t.readUint32());const e=t.readUint32();this.offset=[];for(let s=0;s<e;s++)0===this.version?this.offset[s]=t.readUint32():this.offset[s]=t.readUint64()}},yr=class extends x{constructor(){super(...arguments),this.box_name="SampleAuxiliaryInformationSizesBox"}static{this.fourcc="saiz"}parse(t){if(this.parseFullHeader(t),1&this.flags&&(this.aux_info_type=t.readString(4),this.aux_info_type_parameter=t.readUint32()),this.default_sample_info_size=t.readUint8(),this.sample_count=t.readUint32(),this.sample_info_size=[],0===this.default_sample_info_size)for(let e=0;e<this.sample_count;e++)this.sample_info_size[e]=t.readUint8()}},Ur=class{constructor(t,e){this.bad_pixel_row=t,this.bad_pixel_column=e}toString(){return"[row: "+this.bad_pixel_row+", column: "+this.bad_pixel_column+"]"}},wr=class extends x{constructor(){super(...arguments),this.box_name="SensorBadPixelsMapBox"}static{this.fourcc="sbpm"}parse(t){this.parseFullHeader(t),this.component_count=t.readUint16(),this.component_index=[];for(let e=0;e<this.component_count;e++)this.component_index.push(t.readUint16());const e=t.readUint8();this.correction_applied=!(128&~e),this.num_bad_rows=t.readUint32(),this.num_bad_cols=t.readUint32(),this.num_bad_pixels=t.readUint32(),this.bad_rows=[],this.bad_columns=[],this.bad_pixels=[];for(let e=0;e<this.num_bad_rows;e++)this.bad_rows.push(t.readUint32());for(let e=0;e<this.num_bad_cols;e++)this.bad_columns.push(t.readUint32());for(let e=0;e<this.num_bad_pixels;e++){const e=t.readUint32(),s=t.readUint32();this.bad_pixels.push(new Ur(e,s))}}},Sr=class extends x{constructor(){super(...arguments),this.box_name="SchemeTypeBox"}static{this.fourcc="schm"}parse(t){this.parseFullHeader(t),this.scheme_type=t.readString(4),this.scheme_version=t.readUint32(),1&this.flags&&(this.scheme_uri=t.readString(this.size-this.hdr_size-8))}},vr=class extends g{constructor(){super(...arguments),this.box_name="rtptracksdphintinformation"}static{this.fourcc="sdp "}parse(t){this.sdptext=t.readString(this.size-this.hdr_size)}},Br=class extends x{constructor(){super(...arguments),this.box_name="SampleEncryptionBox"}static{this.fourcc="senc"}},zr=class extends x{constructor(){super(...arguments),this.box_name="SMPTE2086MasteringDisplayMetadataBox"}static{this.fourcc="SmDm"}parse(t){this.parseFullHeader(t),this.primaryRChromaticity_x=t.readUint16(),this.primaryRChromaticity_y=t.readUint16(),this.primaryGChromaticity_x=t.readUint16(),this.primaryGChromaticity_y=t.readUint16(),this.primaryBChromaticity_x=t.readUint16(),this.primaryBChromaticity_y=t.readUint16(),this.whitePointChromaticity_x=t.readUint16(),this.whitePointChromaticity_y=t.readUint16(),this.luminanceMax=t.readUint32(),this.luminanceMin=t.readUint32()}},kr=class extends x{constructor(){super(...arguments),this.box_name="CompressedSubsegmentIndexBox"}static{this.fourcc="ssix"}parse(t){this.parseFullHeader(t),this.subsegments=[];const e=t.readUint32();for(let s=0;s<e;s++){const e={};this.subsegments.push(e),e.ranges=[];const s=t.readUint32();for(let i=0;i<s;i++){const s={};e.ranges.push(s),s.level=t.readUint8(),s.range_size=t.readUint24()}}}},Ir=class extends x{constructor(){super(...arguments),this.box_name="DegradationPriorityBox"}static{this.fourcc="stpd"}parse(t){this.parseFullHeader(t);const e=(this.size-this.hdr_size)/2;this.priority=[];for(let s=0;s<e;s++)this.priority[s]=t.readUint16()}},Er=class extends x{constructor(){super(...arguments),this.box_name="SubTrackInformationBox"}static{this.fourcc="stri"}parse(t){this.parseFullHeader(t),this.switch_group=t.readUint16(),this.alternate_group=t.readUint16(),this.sub_track_id=t.readUint32();const e=(this.size-this.hdr_size-8)/4;this.attribute_list=[];for(let s=0;s<e;s++)this.attribute_list[s]=t.readUint32()}},Pr=class extends x{constructor(){super(...arguments),this.box_name="SubTrackSampleGroupBox"}static{this.fourcc="stsg"}parse(t){this.parseFullHeader(t),this.grouping_type=t.readUint32();const e=t.readUint16();this.group_description_index=[];for(let s=0;s<e;s++)this.group_description_index[s]=t.readUint32()}},Ar=class extends x{constructor(){super(...arguments),this.box_name="ShadowSyncSampleBox"}static{this.fourcc="stsh"}parse(t){this.parseFullHeader(t);const e=t.readUint32();if(this.shadowed_sample_numbers=[],this.sync_sample_numbers=[],0===this.version)for(let s=0;s<e;s++)this.shadowed_sample_numbers.push(t.readUint32()),this.sync_sample_numbers.push(t.readUint32())}write(t){this.version=0,this.flags=0,this.size=4+8*this.shadowed_sample_numbers.length,this.writeHeader(t),t.writeUint32(this.shadowed_sample_numbers.length);for(let e=0;e<this.shadowed_sample_numbers.length;e++)t.writeUint32(this.shadowed_sample_numbers[e]),t.writeUint32(this.sync_sample_numbers[e])}},Cr=class extends x{constructor(){super(...arguments),this.box_name="SyncSampleBox"}static{this.fourcc="stss"}parse(t){this.parseFullHeader(t);const e=t.readUint32();if(0===this.version){this.sample_numbers=[];for(let s=0;s<e;s++)this.sample_numbers.push(t.readUint32())}}write(t){this.version=0,this.flags=0,this.size=4+4*this.sample_numbers.length,this.writeHeader(t),t.writeUint32(this.sample_numbers.length),t.writeUint32Array(this.sample_numbers)}},Tr=class extends x{constructor(){super(...arguments),this.box_name="StereoVideoBox"}static{this.fourcc="stvi"}parse(t){this.parseFullHeader(t);const e=t.readUint32();this.single_view_allowed=3&e,this.stereo_scheme=t.readUint32();const s=t.readUint32();for(this.stereo_indication_type=t.readString(s),this.boxes=[];t.getPosition()<this.start+this.size;){const e=D(t,!1,this.size-(t.getPosition()-this.start));if(1!==e.code)return;{const t=e.box;this.boxes.push(t),this[t.type]=t}}}},Fr=class extends g{constructor(){super(...arguments),this.box_name="SegmentTypeBox"}static{this.fourcc="styp"}parse(t){let e=this.size-this.hdr_size;this.major_brand=t.readString(4),this.minor_version=t.readUint32(),e-=8,this.compatible_brands=[];let s=0;for(;e>=4;)this.compatible_brands[s]=t.readString(4),e-=4,s++}write(t){this.size=8+4*this.compatible_brands.length,this.writeHeader(t),t.writeString(this.major_brand,void 0,4),t.writeUint32(this.minor_version);for(let e=0;e<this.compatible_brands.length;e++)t.writeString(this.compatible_brands[e],void 0,4)}},Dr=class extends x{constructor(){super(...arguments),this.box_name="CompactSampleSizeBox"}static{this.fourcc="stz2"}parse(t){if(this.parseFullHeader(t),this.sample_sizes=[],0===this.version){this.reserved=t.readUint24(),this.field_size=t.readUint8();const e=t.readUint32();if(4===this.field_size)for(let s=0;s<e;s+=2){const e=t.readUint8();this.sample_sizes[s]=e>>4&15,this.sample_sizes[s+1]=15&e}else if(8===this.field_size)for(let s=0;s<e;s++)this.sample_sizes[s]=t.readUint8();else if(16===this.field_size)for(let s=0;s<e;s++)this.sample_sizes[s]=t.readUint16();else m.error("BoxParser","Error in length field in stz2 box",t.isofile)}}},Lr=class extends x{constructor(){super(...arguments),this.box_name="SubSampleInformationBox"}static{this.fourcc="subs"}parse(t){this.parseFullHeader(t);const e=t.readUint32();let s;this.entries=[];for(let i=0;i<e;i++){const e={};if(this.entries[i]=e,e.sample_delta=t.readUint32(),e.subsamples=[],s=t.readUint16(),s>0)for(let i=0;i<s;i++){const s={};e.subsamples.push(s),1===this.version?s.size=t.readUint32():s.size=t.readUint16(),s.priority=t.readUint8(),s.discardable=t.readUint8(),s.codec_specific_parameters=t.readUint32()}}}},Hr=class extends x{constructor(){super(...arguments),this.box_name="TAIClockInfoBox"}static{this.fourcc="taic"}parse(t){this.time_uncertainty=t.readUint64(),this.clock_resolution=t.readUint32(),this.clock_drift_rate=t.readInt32();const e=t.readUint8();this.clock_type=(192&e)>>6}},Mr=class extends x{constructor(){super(...arguments),this.box_name="TrackEncryptionBox"}static{this.fourcc="tenc"}parse(t){if(this.parseFullHeader(t),t.readUint8(),0===this.version)t.readUint8();else{const e=t.readUint8();this.default_crypt_byte_block=e>>4&15,this.default_skip_byte_block=15&e}this.default_isProtected=t.readUint8(),this.default_Per_Sample_IV_Size=t.readUint8(),this.default_KID=F(t),1===this.default_isProtected&&0===this.default_Per_Sample_IV_Size&&(this.default_constant_IV_size=t.readUint8(),this.default_constant_IV=t.readUint8Array(this.default_constant_IV_size))}},Or=class extends x{constructor(){super(...arguments),this.box_name="TrackFragmentRandomAccessBox"}static{this.fourcc="tfra"}parse(t){this.parseFullHeader(t),this.track_ID=t.readUint32(),t.readUint24();const e=t.readUint8();this.length_size_of_traf_num=e>>4&3,this.length_size_of_trun_num=e>>2&3,this.length_size_of_sample_num=3&e,this.entries=[];const s=t.readUint32();for(let e=0;e<s;e++)1===this.version?(this.time=t.readUint64(),this.moof_offset=t.readUint64()):(this.time=t.readUint32(),this.moof_offset=t.readUint32()),this.traf_number=t["readUint"+8*(this.length_size_of_traf_num+1)](),this.trun_number=t["readUint"+8*(this.length_size_of_trun_num+1)](),this.sample_number=t["readUint"+8*(this.length_size_of_sample_num+1)]()}},Nr=class extends g{constructor(){super(...arguments),this.box_name="hintmaxrelativetime"}static{this.fourcc="tmax"}parse(t){this.time=t.readUint32()}},Rr=class extends g{constructor(){super(...arguments),this.box_name="hintminrelativetime"}static{this.fourcc="tmin"}parse(t){this.time=t.readUint32()}},Vr=class extends g{constructor(){super(...arguments),this.box_name="hintBytesSent"}static{this.fourcc="totl"}parse(t){this.bytessent=t.readUint32()}},Gr=class extends g{constructor(){super(...arguments),this.box_name="hintBytesSent"}static{this.fourcc="tpay"}parse(t){this.bytessent=t.readUint32()}},jr=class extends g{constructor(){super(...arguments),this.box_name="hintBytesSent"}static{this.fourcc="tpyl"}parse(t){this.bytessent=t.readUint64()}},$r=class extends y{static{this.fourcc="msrc"}},qr=class t extends g{constructor(){super(...arguments),this.box_name="TrackReferenceBox",this.references=[]}static{this.fourcc="tref"}static{this.allowed_types=["hint","cdsc","font","hind","vdep","vplx","subt","thmb","auxl","cdtg","shsc","aest"]}parse(e){for(;e.getPosition()<this.start+this.size;){const s=D(e,!0,this.size-(e.getPosition()-this.start));if(1!==s.code)return;{t.allowed_types.includes(s.type)||m.warn("BoxParser",`Unknown track reference type: '${s.type}'`);const i=new S(s.type,s.size,s.hdr_size,s.start);i.write===g.prototype.write&&"mdat"!==i.type&&(m.info("BoxParser","TrackReference "+i.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),i.parseDataAndRewind(e)),i.parse(e),this.references.push(i)}}}},Yr=class extends x{constructor(){super(...arguments),this.box_name="TrackExtensionPropertiesBox"}static{this.fourcc="trep"}parse(t){for(this.parseFullHeader(t),this.track_ID=t.readUint32(),this.boxes=[];t.getPosition()<this.start+this.size;){const e=D(t,!1,this.size-(t.getPosition()-this.start));if(1!==e.code)return;{const t=e.box;this.boxes.push(t)}}}},Wr=class extends g{constructor(){super(...arguments),this.box_name="hintBytesSent"}static{this.fourcc="trpy"}parse(t){this.bytessent=t.readUint64()}},Kr=class extends x{constructor(){super(...arguments),this.box_name="TrackSelectionBox"}static{this.fourcc="tsel"}parse(t){this.parseFullHeader(t),this.switch_group=t.readUint32();const e=(this.size-this.hdr_size-4)/4;this.attribute_list=[];for(let s=0;s<e;s++)this.attribute_list[s]=t.readUint32()}},Jr=class extends x{constructor(){super(...arguments),this.box_name="TextConfigBox"}static{this.fourcc="txtc"}parse(t){this.parseFullHeader(t),this.config=t.readCString()}},Qr=class extends g{constructor(){super(...arguments),this.box_name="TypeCombinationBox"}static{this.fourcc="tyco"}parse(t){const e=(this.size-this.hdr_size)/4;this.compatible_brands=[];for(let s=0;s<e;s++)this.compatible_brands[s]=t.readString(4)}},Xr=class extends x{constructor(){super(...arguments),this.box_name="UserDescriptionProperty"}static{this.fourcc="udes"}parse(t){this.parseFullHeader(t),this.lang=t.readCString(),this.name=t.readCString(),this.description=t.readCString(),this.tags=t.readCString()}},Zr=class extends x{constructor(){super(...arguments),this.box_name="UncompressedFrameConfigBox"}static{this.fourcc="uncC"}parse(t){if(this.parseFullHeader(t),this.profile=t.readString(4),1===this.version);else if(0===this.version){this.component_count=t.readUint32(),this.component_index=[],this.component_bit_depth_minus_one=[],this.component_format=[],this.component_align_size=[];for(let e=0;e<this.component_count;e++)this.component_index.push(t.readUint16()),this.component_bit_depth_minus_one.push(t.readUint8()),this.component_format.push(t.readUint8()),this.component_align_size.push(t.readUint8());this.sampling_type=t.readUint8(),this.interleave_type=t.readUint8(),this.block_size=t.readUint8();const e=t.readUint8();this.component_little_endian=e>>7&1,this.block_pad_lsb=e>>6&1,this.block_little_endian=e>>5&1,this.block_reversed=e>>4&1,this.pad_unknown=e>>3&1,this.pixel_size=t.readUint32(),this.row_align_size=t.readUint32(),this.tile_align_size=t.readUint32(),this.num_tile_cols_minus_one=t.readUint32(),this.num_tile_rows_minus_one=t.readUint32()}}},ta=class extends x{constructor(){super(...arguments),this.box_name="DataEntryUrnBox"}static{this.fourcc="urn "}parse(t){this.parseFullHeader(t),this.name=t.readCString(),this.size-this.hdr_size-this.name.length-1>0&&(this.location=t.readCString())}write(t){this.version=0,this.flags=0,this.size=this.name.length+1+(this.location?this.location.length+1:0),this.writeHeader(t),t.writeCString(this.name),this.location&&t.writeCString(this.location)}},ea=class extends g{constructor(){super(...arguments),this.box_name="WebVTTConfigurationBox"}static{this.fourcc="vttC"}parse(t){this.text=t.readString(this.size-this.hdr_size)}},sa=class extends x{constructor(){super(...arguments),this.box_name="VvcNALUConfigBox"}static{this.fourcc="vvnC"}parse(t){this.parseFullHeader(t);const e=t.readUint8();this.lengthSizeMinusOne=3&e}},ia=class extends b{static{this.grouping_type="alst"}parse(t){const e=t.readUint16();this.first_output_sample=t.readUint16(),this.sample_offset=[];for(let s=0;s<e;s++)this.sample_offset[s]=t.readUint32();const s=this.description_length-4-4*e;this.num_output_samples=[],this.num_total_samples=[];for(let e=0;e<s/4;e++)this.num_output_samples[e]=t.readUint16(),this.num_total_samples[e]=t.readUint16()}},ra=class extends b{static{this.grouping_type="avll"}parse(t){this.layerNumber=t.readUint8(),this.accurateStatisticsFlag=t.readUint8(),this.avgBitRate=t.readUint16(),this.avgFrameRate=t.readUint16()}},aa=class extends b{static{this.grouping_type="avss"}parse(t){this.subSequenceIdentifier=t.readUint16(),this.layerNumber=t.readUint8();const e=t.readUint8();this.durationFlag=e>>7,this.avgRateFlag=e>>6&1,this.durationFlag&&(this.duration=t.readUint32()),this.avgRateFlag&&(this.accurateStatisticsFlag=t.readUint8(),this.avgBitRate=t.readUint16(),this.avgFrameRate=t.readUint16()),this.dependency=[];const s=t.readUint8();for(let e=0;e<s;e++)this.dependency.push({subSeqDirectionFlag:t.readUint8(),layerNumber:t.readUint8(),subSequenceIdentifier:t.readUint16()})}},na=class extends b{static{this.grouping_type="dtrt"}parse(t){m.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}},oa=class extends b{static{this.grouping_type="mvif"}parse(t){m.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}},ha=class extends b{static{this.grouping_type="prol"}parse(t){this.roll_distance=t.readInt16()}},da=class extends b{static{this.grouping_type="rap "}parse(t){const e=t.readUint8();this.num_leading_samples_known=e>>7,this.num_leading_samples=127&e}},ca=class extends b{static{this.grouping_type="rash"}parse(t){if(this.operation_point_count=t.readUint16(),this.description_length!==2+(1===this.operation_point_count?2:6*this.operation_point_count)+9)m.warn("BoxParser","Mismatch in "+this.grouping_type+" sample group length"),this.data=t.readUint8Array(this.description_length-2);else{if(1===this.operation_point_count)this.target_rate_share=t.readUint16();else{this.target_rate_share=[],this.available_bitrate=[];for(let e=0;e<this.operation_point_count;e++)this.available_bitrate[e]=t.readUint32(),this.target_rate_share[e]=t.readUint16()}this.maximum_bitrate=t.readUint32(),this.minimum_bitrate=t.readUint32(),this.discard_priority=t.readUint8()}}},la=class extends b{static{this.grouping_type="roll"}parse(t){this.roll_distance=t.readInt16()}},pa=class extends b{static{this.grouping_type="scif"}parse(t){m.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}},ua=class extends b{static{this.grouping_type="scnm"}parse(t){m.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}},fa=class extends b{static{this.grouping_type="seig"}parse(t){this.reserved=t.readUint8();const e=t.readUint8();this.crypt_byte_block=e>>4,this.skip_byte_block=15&e,this.isProtected=t.readUint8(),this.Per_Sample_IV_Size=t.readUint8(),this.KID=F(t),this.constant_IV_size=0,this.constant_IV=0,1===this.isProtected&&0===this.Per_Sample_IV_Size&&(this.constant_IV_size=t.readUint8(),this.constant_IV=t.readUint8Array(this.constant_IV_size))}},ma=class extends b{static{this.grouping_type="stsa"}parse(t){m.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}},_a=class extends b{static{this.grouping_type="sync"}parse(t){const e=t.readUint8();this.NAL_unit_type=63&e}},ga=class extends b{static{this.grouping_type="tele"}parse(t){const e=t.readUint8();this.level_independently_decodable=e>>7}},xa=class extends b{static{this.grouping_type="tsas"}parse(t){m.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}},ba=class extends b{static{this.grouping_type="tscl"}parse(t){m.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}},ya=class extends b{static{this.grouping_type="vipr"}parse(t){m.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}},Ua=class extends g{static{this.fourcc="uuid"}},wa=class extends x{static{this.fourcc="uuid"}},Sa=class extends wa{constructor(){super(...arguments),this.box_name="LiveServerManifestBox"}static{this.uuid="a5d40b30e81411ddba2f0800200c9a66"}parse(t){this.parseFullHeader(t),this.LiveServerManifest=t.readString(this.size-this.hdr_size).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}},va=class extends wa{constructor(){super(...arguments),this.box_name="PiffProtectionSystemSpecificHeaderBox"}static{this.uuid="d08a4f1810f34a82b6c832d8aba183d3"}parse(t){this.parseFullHeader(t),this.system_id=F(t);const e=t.readUint32();e>0&&(this.data=t.readUint8Array(e))}},Ba=class extends wa{constructor(){super(...arguments),this.box_name="PiffSampleEncryptionBox"}static{this.uuid="a2394f525a9b4f14a2446c427c648df4"}},za=class extends wa{constructor(){super(...arguments),this.box_name="PiffTrackEncryptionBox"}static{this.uuid="8974dbce7be74c5184f97148f9882554"}parse(t){this.parseFullHeader(t),this.default_AlgorithmID=t.readUint24(),this.default_IV_size=t.readUint8(),this.default_KID=F(t)}},ka=class extends wa{constructor(){super(...arguments),this.box_name="TfrfBox"}static{this.uuid="d4807ef2ca3946958e5426cb9e46a79f"}parse(t){this.parseFullHeader(t),this.fragment_count=t.readUint8(),this.entries=[];for(let e=0;e<this.fragment_count;e++){let e=0,s=0;1===this.version?(e=t.readUint64(),s=t.readUint64()):(e=t.readUint32(),s=t.readUint32()),this.entries.push({absolute_time:e,absolute_duration:s})}}},Ia=class extends wa{constructor(){super(...arguments),this.box_name="TfxdBox"}static{this.uuid="6d1d9b0542d544e680e2141daff757b2"}parse(t){this.parseFullHeader(t),1===this.version?(this.absolute_time=t.readUint64(),this.duration=t.readUint64()):(this.absolute_time=t.readUint32(),this.duration=t.readUint32())}},Ea=class extends Ua{constructor(){super(...arguments),this.box_name="ItemContentIDProperty"}static{this.uuid="261ef3741d975bbaacbd9d2c8ea73522"}parse(t){this.content_id=t.readCString()}},Pa=function(t){const e={uuid:{},sampleEntry:{},sampleGroupEntry:{},box:{}};for(const[s,i]of Object.entries(t))if(E(i)){const t="grouping_type"in i?i.grouping_type:void 0;if(!t)throw new Error(`SampleGroupEntry class ${s} does not have a valid static grouping_type. Please ensure it is defined correctly.`);if(t in e.sampleGroupEntry)throw new Error(`SampleGroupEntry class ${s} has a grouping_type that is already registered. Please ensure it is unique.`);e.sampleGroupEntry[t]=i}else if(P(i)){const t="fourcc"in i?i.fourcc:void 0;if(!t)throw new Error(`SampleEntry class ${s} does not have a valid static fourcc. Please ensure it is defined correctly.`);if(t in e.sampleEntry)throw new Error(`SampleEntry class ${s} has a fourcc that is already registered. Please ensure it is unique.`);e.sampleEntry[t]=i}else{if(!A(i))throw new Error(`Box class ${s} does not have a valid static fourcc, uuid, or grouping_type. Please ensure it is defined correctly.`);{const t="fourcc"in i?i.fourcc:void 0,r="uuid"in i?i.uuid:void 0;if("uuid"===t){if(!r)throw new Error(`Box class ${s} has a fourcc of 'uuid' but does not have a valid uuid. Please ensure it is defined correctly.`);if(r in e.uuid)throw new Error(`Box class ${s} has a uuid that is already registered. Please ensure it is unique.`);e.uuid[r]=i;continue}e.box[t]=i}}return C.uuid={...e.uuid},C.sampleEntry={...e.sampleEntry},C.sampleGroupEntry={...e.sampleGroupEntry},C.box={...e.box},C}(Hs);cr=Ss,Object.entries(cr).forEach((([t,e])=>T[t]=e));export{G as AudioSampleEntry,g as Box,Pa as BoxParser,v as DIFF_BOXES_PROP_NAMES,B as DIFF_PRIMITIVE_ARRAY_PROP_NAMES,l as DataStream,Is as Descriptor,Es as ES_Descriptor,c as Endianness,x as FullBox,M as HintSampleEntry,Us as ISOFile,m as Log,d as MP4BoxBuffer,Cs as MPEG4DescriptorParser,O as MetadataSampleEntry,_ as MultiBufferStream,H as SampleEntry,b as SampleGroupEntry,ys as SampleGroupInfo,U as SingleItemTypeReferenceBox,w as SingleItemTypeReferenceBoxLarge,N as SubtitleSampleEntry,j as SystemSampleEntry,Ls as TX3GParser,R as TextSampleEntry,Ds as Textin4Parser,y as TrackGroupTypeBox,S as TrackReferenceTypeBox,Ts as VTTin4Parser,V as VisualSampleEntry,Fs as XMLSubtitlein4Parser,k as boxEqual,z as boxEqualFields,ws as createFile};export default null;
//# sourceMappingURL=/sm/61708eba52e91c3f39388f1889aa5c14b8114915e4db1e4cb4db697ff5e47e4d.map